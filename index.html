<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WAVE ‚Äî –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0f;--surface:#111118;--surface2:#18181f;--border:#252530;--accent:#7c3aed;--accent2:#a855f7;--glow:rgba(124,58,237,.35);--text:#e8e8f0;--muted:#6b6b80;--online:#22d3ee;--danger:#f87171;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;height:100dvh;display:flex;flex-direction:column;overflow:hidden;}

/* AUTH */
#auth-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100dvh;background:radial-gradient(ellipse 80% 60% at 50% -10%,rgba(124,58,237,.25),transparent);}
.auth-logo{font-size:3.5rem;font-weight:800;letter-spacing:-2px;background:linear-gradient(135deg,#a855f7,#38bdf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;}
.auth-sub{color:var(--muted);font-family:'Space Mono',monospace;font-size:.72rem;letter-spacing:3px;margin-bottom:40px;text-transform:uppercase;}
.auth-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px 36px;width:340px;display:flex;flex-direction:column;gap:14px;box-shadow:0 0 60px rgba(0,0,0,.5);}
.auth-box h2{font-size:1.1rem;font-weight:700;}
.auth-input{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px 16px;color:var(--text);font-family:'Space Mono',monospace;font-size:.83rem;width:100%;outline:none;transition:border-color .2s;}
.auth-input:focus{border-color:var(--accent2);}
.auth-btn{background:linear-gradient(135deg,var(--accent),#9333ea);border:none;border-radius:10px;padding:13px;color:#fff;font-family:'Syne',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;transition:opacity .2s,transform .1s;}
.auth-btn:hover{opacity:.9;}.auth-btn:active{transform:scale(.98);}.auth-btn:disabled{opacity:.5;cursor:not-allowed;}
.auth-switch{text-align:center;font-size:.8rem;color:var(--muted);}
.auth-switch a{color:var(--accent2);cursor:pointer;}
.auth-error{color:var(--danger);font-family:'Space Mono',monospace;font-size:.73rem;min-height:16px;}

/* APP */
#app-screen{display:none;flex-direction:row;height:100dvh;overflow:hidden;}
#app-screen.visible{display:flex;}

/* SIDEBAR */
#sidebar{width:280px;min-width:280px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.sidebar-header{padding:14px 14px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
.sidebar-logo{font-size:1.3rem;font-weight:800;letter-spacing:-1px;background:linear-gradient(135deg,#a855f7,#38bdf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;flex:1;}
.my-av-btn{width:34px;height:34px;border-radius:10px;cursor:pointer;border:2px solid var(--border);transition:border-color .2s;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;color:#fff;}
.my-av-btn:hover{border-color:var(--accent2);}
.my-av-btn img{width:100%;height:100%;object-fit:cover;}
.logout-btn{background:none;border:1px solid var(--border);border-radius:7px;color:var(--muted);padding:4px 9px;font-family:'Space Mono',monospace;font-size:.62rem;cursor:pointer;transition:border-color .2s,color .2s;white-space:nowrap;}
.logout-btn:hover{border-color:var(--danger);color:var(--danger);}

.sidebar-tabs{display:flex;border-bottom:1px solid var(--border);}
.s-tab{flex:1;padding:10px;font-size:.75rem;font-weight:600;text-align:center;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:color .2s,border-color .2s;}
.s-tab.active{color:var(--accent2);border-bottom-color:var(--accent2);}

.sidebar-search{padding:10px 12px;border-bottom:1px solid var(--border);}
.search-wrap{position:relative;display:flex;align-items:center;}
.search-icon{position:absolute;left:10px;color:var(--muted);font-size:.85rem;pointer-events:none;}
.search-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:8px 10px 8px 30px;color:var(--text);font-family:'Space Mono',monospace;font-size:.76rem;outline:none;transition:border-color .2s;}
.search-input:focus{border-color:var(--accent2);}

.new-chat-btn{margin:10px 12px;background:none;border:1px dashed var(--border);border-radius:10px;padding:9px;color:var(--muted);font-family:'Syne',sans-serif;font-size:.8rem;cursor:pointer;display:flex;align-items:center;gap:8px;transition:border-color .2s,color .2s;}
.new-chat-btn:hover{border-color:var(--accent2);color:var(--accent2);}
.section-label{padding:6px 14px 3px;font-size:.62rem;font-family:'Space Mono',monospace;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;}

#chat-list,#user-search-results{flex:1;overflow-y:auto;padding:2px 0;}
#chat-list::-webkit-scrollbar,#user-search-results::-webkit-scrollbar{width:3px;}
#chat-list::-webkit-scrollbar-thumb,#user-search-results::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

.chat-item{display:flex;align-items:center;gap:11px;padding:10px 14px;cursor:pointer;border-left:2px solid transparent;transition:background .15s,border-color .15s;}
.chat-item:hover{background:var(--surface2);}
.chat-item.active{background:var(--surface2);border-left-color:var(--accent2);}
.av{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1rem;flex-shrink:0;position:relative;overflow:hidden;}
.av img{width:100%;height:100%;object-fit:cover;}
.av.round{border-radius:50%;}
.chat-info{flex:1;min-width:0;}
.chat-name{font-size:.87rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.chat-preview{font-size:.72rem;color:var(--muted);font-family:'Space Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;}
.chat-meta{display:flex;flex-direction:column;align-items:flex-end;gap:3px;}
.chat-time{font-size:.63rem;color:var(--muted);font-family:'Space Mono',monospace;}

.user-item{display:flex;align-items:center;gap:11px;padding:10px 14px;cursor:pointer;transition:background .15s;}
.user-item:hover{background:var(--surface2);}
.user-item-info{flex:1;min-width:0;}
.user-item-name{font-size:.87rem;font-weight:600;}
.user-item-nick{font-size:.72rem;color:var(--muted);font-family:'Space Mono',monospace;}
.user-item-btn{background:var(--accent);border:none;border-radius:7px;padding:5px 12px;color:#fff;font-family:'Syne',sans-serif;font-size:.75rem;font-weight:700;cursor:pointer;transition:opacity .2s;white-space:nowrap;}
.user-item-btn:hover{opacity:.85;}

/* CHAT AREA */
#chat-area{flex:1;display:flex;flex-direction:column;min-width:0;background:var(--bg);background-image:radial-gradient(ellipse 50% 40% at 80% 10%,rgba(124,58,237,.07),transparent);}
.chat-topbar{padding:13px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;background:var(--surface);}
.chat-topbar-name{font-size:.97rem;font-weight:700;}
.chat-topbar-status{font-size:.7rem;color:var(--online);font-family:'Space Mono',monospace;}
.topbar-actions{margin-left:auto;display:flex;gap:7px;}
.icon-btn{background:none;border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--muted);cursor:pointer;font-size:.88rem;transition:border-color .2s,color .2s;}
.icon-btn:hover{border-color:var(--accent2);color:var(--accent2);}
.back-btn{display:none;background:none;border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--muted);cursor:pointer;font-size:.82rem;}

#messages{flex:1;overflow-y:auto;padding:20px 20px 6px;display:flex;flex-direction:column;gap:4px;}
#messages::-webkit-scrollbar{width:3px;}
#messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.msg-group{display:flex;flex-direction:column;gap:2px;margin-bottom:8px;}
.msg-group.sent{align-items:flex-end;}
.msg-group.recv{align-items:flex-start;}
.msg-sender{font-size:.68rem;font-family:'Space Mono',monospace;color:var(--accent2);margin-bottom:2px;padding:0 4px;cursor:pointer;}
.msg-sender:hover{text-decoration:underline;}
.msg-bubble{max-width:68%;padding:9px 14px;border-radius:16px;font-size:.87rem;line-height:1.5;word-break:break-word;animation:popIn .16s ease;}
@keyframes popIn{from{opacity:0;transform:scale(.92) translateY(5px);}to{opacity:1;transform:scale(1) translateY(0);}}
.msg-group.sent .msg-bubble{background:linear-gradient(135deg,var(--accent),#9333ea);color:#fff;border-bottom-right-radius:4px;}
.msg-group.recv .msg-bubble{background:var(--surface2);border:1px solid var(--border);color:var(--text);border-bottom-left-radius:4px;}
.msg-time{font-size:.6rem;font-family:'Space Mono',monospace;color:rgba(255,255,255,.4);margin-top:2px;}
.msg-group.recv .msg-time{color:var(--muted);}
.date-divider{display:flex;align-items:center;gap:10px;margin:10px 0;}
.date-divider::before,.date-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.date-divider span{font-size:.63rem;font-family:'Space Mono',monospace;color:var(--muted);white-space:nowrap;}

.input-area{padding:14px 20px;border-top:1px solid var(--border);display:flex;gap:10px;align-items:flex-end;background:var(--surface);}
.msg-input-wrap{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:12px;display:flex;align-items:flex-end;gap:7px;padding:9px 13px;transition:border-color .2s;}
.msg-input-wrap:focus-within{border-color:var(--accent2);}
.msg-input{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'Syne',sans-serif;font-size:.87rem;resize:none;max-height:110px;line-height:1.5;}
.emoji-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.05rem;padding:0;transition:color .2s;}
.emoji-btn:hover{color:var(--accent2);}
.send-btn{background:linear-gradient(135deg,var(--accent),#9333ea);border:none;border-radius:12px;width:44px;height:44px;color:#fff;font-size:1.05rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:opacity .2s,transform .1s;box-shadow:0 4px 18px var(--glow);}
.send-btn:hover{opacity:.9;}.send-btn:active{transform:scale(.92);}

.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;color:var(--muted);}
.empty-icon{font-size:2.8rem;opacity:.3;}
.empty-state h3{font-size:.97rem;font-weight:600;color:var(--muted);}
.empty-state p{font-size:.77rem;font-family:'Space Mono',monospace;}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(5px);display:flex;align-items:center;justify-content:center;z-index:100;opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:26px 30px;width:380px;display:flex;flex-direction:column;gap:13px;transform:scale(.94);transition:transform .2s;max-height:90dvh;overflow-y:auto;}
.modal-overlay.open .modal{transform:scale(1);}
.modal h3{font-size:1rem;font-weight:700;}
.modal-actions{display:flex;gap:9px;margin-top:4px;}
.modal-cancel{flex:1;background:none;border:1px solid var(--border);border-radius:9px;padding:10px;color:var(--muted);font-family:'Syne',sans-serif;font-size:.83rem;cursor:pointer;transition:border-color .2s;}
.modal-cancel:hover{border-color:var(--muted);}
.modal-ok{flex:1;background:linear-gradient(135deg,var(--accent),#9333ea);border:none;border-radius:9px;padding:10px;color:#fff;font-family:'Syne',sans-serif;font-size:.83rem;font-weight:700;cursor:pointer;transition:opacity .2s;}
.modal-ok:hover{opacity:.9;}

.profile-av-wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:6px 0;}
.profile-av{width:88px;height:88px;border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:2.2rem;font-weight:700;cursor:pointer;position:relative;overflow:hidden;border:2px solid var(--border);transition:border-color .2s;}
.profile-av:hover{border-color:var(--accent2);}
.profile-av img{width:100%;height:100%;object-fit:cover;}
.profile-av-overlay{position:absolute;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s;font-size:.72rem;color:#fff;font-family:'Space Mono',monospace;text-align:center;}
.profile-av:hover .profile-av-overlay{opacity:1;}
.profile-name-big{font-size:1.1rem;font-weight:700;text-align:center;}
.profile-nick{font-size:.78rem;color:var(--muted);font-family:'Space Mono',monospace;text-align:center;}

.invite-link-wrap{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:8px;}
.invite-link-text{flex:1;font-family:'Space Mono',monospace;font-size:.7rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.copy-btn{background:var(--accent);border:none;border-radius:7px;padding:5px 10px;color:#fff;font-family:'Space Mono',monospace;font-size:.65rem;cursor:pointer;white-space:nowrap;transition:opacity .2s;}
.copy-btn:hover{opacity:.85;}

.av-color-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;}
.av-color{width:100%;aspect-ratio:1;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:border-color .2s,transform .1s;}
.av-color:hover,.av-color.sel{border-color:#fff;transform:scale(1.08);}
.av-emoji-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;}
.av-emoji{width:100%;aspect-ratio:1;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2rem;background:var(--surface2);border:2px solid transparent;transition:border-color .2s,transform .1s;}
.av-emoji:hover,.av-emoji.sel{border-color:var(--accent2);transform:scale(1.08);}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 18px;font-size:.82rem;font-family:'Space Mono',monospace;opacity:0;transition:opacity .25s,transform .25s;z-index:999;pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

@media(max-width:640px){
  #sidebar{width:100%;min-width:unset;}
  #sidebar.hidden{display:none;}
  #chat-area{display:none;}
  #chat-area.visible{display:flex;}
  .back-btn{display:flex!important;}
}
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth-screen">
  <div class="auth-logo">WAVE</div>
  <div class="auth-sub">messenger ¬∑ v2.0</div>
  <div class="auth-box" id="login-box">
    <h2>–í–æ–π—Ç–∏</h2>
    <input class="auth-input" id="login-id" type="text" placeholder="Email –∏–ª–∏ @username">
    <input class="auth-input" id="login-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <div class="auth-error" id="login-error"></div>
    <button class="auth-btn" id="login-btn" onclick="doLogin()">–í–æ–π—Ç–∏ ‚Üí</button>
    <div class="auth-switch">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="toggleAuth(true)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></div>
  </div>
  <div class="auth-box" id="reg-box" style="display:none">
    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input class="auth-input" id="reg-name" type="text" placeholder="–ò–º—è (–æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ)" maxlength="30">
    <input class="auth-input" id="reg-nick" type="text" placeholder="@username (–±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _)" maxlength="20">
    <input class="auth-input" id="reg-email" type="email" placeholder="Email">
    <input class="auth-input" id="reg-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)">
    <div class="auth-error" id="reg-error"></div>
    <button class="auth-btn" id="reg-btn" onclick="doRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí</button>
    <div class="auth-switch">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="toggleAuth(false)">–í–æ–π—Ç–∏</a></div>
  </div>
</div>

<!-- APP -->
<div id="app-screen">
  <div id="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-logo">WAVE</span>
      <div class="my-av-btn" id="my-av-btn" onclick="openMyProfile()" title="–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å"></div>
      <button class="logout-btn" onclick="doLogout()">–≤—ã–π—Ç–∏</button>
    </div>
    <div class="sidebar-tabs">
      <div class="s-tab active" id="tab-chats" onclick="switchTab('chats')">–ß–∞—Ç—ã</div>
      <div class="s-tab" id="tab-search" onclick="switchTab('search')">üîç –ü–æ–∏—Å–∫</div>
    </div>
    <!-- Chats -->
    <div id="pane-chats" style="display:flex;flex-direction:column;flex:1;overflow:hidden;">
      <div class="sidebar-search">
        <div class="search-wrap">
          <span class="search-icon">‚åï</span>
          <input class="search-input" id="chat-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç–∞–º..." oninput="filterChats(this.value)">
        </div>
      </div>
      <button class="new-chat-btn" onclick="openNewChatModal()">Ôºã –ù–æ–≤—ã–π —á–∞—Ç</button>
      <div class="section-label">–î–∏–∞–ª–æ–≥–∏</div>
      <div id="chat-list"></div>
    </div>
    <!-- Search -->
    <div id="pane-search" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
      <div class="sidebar-search">
        <div class="search-wrap">
          <span class="search-icon">‚åï</span>
          <input class="search-input" id="user-search-input" placeholder="@username –∏–ª–∏ –∏–º—è..." oninput="searchUsers(this.value)">
        </div>
      </div>
      <div class="section-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
      <div id="user-search-results">
        <div style="padding:16px;font-size:.76rem;color:var(--muted);font-family:'Space Mono',monospace;">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ @–Ω–∏–∫</div>
      </div>
    </div>
  </div>

  <div id="chat-area">
    <div id="empty-placeholder" class="empty-state">
      <div class="empty-icon">üí¨</div>
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
      <p>–∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ü–æ–∏—Å–∫–µ</p>
    </div>
    <div id="active-chat" style="display:none;flex-direction:column;height:100%;overflow:hidden;">
      <div class="chat-topbar">
        <button class="back-btn" onclick="goBack()">‚Üê</button>
        <div class="av" id="topbar-av" style="cursor:pointer" onclick="openChatProfile()"></div>
        <div style="cursor:pointer" onclick="openChatProfile()">
          <div class="chat-topbar-name" id="topbar-name"></div>
          <div class="chat-topbar-status" id="topbar-status"></div>
        </div>
        <div class="topbar-actions">
          <button class="icon-btn" onclick="shareInvite()" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π">üîó</button>
          <button class="icon-btn" onclick="showMembers()" title="–£—á–∞—Å—Ç–Ω–∏–∫–∏">üë•</button>
        </div>
      </div>
      <div id="messages"></div>
      <div class="input-area">
        <div class="msg-input-wrap">
          <textarea class="msg-input" id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"
            onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
          <button class="emoji-btn" onclick="insertEmoji()">‚ò∫</button>
        </div>
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>
</div>

<!-- New Chat Modal -->
<div class="modal-overlay" id="new-chat-modal">
  <div class="modal">
    <h3>–ù–æ–≤—ã–π —á–∞—Ç</h3>
    <p style="font-size:.78rem;color:var(--muted);font-family:'Space Mono',monospace;">–í–≤–µ–¥–∏—Ç–µ @username, email –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</p>
    <input class="auth-input" id="new-chat-input" placeholder="@username / email / –Ω–∞–∑–≤–∞–Ω–∏–µ">
    <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;color:var(--muted);cursor:pointer;">
      <input type="checkbox" id="is-group" style="accent-color:var(--accent);"> –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç
    </label>
    <div class="auth-error" id="new-chat-err"></div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('new-chat-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-ok" onclick="createChat()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- My Profile Modal -->
<div class="modal-overlay" id="my-profile-modal">
  <div class="modal">
    <h3>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h3>
    <div class="profile-av-wrap">
      <div class="profile-av" id="my-profile-av" onclick="openAvatarPicker()">
        <div class="profile-av-overlay">–∏–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</div>
      </div>
      <div>
        <div class="profile-name-big" id="my-profile-name"></div>
        <div class="profile-nick" id="my-profile-nick"></div>
      </div>
    </div>
    <input class="auth-input" id="my-profile-name-input" placeholder="–ù–æ–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è">
    <div style="font-size:.78rem;color:var(--muted);">–°—Å—ã–ª–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:</div>
    <div class="invite-link-wrap">
      <span class="invite-link-text" id="my-invite-link"></span>
      <button class="copy-btn" onclick="copyMyLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('my-profile-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="modal-ok" onclick="saveProfileName()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è</button>
    </div>
  </div>
</div>

<!-- Avatar Picker Modal -->
<div class="modal-overlay" id="avatar-modal">
  <div class="modal">
    <h3>–í—ã–±–µ—Ä–∏ –∞–≤–∞—Ç–∞—Ä</h3>
    <div style="font-size:.75rem;color:var(--muted);">–¶–≤–µ—Ç —Ñ–æ–Ω–∞</div>
    <div class="av-color-grid" id="av-color-grid"></div>
    <div style="font-size:.75rem;color:var(--muted);margin-top:4px;">–≠–º–æ–¥–∑–∏</div>
    <div class="av-emoji-grid" id="av-emoji-grid"></div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('avatar-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-ok" onclick="saveAvatar()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- User Profile Modal -->
<div class="modal-overlay" id="user-profile-modal">
  <div class="modal">
    <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
    <div class="profile-av-wrap">
      <div class="profile-av" id="upm-av" style="cursor:default;pointer-events:none;"></div>
      <div>
        <div class="profile-name-big" id="upm-name"></div>
        <div class="profile-nick" id="upm-nick"></div>
      </div>
    </div>
    <div class="invite-link-wrap" id="upm-link-wrap" style="display:none;">
      <span class="invite-link-text" id="upm-link"></span>
      <button class="copy-btn" onclick="copyUpmLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('user-profile-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="modal-ok" id="upm-msg-btn">–ù–∞–ø–∏—Å–∞—Ç—å</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signOut, onAuthStateChanged, updateProfile, setPersistence, browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import {
  getDatabase, ref, set, get, push, onValue, off, update,
  query, orderByChild, limitToLast, equalTo
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDaMGT4kvbS5_sKhPQm7u5g30baMaPxYvw",
  authDomain: "wawe-23d7c.firebaseapp.com",
  databaseURL: "https://wawe-23d7c-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "wawe-23d7c",
  storageBucket: "wawe-23d7c.firebasestorage.app",
  messagingSenderId: "843038206524",
  appId: "1:843038206524:web:bbcbdd32fa7ca8890ef139"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
setPersistence(auth, browserLocalPersistence).catch(console.error);

const COLORS = ['#7c3aed','#059669','#db2777','#0891b2','#d97706','#6366f1','#ef4444','#f97316','#14b8a6','#8b5cf6','#ec4899','#22c55e'];
const EMOJIS = ['üòä','üî•','üíú','üëæ','üöÄ','üéØ','üåä','‚ö°','üé∏','ü¶ä','üê∫','üåô','üíé','üéÆ','ü¶ã','ü§ñ','üêâ','üå∫','üëë','üé≤','ü¶Ö','üåà'];

let CU = null, CUdata = null;
let currentChatId = null, chatsData = {}, msgListener = null, chatsListener = null;
let pickerColor = COLORS[0], pickerEmoji = EMOJIS[0];

// ‚îÄ helpers ‚îÄ
const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const setErr = (id, msg) => { const e=document.getElementById(id); if(e) e.textContent=msg; };
const setBtn = (id, load, label) => { const b=document.getElementById(id); if(!b) return; b.disabled=load; b.textContent=load?'‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...':label; };
const toast = msg => { const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); };
const fmt = ts => new Date(ts).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
const fmtDate = ts => new Date(ts).toLocaleDateString('ru-RU',{day:'numeric',month:'long'});
const strColor = str => { let h=0; for(let c of str) h=c.charCodeAt(0)+((h<<5)-h); return COLORS[Math.abs(h)%COLORS.length]; };

function avHTML(av, name, size=42, cls=''){
  const color = av?.color || strColor(name||'?');
  const letter = (name||'?')[0].toUpperCase();
  const emoji = av?.emoji;
  const fs = Math.round(size * (emoji ? 0.45 : 0.38));
  return `<div class="av ${cls}" style="width:${size}px;height:${size}px;min-width:${size}px;background:${color};font-size:${fs}px;font-weight:700;color:#fff;">${emoji||letter}</div>`;
}

function renderAvInEl(el, av, name, size=42){
  const color = av?.color || strColor(name||'?');
  const emoji = av?.emoji;
  const letter = (name||'?')[0].toUpperCase();
  el.style.width = size+'px';
  el.style.height = size+'px';
  el.style.minWidth = size+'px';
  el.style.background = color;
  el.style.color = '#fff';
  el.style.fontSize = Math.round(size*(emoji?0.45:0.38))+'px';
  el.style.fontWeight = '700';
  el.textContent = emoji || letter;
}

function updateMyAvBtn(){
  const btn = document.getElementById('my-av-btn');
  if(!btn||!CUdata) return;
  const av = CUdata.avatar;
  const name = CUdata.name||'?';
  btn.style.background = av?.color || strColor(name);
  btn.style.fontSize = av?.emoji ? '1rem' : '.85rem';
  btn.textContent = av?.emoji || name[0].toUpperCase();
}

// ‚îÄ auth ‚îÄ
window.toggleAuth = showReg => {
  document.getElementById('login-box').style.display = showReg?'none':'flex';
  document.getElementById('reg-box').style.display = showReg?'flex':'none';
  setErr('login-error',''); setErr('reg-error','');
};

window.doRegister = async () => {
  const name  = document.getElementById('reg-name').value.trim();
  const nick  = document.getElementById('reg-nick').value.trim().replace(/^@/,'');
  const email = document.getElementById('reg-email').value.trim();
  const pass  = document.getElementById('reg-pass').value;
  setErr('reg-error','');
  if(!name)          { setErr('reg-error','‚úó –í–≤–µ–¥–∏—Ç–µ –∏–º—è'); return; }
  if(!nick)          { setErr('reg-error','‚úó –í–≤–µ–¥–∏—Ç–µ @username'); return; }
  if(nick.length<3)  { setErr('reg-error','‚úó Username –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞'); return; }
  if(!/^[a-zA-Z0-9_]+$/.test(nick)) { setErr('reg-error','‚úó –¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _'); return; }
  if(!email)         { setErr('reg-error','‚úó –í–≤–µ–¥–∏—Ç–µ email'); return; }
  if(pass.length<6)  { setErr('reg-error','‚úó –ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'); return; }
  setBtn('reg-btn',true,'–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí');
  try {
    const ns = await get(query(ref(db,'users'), orderByChild('nickLower'), equalTo(nick.toLowerCase())));
    if(ns.exists()){ setErr('reg-error','‚úó @'+nick+' —É–∂–µ –∑–∞–Ω—è—Ç'); setBtn('reg-btn',false,'–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí'); return; }
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await updateProfile(cred.user,{displayName:name});
    const av = {color:COLORS[Math.floor(Math.random()*COLORS.length)], emoji:EMOJIS[Math.floor(Math.random()*EMOJIS.length)]};
    await set(ref(db,`users/${cred.user.uid}`),{uid:cred.user.uid,name,nick,nickLower:nick.toLowerCase(),email,createdAt:Date.now(),avatar:av});
  } catch(e){ console.error(e); setErr('reg-error','‚úó '+xlate(e.code)); setBtn('reg-btn',false,'–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí'); }
};

window.doLogin = async () => {
  const login = document.getElementById('login-id').value.trim().replace(/^@/,'');
  const pass  = document.getElementById('login-pass').value;
  setErr('login-error','');
  if(!login){ setErr('login-error','‚úó –í–≤–µ–¥–∏—Ç–µ email –∏–ª–∏ @username'); return; }
  if(!pass) { setErr('login-error','‚úó –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'); return; }
  setBtn('login-btn',true,'–í–æ–π—Ç–∏ ‚Üí');
  try {
    let email = login;
    if(!login.includes('@') || /\s/.test(login)){
      const snap = await get(query(ref(db,'users'), orderByChild('nickLower'), equalTo(login.toLowerCase())));
      if(!snap.exists()){ setErr('login-error','‚úó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); setBtn('login-btn',false,'–í–æ–π—Ç–∏ ‚Üí'); return; }
      snap.forEach(c=>{ email=c.val().email; });
    }
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(e){ console.error(e); setErr('login-error','‚úó '+xlate(e.code)); setBtn('login-btn',false,'–í–æ–π—Ç–∏ ‚Üí'); }
};

window.doLogout = async () => {
  if(msgListener&&currentChatId) off(ref(db,`chats/${currentChatId}/messages`));
  if(chatsListener) off(ref(db,`userChats/${CU?.uid}`));
  currentChatId=null; chatsData={}; CUdata=null;
  await signOut(auth);
};

onAuthStateChanged(auth, async user => {
  if(user){
    CU = user;
    const snap = await get(ref(db,`users/${user.uid}`));
    CUdata = snap.exists() ? snap.val() : {name:user.displayName||'?',nick:'',avatar:null};
    document.getElementById('auth-screen').style.display='none';
    document.getElementById('app-screen').classList.add('visible');
    setBtn('login-btn',false,'–í–æ–π—Ç–∏ ‚Üí'); setBtn('reg-btn',false,'–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí');
    updateMyAvBtn();
    checkInviteParam();
    loadChats();
  } else {
    CU=null; CUdata=null;
    document.getElementById('auth-screen').style.display='flex';
    document.getElementById('app-screen').classList.remove('visible');
    document.getElementById('chat-list').innerHTML='';
    document.getElementById('messages').innerHTML='';
    showEmpty();
  }
});

// ‚îÄ tabs ‚îÄ
window.switchTab = tab => {
  document.getElementById('tab-chats').classList.toggle('active',tab==='chats');
  document.getElementById('tab-search').classList.toggle('active',tab==='search');
  document.getElementById('pane-chats').style.display = tab==='chats'?'flex':'none';
  document.getElementById('pane-search').style.display = tab==='search'?'flex':'none';
  if(tab==='search') document.getElementById('user-search-input').focus();
};

// ‚îÄ user search ‚îÄ
let searchTimer=null;
window.searchUsers = val => {
  clearTimeout(searchTimer);
  const q = val.trim().replace(/^@/,'');
  const res = document.getElementById('user-search-results');
  if(!q){ res.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--muted);font-family:\'Space Mono\',monospace;">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ @–Ω–∏–∫</div>'; return; }
  res.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--muted);font-family:\'Space Mono\',monospace;">–ò—â—É...</div>';
  searchTimer = setTimeout(async()=>{
    try{
      const snap = await get(ref(db,'users'));
      const ql = q.toLowerCase();
      const found=[];
      snap.forEach(c=>{ const u=c.val(); if(u.uid!==CU?.uid&&(u.nickLower?.includes(ql)||u.name?.toLowerCase().includes(ql))) found.push(u); });
      res.innerHTML='';
      if(!found.length){ res.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--muted);font-family:\'Space Mono\',monospace;">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
      found.forEach(u=>{
        const div=document.createElement('div');
        div.className='user-item';
        div.innerHTML=`${avHTML(u.avatar,u.name,40)}<div class="user-item-info"><div class="user-item-name">${esc(u.name)}</div><div class="user-item-nick">@${esc(u.nick||u.nickLower||'')}</div></div><button class="user-item-btn">–ü—Ä–æ—Ñ–∏–ª—å</button>`;
        div.querySelector('button').onclick=()=>showUserModal(u);
        res.appendChild(div);
      });
    } catch(e){ console.error(e); res.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--danger);">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>'; }
  },400);
};

// ‚îÄ chats ‚îÄ
function loadChats(){
  chatsListener = onValue(ref(db,`userChats/${CU.uid}`), async snap=>{
    const ids = Object.keys(snap.val()||{});
    if(!ids.length){ renderChatList({}); return; }
    const results = await Promise.all(ids.map(id=>get(ref(db,`chats/${id}`))));
    chatsData={};
    results.forEach(r=>{ if(r.exists()) chatsData[r.key]=r.val(); });
    ids.forEach(id=>{
      onValue(query(ref(db,`chats/${id}/messages`),orderByChild('ts'),limitToLast(1)), s=>{
        const v=s.val();
        if(v&&chatsData[id]) chatsData[id].lastMsg=Object.values(v)[0];
        renderChatList(chatsData);
      });
    });
  });
}

function renderChatList(data){
  const list=document.getElementById('chat-list');
  const q=(document.getElementById('chat-search').value||'').toLowerCase();
  const sorted=Object.entries(data)
    .filter(([,c])=>chatName(c).toLowerCase().includes(q))
    .sort(([,a],[,b])=>(b.lastMsg?.ts||b.createdAt||0)-(a.lastMsg?.ts||a.createdAt||0));
  list.innerHTML='';
  if(!sorted.length){ list.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--muted);font-family:\'Space Mono\',monospace">–ù–µ—Ç —á–∞—Ç–æ–≤</div>'; return; }
  sorted.forEach(([id,c])=>{
    const name=chatName(c);
    const av=chatAv(c);
    const item=document.createElement('div');
    item.className='chat-item'+(id===currentChatId?' active':'');
    item.dataset.chatId=id;
    item.innerHTML=`${avHTML(av,name,42,c.type==='group'?'round':'')}
      <div class="chat-info"><div class="chat-name">${esc(name)}</div><div class="chat-preview">${esc((c.lastMsg?.text||'...').substring(0,40))}</div></div>
      <div class="chat-meta"><span class="chat-time">${c.lastMsg?.ts?fmt(c.lastMsg.ts):''}</span></div>`;
    item.onclick=()=>openChat(id,c);
    list.appendChild(item);
  });
}

window.filterChats=()=>renderChatList(chatsData);

function chatName(c){
  if(c.type==='group') return c.name||'–ì—Ä—É–ø–ø–∞';
  if(c.names){ const o=Object.entries(c.names).find(([uid])=>uid!==CU?.uid); return o?o[1]:'–ß–∞—Ç'; }
  return '–ß–∞—Ç';
}
function chatAv(c){
  if(c.type==='group') return c.avatar||{color:'#7c3aed',emoji:'üë•'};
  if(c.avatars){ const o=Object.entries(c.avatars).find(([uid])=>uid!==CU?.uid); return o?o[1]:null; }
  return null;
}

// ‚îÄ open chat ‚îÄ
window.openChat=(chatId,chat)=>{
  if(msgListener&&currentChatId) off(ref(db,`chats/${currentChatId}/messages`));
  currentChatId=chatId;
  document.getElementById('sidebar').classList.add('hidden');
  document.getElementById('chat-area').classList.add('visible');
  document.getElementById('empty-placeholder').style.display='none';
  document.getElementById('active-chat').style.display='flex';
  const name=chatName(chat);
  document.getElementById('topbar-name').textContent=name;
  const tav=document.getElementById('topbar-av');
  tav.className='av'+(chat.type==='group'?' round':'');
  renderAvInEl(tav, chatAv(chat), name, 40);
  document.getElementById('topbar-status').textContent=chat.type==='group'?`${Object.keys(chat.members||{}).length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`:'–æ–Ω–ª–∞–π–Ω';
  document.querySelectorAll('.chat-item').forEach(el=>el.classList.toggle('active',el.dataset.chatId===chatId));
  loadMessages(chatId);
};
window.goBack=()=>{ document.getElementById('sidebar').classList.remove('hidden'); document.getElementById('chat-area').classList.remove('visible'); };

function loadMessages(chatId){
  const el=document.getElementById('messages');
  el.innerHTML='<div style="flex:1"></div>';
  msgListener=onValue(query(ref(db,`chats/${chatId}/messages`),orderByChild('ts'),limitToLast(100)), s=>renderMessages(s.val()||{}));
}

function renderMessages(data){
  const el=document.getElementById('messages');
  const atBot=el.scrollHeight-el.scrollTop<=el.clientHeight+60;
  el.innerHTML='';
  const msgs=Object.values(data).sort((a,b)=>a.ts-b.ts);
  let lastDate=null;
  msgs.forEach(msg=>{
    const ds=fmtDate(msg.ts);
    if(ds!==lastDate){ const d=document.createElement('div'); d.className='date-divider'; d.innerHTML=`<span>${ds}</span>`; el.appendChild(d); lastDate=ds; }
    const sent=msg.uid===CU.uid;
    const g=document.createElement('div'); g.className='msg-group '+(sent?'sent':'recv');
    if(!sent){ const s=document.createElement('div'); s.className='msg-sender'; s.textContent=msg.senderName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'; s.onclick=()=>openUserById(msg.uid); g.appendChild(s); }
    const b=document.createElement('div'); b.className='msg-bubble'; b.textContent=msg.text; g.appendChild(b);
    const t=document.createElement('div'); t.className='msg-time'; t.textContent=fmt(msg.ts); g.appendChild(t);
    el.appendChild(g);
  });
  if(atBot||msgs.length<=20) el.scrollTop=el.scrollHeight;
}

window.sendMessage=async()=>{
  const inp=document.getElementById('msg-input');
  const text=inp.value.trim();
  if(!text||!currentChatId) return;
  inp.value=''; inp.style.height='auto';
  await push(ref(db,`chats/${currentChatId}/messages`),{text,uid:CU.uid,senderName:CUdata?.name||CU.displayName||CU.email,ts:Date.now()});
  await update(ref(db,`chats/${currentChatId}`),{lastMsgTs:Date.now()});
};
window.handleKey=e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} };
window.autoResize=el=>{ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,110)+'px'; };
window.insertEmoji=()=>{
  const arr=['üòä','üëç','‚ù§Ô∏è','üòÇ','üéâ','üî•','‚ú®','üôè','üòé','üí™','ü§î','üëÄ','ü´°','üíÄ','ü§£','ü•π','üíØ','ü´∂'];
  document.getElementById('msg-input').value+=arr[Math.floor(Math.random()*arr.length)];
  document.getElementById('msg-input').focus();
};

// ‚îÄ new chat ‚îÄ
window.openNewChatModal=()=>{ document.getElementById('new-chat-modal').classList.add('open'); document.getElementById('new-chat-input').value=''; setErr('new-chat-err',''); document.getElementById('is-group').checked=false; };
window.closeModal=id=>document.getElementById(id).classList.remove('open');

window.createChat=async()=>{
  const val=document.getElementById('new-chat-input').value.trim().replace(/^@/,'');
  const isGroup=document.getElementById('is-group').checked;
  setErr('new-chat-err','');
  if(!val){setErr('new-chat-err','‚úó –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');return;}
  if(isGroup){
    const r=push(ref(db,'chats'));
    await set(r,{type:'group',name:val,members:{[CU.uid]:true},avatar:{color:COLORS[Math.floor(Math.random()*COLORS.length)],emoji:'üë•'},createdBy:CU.uid,createdAt:Date.now()});
    await set(ref(db,`userChats/${CU.uid}/${r.key}`),true);
    closeModal('new-chat-modal');
  } else {
    const u=await findUser(val);
    if(!u){setErr('new-chat-err','‚úó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');return;}
    if(u.uid===CU.uid){setErr('new-chat-err','‚úó –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç —Å —Å–æ–±–æ–π');return;}
    const ex=Object.entries(chatsData).find(([,c])=>c.type==='direct'&&c.members?.[CU.uid]&&c.members?.[u.uid]);
    if(ex){closeModal('new-chat-modal');openChat(ex[0],ex[1]);return;}
    const r=push(ref(db,'chats'));
    await set(r,{type:'direct',members:{[CU.uid]:true,[u.uid]:true},names:{[CU.uid]:CUdata?.name||CU.displayName,[ u.uid]:u.name},avatars:{[CU.uid]:CUdata?.avatar||null,[u.uid]:u.avatar||null},createdAt:Date.now()});
    await set(ref(db,`userChats/${CU.uid}/${r.key}`),true);
    await set(ref(db,`userChats/${u.uid}/${r.key}`),true);
    closeModal('new-chat-modal');
  }
};

async function findUser(q){
  const snap=await get(ref(db,'users'));
  if(!snap.exists()) return null;
  let found=null;
  snap.forEach(c=>{ const u=c.val(); if(u.email===q||u.nickLower===q.toLowerCase()||u.nick===q) found=u; });
  return found;
}

// ‚îÄ my profile ‚îÄ
window.openMyProfile=()=>{
  if(!CUdata) return;
  document.getElementById('my-profile-name').textContent=CUdata.name||'?';
  document.getElementById('my-profile-nick').textContent='@'+(CUdata.nick||'');
  document.getElementById('my-profile-name-input').value=CUdata.name||'';
  renderAvInEl(document.getElementById('my-profile-av'), CUdata.avatar, CUdata.name, 88);
  const nick=CUdata.nick||'';
  document.getElementById('my-invite-link').textContent=nick?location.origin+location.pathname+'?adduser='+nick:'(–Ω–µ—Ç @username)';
  document.getElementById('my-profile-modal').classList.add('open');
};
window.copyMyLink=()=>{ const t=document.getElementById('my-invite-link').textContent; if(t.startsWith('http')) navigator.clipboard.writeText(t).then(()=>toast('‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!')); };
window.saveProfileName=async()=>{
  const n=document.getElementById('my-profile-name-input').value.trim();
  if(!n) return;
  await updateProfile(CU,{displayName:n});
  await update(ref(db,`users/${CU.uid}`),{name:n});
  CUdata.name=n;
  document.getElementById('my-profile-name').textContent=n;
  updateMyAvBtn();
  toast('‚úì –ò–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
};

// ‚îÄ avatar picker ‚îÄ
window.openAvatarPicker=()=>{
  const cg=document.getElementById('av-color-grid'); cg.innerHTML='';
  COLORS.forEach(c=>{ const d=document.createElement('div'); d.className='av-color'+(c===pickerColor?' sel':''); d.style.background=c; d.onclick=()=>{pickerColor=c;cg.querySelectorAll('.av-color').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');}; cg.appendChild(d); });
  const eg=document.getElementById('av-emoji-grid'); eg.innerHTML='';
  EMOJIS.forEach(e=>{ const d=document.createElement('div'); d.className='av-emoji'+(e===pickerEmoji?' sel':''); d.textContent=e; d.onclick=()=>{pickerEmoji=e;eg.querySelectorAll('.av-emoji').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');}; eg.appendChild(d); });
  document.getElementById('avatar-modal').classList.add('open');
};
window.saveAvatar=async()=>{
  const av={color:pickerColor,emoji:pickerEmoji};
  await update(ref(db,`users/${CU.uid}`),{avatar:av});
  CUdata.avatar=av;
  updateMyAvBtn();
  renderAvInEl(document.getElementById('my-profile-av'), av, CUdata.name, 88);
  closeModal('avatar-modal');
  toast('‚úì –ê–≤–∞—Ç–∞—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
};

// ‚îÄ user profile modal ‚îÄ
function showUserModal(u){
  renderAvInEl(document.getElementById('upm-av'), u.avatar, u.name, 88);
  document.getElementById('upm-name').textContent=u.name;
  document.getElementById('upm-nick').textContent='@'+(u.nick||u.nickLower||'');
  const nick=u.nick||u.nickLower||'';
  const lw=document.getElementById('upm-link-wrap');
  if(nick){ lw.style.display='flex'; document.getElementById('upm-link').textContent=location.origin+location.pathname+'?adduser='+nick; }
  else lw.style.display='none';
  const btn=document.getElementById('upm-msg-btn');
  btn.onclick=async()=>{
    closeModal('user-profile-modal');
    const ex=Object.entries(chatsData).find(([,c])=>c.type==='direct'&&c.members?.[CU.uid]&&c.members?.[u.uid]);
    if(ex){openChat(ex[0],ex[1]);return;}
    const r=push(ref(db,'chats'));
    const chat={type:'direct',members:{[CU.uid]:true,[u.uid]:true},names:{[CU.uid]:CUdata?.name||CU.displayName,[u.uid]:u.name},avatars:{[CU.uid]:CUdata?.avatar||null,[u.uid]:u.avatar||null},createdAt:Date.now()};
    await set(r,chat);
    await set(ref(db,`userChats/${CU.uid}/${r.key}`),true);
    await set(ref(db,`userChats/${u.uid}/${r.key}`),true);
    chatsData[r.key]=chat;
    openChat(r.key,chat);
  };
  document.getElementById('user-profile-modal').classList.add('open');
}

window.copyUpmLink=()=>{ const t=document.getElementById('upm-link').textContent; navigator.clipboard.writeText(t).then(()=>toast('‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!')); };

async function openUserById(uid){
  const snap=await get(ref(db,`users/${uid}`));
  if(snap.exists()) showUserModal(snap.val());
}

// ‚îÄ chat profile ‚îÄ
window.openChatProfile=async()=>{
  const chat=chatsData[currentChatId]; if(!chat) return;
  if(chat.type==='direct'){
    const o=Object.entries(chat.members||{}).find(([uid])=>uid!==CU.uid);
    if(o) await openUserById(o[0]);
  } else toast('–ì—Ä—É–ø–ø–∞: '+chatName(chat));
};

// ‚îÄ share invite ‚îÄ
window.shareInvite=()=>{
  const chat=chatsData[currentChatId]; if(!chat) return;
  const link=chat.type==='group'
    ? location.origin+location.pathname+'?joingroup='+currentChatId
    : location.origin+location.pathname+'?adduser='+(CUdata?.nick||'');
  navigator.clipboard.writeText(link).then(()=>toast('‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!')).catch(()=>prompt('–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É:',link));
};

// ‚îÄ invite params ‚îÄ
async function checkInviteParam(){
  const p=new URLSearchParams(location.search);
  const adduser=p.get('adduser'), joingroup=p.get('joingroup');
  if(adduser){
    history.replaceState({},'',location.pathname);
    const u=await findUser(adduser);
    if(u) showUserModal(u); else toast('‚úó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @'+adduser+' –Ω–µ –Ω–∞–π–¥–µ–Ω');
  }
  if(joingroup){
    history.replaceState({},'',location.pathname);
    const snap=await get(ref(db,`chats/${joingroup}`));
    if(snap.exists()&&snap.val().type==='group'){
      await update(ref(db,`chats/${joingroup}/members`),{[CU.uid]:true});
      await set(ref(db,`userChats/${CU.uid}/${joingroup}`),true);
      toast('‚úì –í—ã –≤—Å—Ç—É–ø–∏–ª–∏ –≤ –≥—Ä—É–ø–ø—É: '+snap.val().name);
    } else toast('‚úó –ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
  }
}

// ‚îÄ members ‚îÄ
window.showMembers=()=>{ const c=chatsData[currentChatId]; if(!c) return; alert('–£—á–∞—Å—Ç–Ω–∏–∫–∏:\n‚Ä¢ '+(c.names?Object.values(c.names).join('\n‚Ä¢ '):'—Ç–æ–ª—å–∫–æ –≤—ã')); };

// ‚îÄ empty state ‚îÄ
function showEmpty(){ document.getElementById('empty-placeholder').style.display='flex'; document.getElementById('active-chat').style.display='none'; }

// ‚îÄ error xlate ‚îÄ
function xlate(code){
  const m={'auth/email-already-in-use':'Email —É–∂–µ –∑–∞–Ω—è—Ç','auth/invalid-email':'–ù–µ–≤–µ—Ä–Ω—ã–π email','auth/weak-password':'–°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å','auth/user-not-found':'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω','auth/wrong-password':'–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å','auth/invalid-credential':'–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å','auth/too-many-requests':'–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫','auth/network-request-failed':'–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞'};
  return m[code]||('–û—à–∏–±–∫–∞: '+code);
}

// close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(el=>el.addEventListener('click',e=>{ if(e.target===el) el.classList.remove('open'); }));

// keyboard
document.getElementById('login-pass').addEventListener('keydown',e=>{ if(e.key==='Enter') doLogin(); });
document.getElementById('reg-pass').addEventListener('keydown',e=>{ if(e.key==='Enter') doRegister(); });
document.getElementById('login-id').addEventListener('keydown',e=>{ if(e.key==='Enter') document.getElementById('login-pass').focus(); });
document.getElementById('new-chat-input').addEventListener('keydown',e=>{ if(e.key==='Enter') createChat(); });
document.getElementById('user-search-input').addEventListener('keydown',e=>{ if(e.key==='Escape') switchTab('chats'); });
</script>
</body>
</html>
