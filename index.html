<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WAVE ‚Äî –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0f;--surface:#111118;--surface2:#18181f;--border:#252530;--accent:#7c3aed;--accent2:#a855f7;--glow:rgba(124,58,237,.35);--text:#e8e8f0;--muted:#6b6b80;--online:#22d3ee;--danger:#f87171;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;height:100dvh;display:flex;flex-direction:column;overflow:hidden;}

/* AUTH */
#auth-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100dvh;background:radial-gradient(ellipse 80% 60% at 50% -10%,rgba(124,58,237,.25),transparent);}
.auth-logo{font-size:3.5rem;font-weight:800;letter-spacing:-2px;background:linear-gradient(135deg,#a855f7,#38bdf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;}
.auth-sub{color:var(--muted);font-family:'Space Mono',monospace;font-size:.72rem;letter-spacing:3px;margin-bottom:40px;text-transform:uppercase;}
.auth-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px 36px;width:340px;display:flex;flex-direction:column;gap:14px;box-shadow:0 0 60px rgba(0,0,0,.5);}
.auth-box h2{font-size:1.1rem;font-weight:700;}
.auth-input{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px 16px;color:var(--text);font-family:'Space Mono',monospace;font-size:.83rem;width:100%;outline:none;transition:border-color .2s;}
.auth-input:focus{border-color:var(--accent2);}
.auth-btn{background:linear-gradient(135deg,var(--accent),#9333ea);border:none;border-radius:10px;padding:13px;color:#fff;font-family:'Syne',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;transition:opacity .2s,transform .1s;}
.auth-btn:hover{opacity:.9;}.auth-btn:active{transform:scale(.98);}.auth-btn:disabled{opacity:.5;cursor:not-allowed;}
.auth-switch{text-align:center;font-size:.8rem;color:var(--muted);}
.auth-switch a{color:var(--accent2);cursor:pointer;}
.auth-error{color:var(--danger);font-family:'Space Mono',monospace;font-size:.73rem;min-height:16px;}

/* APP */
#app-screen{display:none;flex-direction:row;height:100dvh;overflow:hidden;}
#app-screen.visible{display:flex;}

/* SIDEBAR */
#sidebar{width:280px;min-width:280px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.sidebar-header{padding:14px 14px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
.sidebar-logo{font-size:1.3rem;font-weight:800;letter-spacing:-1px;background:linear-gradient(135deg,#a855f7,#38bdf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;flex:1;}
.my-av-btn{width:34px;height:34px;border-radius:10px;cursor:pointer;border:2px solid var(--border);transition:border-color .2s;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;color:#fff;}
.my-av-btn:hover{border-color:var(--accent2);}
.logout-btn{background:none;border:1px solid var(--border);border-radius:7px;color:var(--muted);padding:4px 9px;font-family:'Space Mono',monospace;font-size:.62rem;cursor:pointer;transition:border-color .2s,color .2s;white-space:nowrap;}
.logout-btn:hover{border-color:var(--danger);color:var(--danger);}
.sidebar-tabs{display:flex;border-bottom:1px solid var(--border);}
.s-tab{flex:1;padding:10px;font-size:.72rem;font-weight:600;text-align:center;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:color .2s,border-color .2s;}
.s-tab.active{color:var(--accent2);border-bottom-color:var(--accent2);}
.sidebar-search{padding:10px 12px;border-bottom:1px solid var(--border);}
.search-wrap{position:relative;display:flex;align-items:center;}
.search-icon{position:absolute;left:10px;color:var(--muted);font-size:.85rem;pointer-events:none;}
.search-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:8px 10px 8px 30px;color:var(--text);font-family:'Space Mono',monospace;font-size:.76rem;outline:none;transition:border-color .2s;}
.search-input:focus{border-color:var(--accent2);}
.new-chat-btn{margin:10px 12px;background:none;border:1px dashed var(--border);border-radius:10px;padding:9px;color:var(--muted);font-family:'Syne',sans-serif;font-size:.8rem;cursor:pointer;display:flex;align-items:center;gap:8px;transition:border-color .2s,color .2s;}
.new-chat-btn:hover{border-color:var(--accent2);color:var(--accent2);}
.section-label{padding:6px 14px 3px;font-size:.62rem;font-family:'Space Mono',monospace;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;}
#chat-list,#user-search-results{flex:1;overflow-y:auto;padding:2px 0;}
#chat-list::-webkit-scrollbar,#user-search-results::-webkit-scrollbar{width:3px;}
#chat-list::-webkit-scrollbar-thumb,#user-search-results::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.chat-item{display:flex;align-items:center;gap:11px;padding:10px 14px;cursor:pointer;border-left:2px solid transparent;transition:background .15s,border-color .15s;position:relative;}
.chat-item:hover{background:var(--surface2);}
.chat-item.active{background:var(--surface2);border-left-color:var(--accent2);}
.chat-item-fav{position:absolute;right:10px;top:8px;font-size:.6rem;color:var(--accent2);}
.av{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1rem;flex-shrink:0;position:relative;overflow:hidden;}
.av img{width:100%;height:100%;object-fit:cover;}
.av.round{border-radius:50%;}
.chat-info{flex:1;min-width:0;}
.chat-name{font-size:.87rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.chat-preview{font-size:.72rem;color:var(--muted);font-family:'Space Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;}
.chat-meta{display:flex;flex-direction:column;align-items:flex-end;gap:3px;}
.chat-time{font-size:.63rem;color:var(--muted);font-family:'Space Mono',monospace;}
.user-item{display:flex;align-items:center;gap:11px;padding:10px 14px;cursor:pointer;transition:background .15s;}
.user-item:hover{background:var(--surface2);}
.user-item-info{flex:1;min-width:0;}
.user-item-name{font-size:.87rem;font-weight:600;}
.user-item-nick{font-size:.72rem;color:var(--muted);font-family:'Space Mono',monospace;}
.user-item-btn{background:var(--accent);border:none;border-radius:7px;padding:5px 12px;color:#fff;font-family:'Syne',sans-serif;font-size:.75rem;font-weight:700;cursor:pointer;transition:opacity .2s;white-space:nowrap;}
.user-item-btn:hover{opacity:.85;}

/* CHAT AREA */
#chat-area{flex:1;display:flex;flex-direction:column;min-width:0;background:var(--bg);background-image:radial-gradient(ellipse 50% 40% at 80% 10%,rgba(124,58,237,.07),transparent);}
.chat-topbar{padding:13px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;background:var(--surface);}
.chat-topbar-name{font-size:.97rem;font-weight:700;}
.chat-topbar-status{font-size:.7rem;color:var(--online);font-family:'Space Mono',monospace;}
.topbar-actions{margin-left:auto;display:flex;gap:7px;}
.icon-btn{background:none;border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--muted);cursor:pointer;font-size:.88rem;transition:border-color .2s,color .2s;}
.icon-btn:hover{border-color:var(--accent2);color:var(--accent2);}
.back-btn{display:none;background:none;border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--muted);cursor:pointer;font-size:.82rem;}

/* MESSAGES */
#messages{flex:1;overflow-y:auto;padding:20px 20px 6px;display:flex;flex-direction:column;gap:2px;}
#messages::-webkit-scrollbar{width:3px;}
#messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.msg-group{display:flex;flex-direction:column;gap:1px;margin-bottom:6px;}
.msg-group.sent{align-items:flex-end;}
.msg-group.recv{align-items:flex-start;}
.msg-sender{font-size:.68rem;font-family:'Space Mono',monospace;color:var(--accent2);margin-bottom:2px;padding:0 4px;cursor:pointer;}
.msg-sender:hover{text-decoration:underline;}
.msg-bubble{max-width:68%;padding:9px 14px;border-radius:16px;font-size:.87rem;line-height:1.5;word-break:break-word;animation:popIn .16s ease;cursor:pointer;position:relative;transition:opacity .15s;}
.msg-bubble:hover{opacity:.92;}
@keyframes popIn{from{opacity:0;transform:scale(.92) translateY(5px);}to{opacity:1;transform:scale(1) translateY(0);}}
.msg-group.sent .msg-bubble{background:linear-gradient(135deg,var(--accent),#9333ea);color:#fff;border-bottom-right-radius:4px;}
.msg-group.recv .msg-bubble{background:var(--surface2);border:1px solid var(--border);color:var(--text);border-bottom-left-radius:4px;}
.msg-time{font-size:.6rem;font-family:'Space Mono',monospace;color:rgba(255,255,255,.4);margin-top:2px;padding:0 4px;}
.msg-group.recv .msg-time{color:var(--muted);}

/* Reply preview inside bubble */
.reply-preview{border-left:3px solid rgba(255,255,255,.5);padding:4px 8px;margin-bottom:6px;border-radius:4px;background:rgba(0,0,0,.2);cursor:pointer;}
.msg-group.recv .reply-preview{border-left-color:var(--accent2);background:rgba(124,58,237,.12);}
.reply-preview-name{font-size:.65rem;font-weight:700;opacity:.8;}
.reply-preview-text{font-size:.72rem;opacity:.7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px;}

/* Forward label */
.fwd-label{font-size:.65rem;font-family:'Space Mono',monospace;opacity:.6;margin-bottom:3px;padding:0 2px;}

/* Reactions bar */
.msg-reactions{display:flex;gap:4px;flex-wrap:wrap;margin-top:3px;padding:0 2px;}
.reaction-pill{background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:2px 8px;font-size:.78rem;cursor:pointer;display:flex;align-items:center;gap:3px;transition:border-color .2s,background .2s;user-select:none;}
.reaction-pill:hover{border-color:var(--accent2);}
.reaction-pill.mine{background:rgba(124,58,237,.2);border-color:var(--accent);}
.reaction-count{font-size:.65rem;color:var(--muted);font-family:'Space Mono',monospace;}

.date-divider{display:flex;align-items:center;gap:10px;margin:10px 0;}
.date-divider::before,.date-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.date-divider span{font-size:.63rem;font-family:'Space Mono',monospace;color:var(--muted);white-space:nowrap;}

/* REPLY BAR */
.reply-bar{display:none;padding:8px 20px;background:var(--surface);border-top:1px solid var(--border);align-items:center;gap:10px;}
.reply-bar.show{display:flex;}
.reply-bar-content{flex:1;min-width:0;}
.reply-bar-name{font-size:.7rem;color:var(--accent2);font-weight:700;}
.reply-bar-text{font-size:.75rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.reply-bar-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1rem;flex-shrink:0;padding:0 4px;}
.reply-bar-close:hover{color:var(--text);}

/* INPUT AREA */
.input-area{padding:12px 20px;border-top:1px solid var(--border);display:flex;gap:10px;align-items:flex-end;background:var(--surface);}
.msg-input-wrap{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:12px;display:flex;align-items:flex-end;gap:7px;padding:9px 13px;transition:border-color .2s;position:relative;}
.msg-input-wrap:focus-within{border-color:var(--accent2);}
.msg-input{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'Syne',sans-serif;font-size:.87rem;resize:none;max-height:110px;line-height:1.5;}
.emoji-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.05rem;padding:0;transition:color .2s;}
.emoji-btn:hover{color:var(--accent2);}
.send-btn{background:linear-gradient(135deg,var(--accent),#9333ea);border:none;border-radius:12px;width:44px;height:44px;color:#fff;font-size:1.05rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:opacity .2s,transform .1s;box-shadow:0 4px 18px var(--glow);}
.send-btn:hover{opacity:.9;}.send-btn:active{transform:scale(.92);}

/* EMOJI PICKER */
.emoji-picker{position:absolute;bottom:52px;left:0;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:10px;width:310px;box-shadow:0 10px 40px rgba(0,0,0,.5);z-index:50;display:none;flex-direction:column;gap:8px;}
.emoji-picker.open{display:flex;}
.emoji-cat-tabs{display:flex;gap:3px;overflow-x:auto;padding-bottom:2px;}
.emoji-cat-tabs::-webkit-scrollbar{height:2px;}
.emoji-cat-tab{background:none;border:1px solid transparent;border-radius:7px;padding:4px 7px;font-size:.82rem;cursor:pointer;color:var(--muted);transition:background .15s;white-space:nowrap;}
.emoji-cat-tab.active{background:var(--surface2);border-color:var(--border);color:var(--text);}
.emoji-search{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--text);font-family:'Space Mono',monospace;font-size:.75rem;width:100%;outline:none;}
.emoji-search:focus{border-color:var(--accent2);}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;max-height:180px;overflow-y:auto;}
.emoji-grid::-webkit-scrollbar{width:3px;}
.emoji-cell{border:none;background:none;font-size:1.2rem;cursor:pointer;border-radius:6px;padding:4px;transition:background .1s;text-align:center;}
.emoji-cell:hover{background:var(--surface2);}

/* CONTEXT MENU */
.ctx-menu{position:fixed;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:6px;min-width:200px;box-shadow:0 12px 40px rgba(0,0,0,.6);z-index:200;display:none;}
.ctx-menu.show{display:block;}
.ctx-reaction-row{display:flex;gap:4px;padding:6px 8px;border-bottom:1px solid var(--border);margin-bottom:4px;}
.ctx-react-btn{background:none;border:1px solid transparent;border-radius:8px;font-size:1.3rem;padding:4px 6px;cursor:pointer;transition:background .1s,border-color .1s;flex:1;text-align:center;}
.ctx-react-btn:hover{background:var(--surface2);border-color:var(--border);}
.ctx-react-btn.active{background:rgba(124,58,237,.2);border-color:var(--accent);}
.ctx-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:.85rem;transition:background .12s;color:var(--text);}
.ctx-item:hover{background:var(--surface2);}
.ctx-item.danger{color:var(--danger);}
.ctx-item-icon{font-size:1rem;width:20px;text-align:center;}

/* EMPTY STATE */
.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;color:var(--muted);}
.empty-icon{font-size:2.8rem;opacity:.3;}
.empty-state h3{font-size:.97rem;font-weight:600;color:var(--muted);}
.empty-state p{font-size:.77rem;font-family:'Space Mono',monospace;}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(5px);display:flex;align-items:center;justify-content:center;z-index:100;opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:26px 30px;width:420px;display:flex;flex-direction:column;gap:13px;transform:scale(.94);transition:transform .2s;max-height:90dvh;overflow-y:auto;}
.modal-overlay.open .modal{transform:scale(1);}
.modal::-webkit-scrollbar{width:3px;}
.modal::-webkit-scrollbar-thumb{background:var(--border);}
.modal h3{font-size:1rem;font-weight:700;}
.modal-actions{display:flex;gap:9px;margin-top:4px;}
.modal-cancel{flex:1;background:none;border:1px solid var(--border);border-radius:9px;padding:10px;color:var(--muted);font-family:'Syne',sans-serif;font-size:.83rem;cursor:pointer;transition:border-color .2s;}
.modal-cancel:hover{border-color:var(--muted);}
.modal-ok{flex:1;background:linear-gradient(135deg,var(--accent),#9333ea);border:none;border-radius:9px;padding:10px;color:#fff;font-family:'Syne',sans-serif;font-size:.83rem;font-weight:700;cursor:pointer;transition:opacity .2s;}
.modal-ok:hover{opacity:.9;}
.modal-section{font-size:.7rem;font-family:'Space Mono',monospace;color:var(--muted);letter-spacing:1px;text-transform:uppercase;border-top:1px solid var(--border);padding-top:10px;margin-top:2px;}

.profile-av-wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:6px 0;}
.profile-av{width:88px;height:88px;border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:2.2rem;font-weight:700;cursor:pointer;position:relative;overflow:hidden;border:2px solid var(--border);transition:border-color .2s;}
.profile-av:hover{border-color:var(--accent2);}
.profile-av img{width:100%;height:100%;object-fit:cover;}
.profile-av-overlay{position:absolute;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s;font-size:.72rem;color:#fff;font-family:'Space Mono',monospace;text-align:center;pointer-events:none;}
.profile-av:hover .profile-av-overlay{opacity:1;}
.profile-name-big{font-size:1.1rem;font-weight:700;text-align:center;}
.profile-nick{font-size:.78rem;color:var(--muted);font-family:'Space Mono',monospace;text-align:center;}
.profile-bio{font-size:.78rem;color:var(--muted);text-align:center;font-style:italic;max-width:300px;line-height:1.5;}

.invite-link-wrap{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:8px;}
.invite-link-text{flex:1;font-family:'Space Mono',monospace;font-size:.7rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.copy-btn{background:var(--accent);border:none;border-radius:7px;padding:5px 10px;color:#fff;font-family:'Space Mono',monospace;font-size:.65rem;cursor:pointer;white-space:nowrap;transition:opacity .2s;}
.copy-btn:hover{opacity:.85;}

.av-color-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;}
.av-color{width:100%;aspect-ratio:1;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:border-color .2s,transform .1s;}
.av-color:hover,.av-color.sel{border-color:#fff;transform:scale(1.08);}
.av-emoji-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;}
.av-emoji{width:100%;aspect-ratio:1;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2rem;background:var(--surface2);border:2px solid transparent;transition:border-color .2s,transform .1s;}
.av-emoji:hover,.av-emoji.sel{border-color:var(--accent2);transform:scale(1.08);}

/* Photo upload */
.photo-upload-area{border:2px dashed var(--border);border-radius:10px;padding:16px;text-align:center;cursor:pointer;transition:border-color .2s;position:relative;overflow:hidden;}
.photo-upload-area:hover{border-color:var(--accent2);}
.photo-upload-area input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.photo-upload-text{font-size:.75rem;color:var(--muted);font-family:'Space Mono',monospace;pointer-events:none;}
.photo-preview-row{display:flex;align-items:center;gap:10px;}
.photo-preview{width:80px;height:80px;border-radius:10px;object-fit:cover;border:2px solid var(--border);}

/* IMAGE CROP MODAL */
#crop-container{position:relative;width:100%;height:260px;overflow:hidden;background:#000;border-radius:10px;cursor:crosshair;}
#crop-img{position:absolute;top:0;left:0;transform-origin:top left;}
#crop-overlay{position:absolute;inset:0;pointer-events:none;}
#crop-box{position:absolute;border:2px solid var(--accent2);box-shadow:0 0 0 9999px rgba(0,0,0,.55);border-radius:50%;cursor:move;}
.crop-handle{position:absolute;width:12px;height:12px;background:var(--accent2);border-radius:50%;cursor:nwse-resize;}
.crop-controls{display:flex;gap:8px;align-items:center;margin-top:6px;}
.crop-slider{flex:1;accent-color:var(--accent2);}

/* Members */
.member-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);}
.member-item:last-child{border-bottom:none;}
.member-info{flex:1;min-width:0;}
.member-name{font-size:.85rem;font-weight:600;}
.member-nick{font-size:.7rem;color:var(--muted);font-family:'Space Mono',monospace;}
.member-badge{font-size:.6rem;font-family:'Space Mono',monospace;background:rgba(124,58,237,.3);color:var(--accent2);border:1px solid var(--accent);border-radius:5px;padding:2px 6px;white-space:nowrap;}
.member-actions{display:flex;gap:5px;flex-wrap:wrap;}
.member-act{background:none;border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-size:.65rem;cursor:pointer;color:var(--muted);transition:color .15s,border-color .15s;white-space:nowrap;}
.member-act:hover{color:var(--text);border-color:var(--muted);}
.member-act.danger{color:var(--danger);}
.member-act.danger:hover{border-color:var(--danger);}
.member-act.accent{color:var(--accent2);}
.member-act.accent:hover{border-color:var(--accent2);}

/* Forward chat list */
.fwd-chat-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;cursor:pointer;transition:background .15s;}
.fwd-chat-item:hover{background:var(--surface2);}
.fwd-chat-item.sel{background:rgba(124,58,237,.15);border:1px solid var(--accent);}
.fwd-chat-name{font-size:.85rem;font-weight:600;}
.fwd-chat-type{font-size:.68rem;color:var(--muted);font-family:'Space Mono',monospace;}

/* Favorite messages */
.fav-msg-item{padding:10px;border:1px solid var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:border-color .15s;}
.fav-msg-item:hover{border-color:var(--accent2);}
.fav-msg-meta{font-size:.65rem;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:4px;}
.fav-msg-text{font-size:.82rem;line-height:1.5;}
.fav-msg-actions{display:flex;gap:6px;margin-top:6px;}
.fav-action-btn{background:none;border:1px solid var(--border);border-radius:6px;padding:3px 10px;font-size:.7rem;cursor:pointer;color:var(--muted);transition:color .15s,border-color .15s;}
.fav-action-btn:hover{color:var(--text);border-color:var(--muted);}
.fav-action-btn.danger:hover{color:var(--danger);border-color:var(--danger);}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 18px;font-size:.82rem;font-family:'Space Mono',monospace;opacity:0;transition:opacity .25s,transform .25s;z-index:999;pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

@media(max-width:640px){
  #sidebar{width:100%;min-width:unset;}
  #sidebar.hidden{display:none;}
  #chat-area{display:none;}
  #chat-area.visible{display:flex;}
  .back-btn{display:flex!important;}
  .modal{width:95vw;padding:20px;}
}
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth-screen">
  <div class="auth-logo">WAVE</div>
  <div class="auth-sub">messenger ¬∑ v5.0</div>
  <div class="auth-box" id="login-box">
    <h2>–í–æ–π—Ç–∏</h2>
    <input class="auth-input" id="login-id" type="text" placeholder="Email –∏–ª–∏ @username">
    <input class="auth-input" id="login-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <div class="auth-error" id="login-error"></div>
    <button class="auth-btn" id="login-btn" onclick="doLogin()">–í–æ–π—Ç–∏ ‚Üí</button>
    <div class="auth-switch">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="toggleAuth(true)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></div>
  </div>
  <div class="auth-box" id="reg-box" style="display:none">
    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input class="auth-input" id="reg-name" type="text" placeholder="–ò–º—è" maxlength="30">
    <input class="auth-input" id="reg-nick" type="text" placeholder="@username" maxlength="20">
    <input class="auth-input" id="reg-email" type="email" placeholder="Email">
    <input class="auth-input" id="reg-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6)">
    <div class="auth-error" id="reg-error"></div>
    <button class="auth-btn" id="reg-btn" onclick="doRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí</button>
    <div class="auth-switch">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="toggleAuth(false)">–í–æ–π—Ç–∏</a></div>
  </div>
</div>

<!-- APP -->
<div id="app-screen">
  <div id="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-logo">WAVE</span>
      <div class="my-av-btn" id="my-av-btn" onclick="openMyProfile()" title="–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å"></div>
      <button class="logout-btn" onclick="doLogout()">–≤—ã–π—Ç–∏</button>
    </div>
    <div class="sidebar-tabs">
      <div class="s-tab active" id="tab-chats" onclick="switchTab('chats')">–ß–∞—Ç—ã</div>
      <div class="s-tab" id="tab-search" onclick="switchTab('search')">üîç</div>
      <div class="s-tab" id="tab-favs" onclick="switchTab('favs')">‚≠ê</div>
    </div>
    <!-- Chats pane -->
    <div id="pane-chats" style="display:flex;flex-direction:column;flex:1;overflow:hidden;">
      <div class="sidebar-search">
        <div class="search-wrap">
          <span class="search-icon">‚åï</span>
          <input class="search-input" id="chat-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç–∞–º..." oninput="filterChats()">
        </div>
      </div>
      <button class="new-chat-btn" onclick="openNewChatModal()">Ôºã –ù–æ–≤—ã–π —á–∞—Ç</button>
      <div class="section-label">–î–∏–∞–ª–æ–≥–∏</div>
      <div id="chat-list"></div>
    </div>
    <!-- Search pane -->
    <div id="pane-search" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
      <div class="sidebar-search">
        <div class="search-wrap">
          <span class="search-icon">‚åï</span>
          <input class="search-input" id="user-search-input" placeholder="@username –∏–ª–∏ –∏–º—è..." oninput="searchUsers(this.value)">
        </div>
      </div>
      <div class="section-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
      <div id="user-search-results"><div style="padding:16px;font-size:.76rem;color:var(--muted);font-family:'Space Mono',monospace;">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ @–Ω–∏–∫</div></div>
    </div>
    <!-- Favorites pane -->
    <div id="pane-favs" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
      <div class="section-label" style="padding:14px 14px 6px;">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
      <div id="favs-list" style="flex:1;overflow-y:auto;padding:8px 12px;"></div>
    </div>
  </div>

  <div id="chat-area">
    <div id="empty-placeholder" class="empty-state">
      <div class="empty-icon">üí¨</div>
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
      <p>–∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ü–æ–∏—Å–∫–µ</p>
    </div>
    <div id="active-chat" style="display:none;flex-direction:column;height:100%;overflow:hidden;">
      <div class="chat-topbar">
        <button class="back-btn" onclick="goBack()">‚Üê</button>
        <div class="av" id="topbar-av" style="cursor:pointer" onclick="openChatProfile()"></div>
        <div style="cursor:pointer;flex:1;min-width:0;" onclick="openChatProfile()">
          <div class="chat-topbar-name" id="topbar-name"></div>
          <div class="chat-topbar-status" id="topbar-status"></div>
        </div>
        <div class="topbar-actions">
          <button class="icon-btn" id="fav-topbar-btn" onclick="toggleChatFavorite()" title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">‚òÜ</button>
          <button class="icon-btn" onclick="shareInvite()" title="–°—Å—ã–ª–∫–∞">üîó</button>
          <button class="icon-btn" onclick="showMembers()" title="–£—á–∞—Å—Ç–Ω–∏–∫–∏">üë•</button>
        </div>
      </div>
      <div id="messages"></div>
      <div class="reply-bar" id="reply-bar">
        <div style="font-size:.8rem;color:var(--accent2);">‚Ü©</div>
        <div class="reply-bar-content">
          <div class="reply-bar-name" id="reply-bar-name"></div>
          <div class="reply-bar-text" id="reply-bar-text"></div>
        </div>
        <button class="reply-bar-close" onclick="cancelReply()">‚úï</button>
      </div>
      <div class="input-area">
        <div class="msg-input-wrap">
          <textarea class="msg-input" id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"
            onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
          <button class="emoji-btn" onclick="toggleEmojiPicker(event)">‚ò∫</button>
          <div class="emoji-picker" id="emoji-picker">
            <input class="emoji-search" id="emoji-search" placeholder="–ü–æ–∏—Å–∫..." oninput="filterEmojis(this.value)">
            <div class="emoji-cat-tabs" id="emoji-cat-tabs"></div>
            <div class="emoji-grid" id="emoji-grid"></div>
          </div>
        </div>
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-reaction-row" id="ctx-reactions"></div>
  <div class="ctx-item" id="ctx-reply"><span class="ctx-item-icon">‚Ü©</span>–û—Ç–≤–µ—Ç–∏—Ç—å</div>
  <div class="ctx-item" id="ctx-forward"><span class="ctx-item-icon">‚Ü™</span>–ü–µ—Ä–µ—Å–ª–∞—Ç—å</div>
  <div class="ctx-item" id="ctx-favorite"><span class="ctx-item-icon">‚≠ê</span>–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
  <div class="ctx-item" id="ctx-copy"><span class="ctx-item-icon">üìã</span>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
  <div class="ctx-item danger" id="ctx-delete" style="display:none"><span class="ctx-item-icon">üóë</span>–£–¥–∞–ª–∏—Ç—å</div>
</div>

<!-- New Chat Modal -->
<div class="modal-overlay" id="new-chat-modal">
  <div class="modal">
    <h3>–ù–æ–≤—ã–π —á–∞—Ç</h3>
    <input class="auth-input" id="new-chat-input" placeholder="@username / email / –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
    <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;color:var(--muted);cursor:pointer;">
      <input type="checkbox" id="is-group" style="accent-color:var(--accent);"> –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç
    </label>
    <div id="group-desc-wrap" style="display:none;">
      <input class="auth-input" id="group-desc-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" maxlength="200">
    </div>
    <div class="auth-error" id="new-chat-err"></div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('new-chat-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-ok" onclick="createChat()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- My Profile Modal -->
<div class="modal-overlay" id="my-profile-modal">
  <div class="modal">
    <h3>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h3>
    <div class="profile-av-wrap">
      <div class="profile-av" id="my-profile-av" onclick="openAvatarPicker()">
        <div class="profile-av-overlay">–∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</div>
      </div>
      <div>
        <div class="profile-name-big" id="my-profile-name"></div>
        <div class="profile-nick" id="my-profile-nick"></div>
      </div>
    </div>
    <div class="modal-section">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
    <input class="auth-input" id="my-profile-name-input" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è">
    <input class="auth-input" id="my-profile-nick-input" placeholder="@username" maxlength="20">
    <textarea class="auth-input" id="my-profile-bio-input" placeholder="–û —Å–µ–±–µ..." maxlength="200" rows="3" style="resize:none;"></textarea>
    <div class="auth-error" id="profile-save-err"></div>
    <button class="modal-ok" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <div class="modal-section">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</div>
    <button class="modal-ok" style="background:none;border:1px solid var(--border);color:var(--text);" onclick="sendPasswordReset()">üìß –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –Ω–∞ email</button>
    <div class="modal-section">–ú–æ—è —Å—Å—ã–ª–∫–∞</div>
    <div class="invite-link-wrap">
      <span class="invite-link-text" id="my-invite-link"></span>
      <button class="copy-btn" onclick="copyMyLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div class="modal-actions"><button class="modal-cancel" onclick="closeModal('my-profile-modal')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div>
</div>

<!-- Avatar Picker Modal -->
<div class="modal-overlay" id="avatar-modal">
  <div class="modal">
    <h3>–ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</h3>
    <div class="modal-section">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</div>
    <div class="photo-upload-area" id="avatar-upload-area">
      <input type="file" id="avatar-file-input" accept="image/*" onchange="handleAvatarFile(event)">
      <div class="photo-upload-text" id="avatar-upload-text">üì∑ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏<br><span style="font-size:.65rem;opacity:.6;">JPG, PNG –¥–æ 5–ú–ë</span></div>
    </div>
    <div class="modal-section">–ò–ª–∏ –≤—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏</div>
    <div style="font-size:.72rem;color:var(--muted);">–¶–≤–µ—Ç</div>
    <div class="av-color-grid" id="av-color-grid"></div>
    <div style="font-size:.72rem;color:var(--muted);margin-top:6px;">–≠–º–æ–¥–∑–∏</div>
    <div class="av-emoji-grid" id="av-emoji-grid"></div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('avatar-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-ok" onclick="saveAvatar()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Image Crop Modal -->
<div class="modal-overlay" id="crop-modal">
  <div class="modal" style="width:460px;">
    <h3>–û–±—Ä–µ–∑–∞—Ç—å —Ñ–æ—Ç–æ</h3>
    <div id="crop-container">
      <img id="crop-img" draggable="false">
      <div id="crop-box"></div>
    </div>
    <div class="crop-controls">
      <span style="font-size:.75rem;color:var(--muted);">–ú–∞—Å—à—Ç–∞–±</span>
      <input type="range" class="crop-slider" id="crop-scale" min="0.5" max="3" step="0.01" value="1" oninput="updateCropScale(this.value)">
    </div>
    <p style="font-size:.72rem;color:var(--muted);font-family:'Space Mono',monospace;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫—Ä—É–≥ –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ–±–ª–∞—Å—Ç–∏</p>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('crop-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-ok" onclick="applyCrop()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- User Profile Modal -->
<div class="modal-overlay" id="user-profile-modal">
  <div class="modal">
    <h3>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
    <div class="profile-av-wrap">
      <div class="profile-av" id="upm-av" style="cursor:default;pointer-events:none;"></div>
      <div>
        <div class="profile-name-big" id="upm-name"></div>
        <div class="profile-nick" id="upm-nick"></div>
        <div class="profile-bio" id="upm-bio" style="margin-top:6px;"></div>
      </div>
    </div>
    <div class="invite-link-wrap" id="upm-link-wrap" style="display:none;">
      <span class="invite-link-text" id="upm-link"></span>
      <button class="copy-btn" onclick="copyUpmLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <!-- Add to group section -->
    <div id="upm-add-to-group-wrap" style="display:none;">
      <div class="modal-section">–î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É</div>
      <div id="upm-group-list" style="max-height:150px;overflow-y:auto;"></div>
    </div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('user-profile-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="modal-ok" id="upm-msg-btn">–ù–∞–ø–∏—Å–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- Group Info Modal -->
<div class="modal-overlay" id="group-info-modal">
  <div class="modal">
    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ</h3>
    <div class="profile-av-wrap">
      <div class="profile-av" id="gi-av" onclick="openGroupAvatarPicker()">
        <div class="profile-av-overlay" id="gi-av-overlay" style="display:none;">–∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</div>
      </div>
      <div style="text-align:center;">
        <div class="profile-name-big" id="gi-name"></div>
        <div class="profile-nick" id="gi-members-count"></div>
        <div class="profile-bio" id="gi-desc"></div>
      </div>
    </div>
    <div id="gi-admin-section" style="display:none;">
      <div class="modal-section">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–æ–π</div>
      <input class="auth-input" id="gi-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
      <textarea class="auth-input" id="gi-desc-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="3" style="resize:none;" maxlength="500"></textarea>
      <button class="modal-ok" onclick="saveGroupInfo()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div class="modal-section">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
    <div id="gi-members-list" style="max-height:220px;overflow-y:auto;"></div>
    <div id="gi-add-member-section" style="display:none;">
      <div class="modal-section">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</div>
      <div style="display:flex;gap:8px;">
        <input class="auth-input" id="gi-add-nick-input" placeholder="@username –∏–ª–∏ email" style="flex:1;">
        <button class="modal-ok" style="flex:0 0 auto;padding:10px 16px;" onclick="addMemberToGroup()">+</button>
      </div>
      <div class="auth-error" id="gi-add-err"></div>
    </div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('group-info-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="modal-ok" onclick="shareInvite()">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Group Avatar Modal -->
<div class="modal-overlay" id="group-avatar-modal">
  <div class="modal">
    <h3>–ê–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã</h3>
    <div class="photo-upload-area">
      <input type="file" id="group-avatar-file" accept="image/*" onchange="handleGroupAvatarFile(event)">
      <div class="photo-upload-text" id="group-photo-text">üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –≥—Ä—É–ø–ø—ã</div>
    </div>
    <div class="modal-section">–ò–ª–∏ —ç–º–æ–¥–∑–∏</div>
    <div class="av-color-grid" id="grav-color-grid"></div>
    <div style="font-size:.72rem;color:var(--muted);margin-top:6px;">–≠–º–æ–¥–∑–∏</div>
    <div class="av-emoji-grid" id="grav-emoji-grid"></div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('group-avatar-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-ok" onclick="saveGroupAvatar()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Forward Modal -->
<div class="modal-overlay" id="forward-modal">
  <div class="modal">
    <h3>–ü–µ—Ä–µ—Å–ª–∞—Ç—å –≤ —á–∞—Ç</h3>
    <p style="font-size:.78rem;color:var(--muted);font-family:'Space Mono',monospace;" id="fwd-msg-preview"></p>
    <div id="fwd-chat-list" style="max-height:280px;overflow-y:auto;display:flex;flex-direction:column;gap:4px;"></div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('forward-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-ok" onclick="doForward()">–ü–µ—Ä–µ—Å–ª–∞—Ç—å</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signOut, onAuthStateChanged, updateProfile, setPersistence, browserLocalPersistence,
  sendPasswordResetEmail
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import {
  getDatabase, ref, set, get, push, onValue, off, update, remove,
  query, orderByChild, limitToLast, equalTo
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDaMGT4kvbS5_sKhPQm7u5g30baMaPxYvw",
  authDomain: "wawe-23d7c.firebaseapp.com",
  databaseURL: "https://wawe-23d7c-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "wawe-23d7c",
  storageBucket: "wawe-23d7c.firebasestorage.app",
  messagingSenderId: "843038206524",
  appId: "1:843038206524:web:bbcbdd32fa7ca8890ef139"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
setPersistence(auth, browserLocalPersistence).catch(console.error);

const COLORS=['#7c3aed','#059669','#db2777','#0891b2','#d97706','#6366f1','#ef4444','#f97316','#14b8a6','#8b5cf6','#ec4899','#22c55e'];
const EMOJIS=['üòä','üî•','üíú','üëæ','üöÄ','üéØ','üåä','‚ö°','üé∏','ü¶ä','üê∫','üåô','üíé','üéÆ','ü¶ã','ü§ñ','üêâ','üå∫','üëë','üé≤','ü¶Ö','üåà'];
const EMOJI_CATS={
  'üòä':['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòã','üòõ','üòù','üòú','ü§™','üòé','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','üòà','üëø','üíÄ','‚ò†Ô∏è','üí©','ü§°','üëª','üëΩ','üëæ','ü§ñ'],
  'üëã':['üëã','ü§ö','üñê','‚úã','üññ','üëå','ü§å','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üëá','‚òùÔ∏è','üëç','üëé','‚úä','üëä','üëè','üôå','üôè','‚úçÔ∏è','üí™','ü¶æ'],
  '‚ù§Ô∏è':['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù§Ô∏è‚Äçüî•','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù'],
  'üéâ':['üéâ','üéä','üéà','üéÅ','üéÄ','üéó','üèÜ','ü•á','ü•à','ü•â','üé≠','üé®','üé≤','üß©','üéØ','üé≥'],
  'üê∂':['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','ü¶Ñ','ü¶ã','üêù','üêõ','üêå','üêû'],
  'üå∫':['üå∏','üíê','üåπ','üå∑','üå∫','üåª','üåº','üåø','üçÄ','üçÅ','üçÇ','üå±','üå≤','üå≥','üå¥','üåµ','üåä','üåà','‚õÖ','‚ùÑÔ∏è','‚õÑ','üî•','üíß','üåô','‚≠ê','üåü','‚ú®','‚ö°'],
  'üçï':['üçï','üçî','üåÆ','üåØ','ü•™','üç£','üç±','üçõ','üçú','üçù','ü•ò','üçû','ü•ê','üßÄ','ü•ö','üç≥','ü•û','ü•ì','üçó','üçñ','üçü','üç∞','üéÇ','üßÅ','üç≠','üç´','üç©','üç™','‚òï','üçµ','üç∫','ü•Ç','üç∑','üç∏','üçπ'],
  '‚öΩ':['‚öΩ','üèÄ','üèà','‚öæ','üéæ','üèê','üèâ','üé±','üèì','üè∏','‚õ≥','üéø','üõ∑','üéØ','üé≥'],
  'üöÄ':['üöÄ','üõ∏','‚úàÔ∏è','üöÇ','üöÑ','üöá','üöï','üöó','üöô','üõª','üöö','üöí','üöë','üöì','üèé','üèç','üõµ','üö≤','‚õΩ','üöß'],
  'üí°':['üí°','üî¶','üß±','üöø','üõÅ','üß¥','üßπ','üß∫','üßª','üßº','üõí','üö™','üîß','üî®','‚öôÔ∏è','üî©','üí£','‚öîÔ∏è','üõ°','üîÆ','üßø','üíà']
};

let CU=null, CUdata=null;
let currentChatId=null, chatsData={}, msgListener=null, chatsListener=null;
let pickerColor=COLORS[0], pickerEmoji=EMOJIS[0];
let gravPickerColor=COLORS[0], gravPickerEmoji=EMOJIS[0];
let currentEmojiCat=Object.keys(EMOJI_CATS)[0];
let avatarPendingData=null; // cropped base64
let groupAvatarPendingData=null;
let replyTo=null; // {key, senderName, text}
let ctxMsg=null;  // current context menu message
let fwdMsg=null;  // message being forwarded
let fwdSelectedChatId=null;
// Crop state
let cropImg=null, cropScale=1, cropBoxX=0, cropBoxY=0, cropBoxSize=180, cropRawData=null, cropTarget='user'; // 'user'|'group'

const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const setErr=(id,msg)=>{const e=document.getElementById(id);if(e)e.textContent=msg;};
const setBtn=(id,load,label)=>{const b=document.getElementById(id);if(!b)return;b.disabled=load;b.textContent=load?'‚è≥...':label;};
const toast=msg=>{const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);};
const fmt=ts=>new Date(ts).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
const fmtDate=ts=>new Date(ts).toLocaleDateString('ru-RU',{day:'numeric',month:'long'});
const strColor=str=>{let h=0;for(let c of str)h=c.charCodeAt(0)+((h<<5)-h);return COLORS[Math.abs(h)%COLORS.length];};

function avHTML(av,name,size=42,cls=''){
  const r=cls.includes('round')?'50%':'12px';
  if(av?.photoData) return `<div class="av ${cls}" style="width:${size}px;height:${size}px;min-width:${size}px;border-radius:${r};overflow:hidden;"><img src="${av.photoData}" style="width:100%;height:100%;object-fit:cover;"></div>`;
  const color=av?.color||strColor(name||'?');
  const emoji=av?.emoji;
  const letter=(name||'?')[0].toUpperCase();
  const fs=Math.round(size*(emoji?.5:.38));
  return `<div class="av ${cls}" style="width:${size}px;height:${size}px;min-width:${size}px;background:${color};font-size:${fs}px;font-weight:700;color:#fff;border-radius:${r};">${emoji||letter}</div>`;
}
function renderAvInEl(el,av,name,size=42){
  const color=av?.color||strColor(name||'?');
  const emoji=av?.emoji;
  const letter=(name||'?')[0].toUpperCase();
  el.style.cssText+=`;width:${size}px;height:${size}px;min-width:${size}px;color:#fff;font-weight:700;`;
  if(av?.photoData){
    el.textContent='';el.style.background='transparent';
    let img=el.querySelector('img');
    if(!img){img=document.createElement('img');img.style='width:100%;height:100%;object-fit:cover;';el.appendChild(img);}
    img.src=av.photoData;
  } else {
    const img=el.querySelector('img');if(img)img.remove();
    el.style.background=color;
    el.style.fontSize=Math.round(size*(emoji?.45:.38))+'px';
    el.textContent=emoji||letter;
  }
}
function updateMyAvBtn(){
  const btn=document.getElementById('my-av-btn');if(!btn||!CUdata)return;
  const av=CUdata.avatar;const name=CUdata.name||'?';
  if(av?.photoData){btn.textContent='';btn.style.background='transparent';let img=btn.querySelector('img');if(!img){img=document.createElement('img');img.style='width:100%;height:100%;object-fit:cover;border-radius:8px;';btn.appendChild(img);}img.src=av.photoData;}
  else{const img=btn.querySelector('img');if(img)img.remove();btn.style.background=av?.color||strColor(name);btn.style.fontSize=av?.emoji?'1rem':'.85rem';btn.textContent=av?.emoji||name[0].toUpperCase();}
}
function isAdmin(chat,uid){if(!chat)return false;if(chat.createdBy===uid)return true;return!!(chat.admins&&chat.admins[uid]);}

// ‚îÄ AUTH ‚îÄ
window.toggleAuth=showReg=>{
  document.getElementById('login-box').style.display=showReg?'none':'flex';
  document.getElementById('reg-box').style.display=showReg?'flex':'none';
  setErr('login-error','');setErr('reg-error','');
};
window.doRegister=async()=>{
  const name=document.getElementById('reg-name').value.trim();
  const nick=document.getElementById('reg-nick').value.trim().replace(/^@/,'');
  const email=document.getElementById('reg-email').value.trim();
  const pass=document.getElementById('reg-pass').value;
  setErr('reg-error','');
  if(!name){setErr('reg-error','‚úó –í–≤–µ–¥–∏—Ç–µ –∏–º—è');return;}
  if(!nick||nick.length<3){setErr('reg-error','‚úó Username –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');return;}
  if(!/^[a-zA-Z0-9_]+$/.test(nick)){setErr('reg-error','‚úó –¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _');return;}
  if(!email){setErr('reg-error','‚úó –í–≤–µ–¥–∏—Ç–µ email');return;}
  if(pass.length<6){setErr('reg-error','‚úó –ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');return;}
  setBtn('reg-btn',true,'–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí');
  try{
    const ns=await get(query(ref(db,'users'),orderByChild('nickLower'),equalTo(nick.toLowerCase())));
    if(ns.exists()){setErr('reg-error','‚úó @'+nick+' —É–∂–µ –∑–∞–Ω—è—Ç');setBtn('reg-btn',false,'–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí');return;}
    const cred=await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(cred.user,{displayName:name});
    const av={color:COLORS[Math.floor(Math.random()*COLORS.length)],emoji:EMOJIS[Math.floor(Math.random()*EMOJIS.length)]};
    await set(ref(db,`users/${cred.user.uid}`),{uid:cred.user.uid,name,nick,nickLower:nick.toLowerCase(),email,bio:'',createdAt:Date.now(),avatar:av});
  }catch(e){setErr('reg-error','‚úó '+xlate(e.code));setBtn('reg-btn',false,'–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí');}
};
window.doLogin=async()=>{
  const login=document.getElementById('login-id').value.trim().replace(/^@/,'');
  const pass=document.getElementById('login-pass').value;
  setErr('login-error','');
  if(!login){setErr('login-error','‚úó –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω');return;}
  if(!pass){setErr('login-error','‚úó –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');return;}
  setBtn('login-btn',true,'–í–æ–π—Ç–∏ ‚Üí');
  try{
    let email=login;
    if(!login.includes('@')||/\s/.test(login)){
      const snap=await get(query(ref(db,'users'),orderByChild('nickLower'),equalTo(login.toLowerCase())));
      if(!snap.exists()){setErr('login-error','‚úó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');setBtn('login-btn',false,'–í–æ–π—Ç–∏ ‚Üí');return;}
      snap.forEach(c=>{email=c.val().email;});
    }
    await signInWithEmailAndPassword(auth,email,pass);
  }catch(e){setErr('login-error','‚úó '+xlate(e.code));setBtn('login-btn',false,'–í–æ–π—Ç–∏ ‚Üí');}
};
window.doLogout=async()=>{
  if(msgListener&&currentChatId)off(ref(db,`chats/${currentChatId}/messages`));
  if(chatsListener)off(ref(db,`userChats/${CU?.uid}`));
  currentChatId=null;chatsData={};CUdata=null;
  await signOut(auth);
};

onAuthStateChanged(auth,async user=>{
  if(user){
    CU=user;
    const snap=await get(ref(db,`users/${user.uid}`));
    CUdata=snap.exists()?snap.val():{name:user.displayName||'?',nick:'',avatar:null,bio:''};
    document.getElementById('auth-screen').style.display='none';
    document.getElementById('app-screen').classList.add('visible');
    setBtn('login-btn',false,'–í–æ–π—Ç–∏ ‚Üí');setBtn('reg-btn',false,'–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí');
    updateMyAvBtn();checkInviteParam();loadChats();initEmojiPicker();
  }else{
    CU=null;CUdata=null;
    document.getElementById('auth-screen').style.display='flex';
    document.getElementById('app-screen').classList.remove('visible');
    document.getElementById('chat-list').innerHTML='';
    document.getElementById('messages').innerHTML='';
    showEmpty();
  }
});

// ‚îÄ TABS ‚îÄ
window.switchTab=tab=>{
  ['chats','search','favs'].forEach(t=>{
    document.getElementById('tab-'+t).classList.toggle('active',t===tab);
    document.getElementById('pane-'+t).style.display=t===tab?'flex':'none';
  });
  if(tab==='search')document.getElementById('user-search-input').focus();
  if(tab==='favs')renderFavorites();
};
// Fix display for chats pane which is flex-column
document.getElementById('pane-chats').style.display='flex';
document.getElementById('pane-search').style.display='none';
document.getElementById('pane-favs').style.display='none';

// ‚îÄ USER SEARCH ‚îÄ
let searchTimer=null;
window.searchUsers=val=>{
  clearTimeout(searchTimer);
  const q=val.trim().replace(/^@/,'');
  const res=document.getElementById('user-search-results');
  if(!q){res.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--muted);font-family:\'Space Mono\',monospace;">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ @–Ω–∏–∫</div>';return;}
  res.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--muted);">–ò—â—É...</div>';
  searchTimer=setTimeout(async()=>{
    try{
      const snap=await get(ref(db,'users'));
      const ql=q.toLowerCase();
      const found=[];
      snap.forEach(c=>{const u=c.val();if(u.uid!==CU?.uid&&(u.nickLower?.includes(ql)||u.name?.toLowerCase().includes(ql)))found.push(u);});
      res.innerHTML='';
      if(!found.length){res.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--muted);">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';return;}
      found.forEach(u=>{
        const div=document.createElement('div');div.className='user-item';
        div.innerHTML=`${avHTML(u.avatar,u.name,40)}<div class="user-item-info"><div class="user-item-name">${esc(u.name)}</div><div class="user-item-nick">@${esc(u.nick||u.nickLower||'')}</div></div><button class="user-item-btn">–ü—Ä–æ—Ñ–∏–ª—å</button>`;
        div.querySelector('button').onclick=()=>showUserModal(u);
        res.appendChild(div);
      });
    }catch(e){res.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--danger);">–û—à–∏–±–∫–∞</div>';}
  },400);
};

// ‚îÄ CHATS ‚îÄ
function loadChats(){
  chatsListener=onValue(ref(db,`userChats/${CU.uid}`),async snap=>{
    const ids=Object.keys(snap.val()||{});
    if(!ids.length){renderChatList({});return;}
    const results=await Promise.all(ids.map(id=>get(ref(db,`chats/${id}`))));
    chatsData={};
    results.forEach(r=>{if(r.exists())chatsData[r.key]=r.val();});
    ids.forEach(id=>{
      onValue(query(ref(db,`chats/${id}/messages`),orderByChild('ts'),limitToLast(1)),s=>{
        const v=s.val();
        if(v&&chatsData[id])chatsData[id].lastMsg=Object.values(v)[0];
        renderChatList(chatsData);
      });
    });
  });
}
function renderChatList(data){
  const list=document.getElementById('chat-list');
  const q=(document.getElementById('chat-search').value||'').toLowerCase();
  const favChats=getFavChats();
  const sorted=Object.entries(data)
    .filter(([,c])=>chatName(c).toLowerCase().includes(q))
    .sort(([ia,a],[ib,b])=>{
      const fa=favChats.has(ia)?1:0,fb=favChats.has(ib)?1:0;
      if(fa!==fb)return fb-fa;
      return (b.lastMsg?.ts||b.createdAt||0)-(a.lastMsg?.ts||a.createdAt||0);
    });
  list.innerHTML='';
  if(!sorted.length){list.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--muted);font-family:\'Space Mono\',monospace;">–ù–µ—Ç —á–∞—Ç–æ–≤</div>';return;}
  sorted.forEach(([id,c])=>{
    const name=chatName(c);const av=chatAv(c);const isFav=favChats.has(id);
    const item=document.createElement('div');
    item.className='chat-item'+(id===currentChatId?' active':'');
    item.dataset.chatId=id;
    let preview=c.lastMsg?.text||'...';
    if(c.lastMsg?.forwarded)preview='‚Ü™ '+preview;
    if(c.lastMsg?.replyTo)preview='‚Ü© '+preview;
    item.innerHTML=`${avHTML(av,name,42,c.type==='group'?'round':'')}
      <div class="chat-info"><div class="chat-name">${esc(name)}</div><div class="chat-preview">${esc(preview.substring(0,38))}</div></div>
      <div class="chat-meta"><span class="chat-time">${c.lastMsg?.ts?fmt(c.lastMsg.ts):''}</span></div>
      ${isFav?'<span class="chat-item-fav">‚òÖ</span>':''}`;
    item.onclick=()=>openChat(id,c);
    list.appendChild(item);
  });
}
window.filterChats=()=>renderChatList(chatsData);

function chatName(c){
  if(c.type==='group')return c.name||'–ì—Ä—É–ø–ø–∞';
  if(c.names){const o=Object.entries(c.names).find(([uid])=>uid!==CU?.uid);return o?o[1]:'–ß–∞—Ç';}
  return '–ß–∞—Ç';
}
function chatAv(c){
  if(c.type==='group')return c.avatar||{color:'#7c3aed',emoji:'üë•'};
  if(c.avatars){const o=Object.entries(c.avatars).find(([uid])=>uid!==CU?.uid);return o?o[1]:null;}
  return null;
}

// ‚îÄ FAVORITES (chat-level) stored in localStorage ‚îÄ
function getFavChats(){return new Set(JSON.parse(localStorage.getItem('wave_fav_chats')||'[]'));}
function setFavChats(s){localStorage.setItem('wave_fav_chats',JSON.stringify([...s]));}
window.toggleChatFavorite=()=>{
  if(!currentChatId)return;
  const favs=getFavChats();
  const isFav=favs.has(currentChatId);
  if(isFav)favs.delete(currentChatId);else favs.add(currentChatId);
  setFavChats(favs);
  updateFavTopbarBtn();
  renderChatList(chatsData);
  toast(isFav?'–£–±—Ä–∞–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ':'‚òÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
};
function updateFavTopbarBtn(){
  const btn=document.getElementById('fav-topbar-btn');
  if(!btn||!currentChatId)return;
  btn.textContent=getFavChats().has(currentChatId)?'‚òÖ':'‚òÜ';
  btn.style.color=getFavChats().has(currentChatId)?'var(--accent2)':'var(--muted)';
}

// ‚îÄ FAVORITES (messages) stored in localStorage ‚îÄ
function getFavMsgs(){return JSON.parse(localStorage.getItem('wave_fav_msgs')||'[]');}
function saveFavMsg(msg,chatId){
  const favs=getFavMsgs();
  const key=chatId+'_'+msg._key;
  if(favs.find(f=>f._fkey===key))return false;
  favs.unshift({...msg,_fkey:key,_chatId:chatId,_savedAt:Date.now()});
  localStorage.setItem('wave_fav_msgs',JSON.stringify(favs.slice(0,100)));
  return true;
}
function removeFavMsg(fkey){
  const favs=getFavMsgs().filter(f=>f._fkey!==fkey);
  localStorage.setItem('wave_fav_msgs',JSON.stringify(favs));
}
function renderFavorites(){
  const list=document.getElementById('favs-list');
  const favs=getFavMsgs();
  if(!favs.length){list.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--muted);font-family:\'Space Mono\',monospace;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</div>';return;}
  list.innerHTML='';
  favs.forEach(msg=>{
    const chatData=chatsData[msg._chatId];
    const chatLabel=chatData?chatName(chatData):'–ß–∞—Ç';
    const item=document.createElement('div');item.className='fav-msg-item';
    item.innerHTML=`<div class="fav-msg-meta">${esc(chatLabel)} ¬∑ ${esc(msg.senderName||'?')} ¬∑ ${fmt(msg.ts)}</div><div class="fav-msg-text">${esc(msg.text||'')}</div>
      <div class="fav-msg-actions">
        <button class="fav-action-btn" onclick="fwdFromFav(${JSON.stringify(msg._fkey)})">‚Ü™ –ü–µ—Ä–µ—Å–ª–∞—Ç—å</button>
        <button class="fav-action-btn danger" onclick="removeFavAndRender(${JSON.stringify(msg._fkey)})">‚úï –£–±—Ä–∞—Ç—å</button>
      </div>`;
    list.appendChild(item);
  });
}
window.removeFavAndRender=fkey=>{removeFavMsg(fkey);renderFavorites();toast('–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');};
window.fwdFromFav=fkey=>{
  const msg=getFavMsgs().find(f=>f._fkey===fkey);
  if(!msg)return;
  openForwardModal(msg);
};

// ‚îÄ OPEN CHAT ‚îÄ
window.openChat=(chatId,chat)=>{
  if(msgListener&&currentChatId)off(ref(db,`chats/${currentChatId}/messages`));
  currentChatId=chatId;
  cancelReply();
  document.getElementById('sidebar').classList.add('hidden');
  document.getElementById('chat-area').classList.add('visible');
  document.getElementById('empty-placeholder').style.display='none';
  document.getElementById('active-chat').style.display='flex';
  const name=chatName(chat);
  document.getElementById('topbar-name').textContent=name;
  const tav=document.getElementById('topbar-av');
  tav.className='av'+(chat.type==='group'?' round':'');
  renderAvInEl(tav,chatAv(chat),name,40);
  document.getElementById('topbar-status').textContent=chat.type==='group'?`${Object.keys(chat.members||{}).length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`:'–æ–Ω–ª–∞–π–Ω';
  document.querySelectorAll('.chat-item').forEach(el=>el.classList.toggle('active',el.dataset.chatId===chatId));
  updateFavTopbarBtn();
  loadMessages(chatId);
};
window.goBack=()=>{document.getElementById('sidebar').classList.remove('hidden');document.getElementById('chat-area').classList.remove('visible');};

function loadMessages(chatId){
  const el=document.getElementById('messages');el.innerHTML='';
  msgListener=onValue(query(ref(db,`chats/${chatId}/messages`),orderByChild('ts'),limitToLast(100)),s=>renderMessages(s.val()||{}));
}

function renderMessages(data){
  const el=document.getElementById('messages');
  const atBot=el.scrollHeight-el.scrollTop<=el.clientHeight+80;
  el.innerHTML='';
  const chat=chatsData[currentChatId]||{};
  const msgs=Object.entries(data).map(([k,v])=>({...v,_key:k})).sort((a,b)=>a.ts-b.ts);
  let lastDate=null;
  msgs.forEach(msg=>{
    const ds=fmtDate(msg.ts);
    if(ds!==lastDate){const d=document.createElement('div');d.className='date-divider';d.innerHTML=`<span>${ds}</span>`;el.appendChild(d);lastDate=ds;}
    const sent=msg.uid===CU.uid;
    const canDelete=sent||isAdmin(chat,CU.uid);
    const g=document.createElement('div');g.className='msg-group '+(sent?'sent':'recv');

    if(!sent){const s=document.createElement('div');s.className='msg-sender';s.textContent=msg.senderName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';s.onclick=()=>openUserById(msg.uid);g.appendChild(s);}

    const b=document.createElement('div');b.className='msg-bubble';

    // Forward label
    if(msg.forwarded){const fl=document.createElement('div');fl.className='fwd-label';fl.textContent='‚Ü™ –ü–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–µ –æ—Ç '+esc(msg.originalSender||'?');b.appendChild(fl);}

    // Reply preview
    if(msg.replyTo){
      const rp=document.createElement('div');rp.className='reply-preview';
      rp.innerHTML=`<div class="reply-preview-name">${esc(msg.replyTo.senderName||'?')}</div><div class="reply-preview-text">${esc(msg.replyTo.text||'')}</div>`;
      rp.onclick=e=>{e.stopPropagation();scrollToMsg(msg.replyTo.key);};
      b.appendChild(rp);
    }

    const textNode=document.createElement('div');textNode.textContent=msg.text||'';b.appendChild(textNode);

    // Click to open context menu
    b.addEventListener('click',e=>{e.stopPropagation();openCtxMenu(e,msg,canDelete,chat);});
    g.appendChild(b);

    const t=document.createElement('div');t.className='msg-time';t.textContent=fmt(msg.ts);g.appendChild(t);

    // Reactions (show only if there are some)
    const reactions=msg.reactions||{};
    const hasReactions=Object.values(reactions).some(users=>Object.keys(users).length>0);
    if(hasReactions){
      const rw=document.createElement('div');rw.className='msg-reactions';
      ['thumbs_up','heart','thumbs_down'].forEach(rKey=>{
        const emojiMap={'thumbs_up':'üëç','heart':'‚ù§Ô∏è','thumbs_down':'üëé'};
        const users=reactions[rKey]||{};
        const count=Object.keys(users).length;
        if(count>0){
          const pill=document.createElement('div');
          pill.className='reaction-pill'+(users[CU.uid]?' mine':'');
          pill.innerHTML=`${emojiMap[rKey]} <span class="reaction-count">${count}</span>`;
          pill.title=Object.values(users).join(', ');
          pill.onclick=e=>{e.stopPropagation();toggleReaction(msg._key,rKey,users);};
          rw.appendChild(pill);
        }
      });
      g.appendChild(rw);
    }

    g.dataset.msgKey=msg._key;
    el.appendChild(g);
  });
  if(atBot||msgs.length<=20)el.scrollTop=el.scrollHeight;
}

function scrollToMsg(key){
  const el=document.querySelector(`[data-msg-key="${key}"]`);
  if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.outline='2px solid var(--accent2)';setTimeout(()=>el.style.outline='',1500);}
}

// ‚îÄ CONTEXT MENU ‚îÄ
function openCtxMenu(e,msg,canDelete,chat){
  ctxMsg=msg;
  const menu=document.getElementById('ctx-menu');
  // Reactions row
  const rr=document.getElementById('ctx-reactions');rr.innerHTML='';
  const emojiMap={'thumbs_up':'üëç','heart':'‚ù§Ô∏è','thumbs_down':'üëé'};
  Object.entries(emojiMap).forEach(([rKey,emoji])=>{
    const users=(msg.reactions||{})[rKey]||{};
    const btn=document.createElement('button');btn.className='ctx-react-btn'+(users[CU.uid]?' active':'');
    btn.textContent=emoji;
    btn.onclick=()=>{toggleReaction(msg._key,rKey,users);menu.classList.remove('show');};
    rr.appendChild(btn);
  });
  // Reply
  document.getElementById('ctx-reply').onclick=()=>{setReplyTo(msg);menu.classList.remove('show');};
  // Forward
  document.getElementById('ctx-forward').onclick=()=>{openForwardModal(msg);menu.classList.remove('show');};
  // Favorite
  document.getElementById('ctx-favorite').onclick=()=>{
    const ok=saveFavMsg(msg,currentChatId);
    toast(ok?'‚≠ê –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ':'–£–∂–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º');
    menu.classList.remove('show');
  };
  // Copy
  document.getElementById('ctx-copy').onclick=()=>{navigator.clipboard.writeText(msg.text||'').then(()=>toast('‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'));menu.classList.remove('show');};
  // Delete
  const delEl=document.getElementById('ctx-delete');
  delEl.style.display=canDelete?'flex':'none';
  delEl.onclick=()=>{deleteMessage(msg._key);menu.classList.remove('show');};

  // Position
  const vw=window.innerWidth,vh=window.innerHeight;
  let x=e.clientX,y=e.clientY;
  menu.classList.add('show');
  const mw=menu.offsetWidth,mh=menu.offsetHeight;
  if(x+mw>vw-10)x=vw-mw-10;
  if(y+mh>vh-10)y=vh-mh-10;
  menu.style.left=x+'px';menu.style.top=y+'px';
}
document.addEventListener('click',()=>document.getElementById('ctx-menu').classList.remove('show'));
document.addEventListener('keydown',e=>{if(e.key==='Escape'){document.getElementById('ctx-menu').classList.remove('show');cancelReply();}});

// ‚îÄ REACTIONS ‚îÄ
const REACTION_EMOJI_MAP={'thumbs_up':'üëç','heart':'‚ù§Ô∏è','thumbs_down':'üëé'};
async function toggleReaction(msgKey,reactionKey,currentUsers){
  if(!currentChatId)return;
  const path=`chats/${currentChatId}/messages/${msgKey}/reactions/${reactionKey}`;
  const name=CUdata?.name||CU.displayName||'?';
  if(currentUsers[CU.uid])await remove(ref(db,`${path}/${CU.uid}`));
  else await set(ref(db,`${path}/${CU.uid}`),name);
}
async function deleteMessage(msgKey){
  if(!currentChatId)return;
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?'))return;
  await remove(ref(db,`chats/${currentChatId}/messages/${msgKey}`));
  toast('‚úì –£–¥–∞–ª–µ–Ω–æ');
}

// ‚îÄ REPLY ‚îÄ
function setReplyTo(msg){
  replyTo={key:msg._key,senderName:msg.senderName||'?',text:msg.text||''};
  document.getElementById('reply-bar-name').textContent=replyTo.senderName;
  document.getElementById('reply-bar-text').textContent=replyTo.text;
  document.getElementById('reply-bar').classList.add('show');
  document.getElementById('msg-input').focus();
}
window.cancelReply=()=>{replyTo=null;document.getElementById('reply-bar').classList.remove('show');};

// ‚îÄ FORWARD ‚îÄ
function openForwardModal(msg){
  fwdMsg=msg;fwdSelectedChatId=null;
  document.getElementById('fwd-msg-preview').textContent='¬´'+((msg.text||'').substring(0,60))+'¬ª';
  const list=document.getElementById('fwd-chat-list');list.innerHTML='';
  Object.entries(chatsData).forEach(([id,c])=>{
    const item=document.createElement('div');item.className='fwd-chat-item';
    item.innerHTML=`${avHTML(chatAv(c),chatName(c),36,c.type==='group'?'round':'')}<div><div class="fwd-chat-name">${esc(chatName(c))}</div><div class="fwd-chat-type">${c.type==='group'?'–ì—Ä—É–ø–ø–∞':'–õ–∏—á–Ω—ã–π'}</div></div>`;
    item.onclick=()=>{
      list.querySelectorAll('.fwd-chat-item').forEach(el=>el.classList.remove('sel'));
      item.classList.add('sel');fwdSelectedChatId=id;
    };
    list.appendChild(item);
  });
  document.getElementById('forward-modal').classList.add('open');
}
window.doForward=async()=>{
  if(!fwdMsg||!fwdSelectedChatId){toast('‚úó –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç');return;}
  const senderName=CUdata?.name||CU.displayName||CU.email||'?';
  const originalSender=fwdMsg.senderName||'?';
  await push(ref(db,`chats/${fwdSelectedChatId}/messages`),{
    text:fwdMsg.text,uid:CU.uid,senderName,ts:Date.now(),
    forwarded:true,originalSender
  });
  await update(ref(db,`chats/${fwdSelectedChatId}`),{lastMsgTs:Date.now()});
  closeModal('forward-modal');
  toast('‚úì –°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ');
};

// ‚îÄ SEND ‚îÄ
window.sendMessage=async()=>{
  const inp=document.getElementById('msg-input');
  const text=inp.value.trim();
  if(!text||!currentChatId)return;
  inp.value='';inp.style.height='auto';
  const senderName=CUdata?.name||CU.displayName||CU.email||'?';
  const msgData={text,uid:CU.uid,senderName,ts:Date.now()};
  if(replyTo)msgData.replyTo=replyTo;
  cancelReply();
  await push(ref(db,`chats/${currentChatId}/messages`),msgData);
  await update(ref(db,`chats/${currentChatId}`),{lastMsgTs:Date.now()});
};
window.handleKey=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}};
window.autoResize=el=>{el.style.height='auto';el.style.height=Math.min(el.scrollHeight,110)+'px';};

// ‚îÄ EMOJI PICKER ‚îÄ
function initEmojiPicker(){
  const tabsEl=document.getElementById('emoji-cat-tabs');tabsEl.innerHTML='';
  Object.keys(EMOJI_CATS).forEach((cat,i)=>{
    const btn=document.createElement('button');btn.className='emoji-cat-tab'+(i===0?' active':'');
    btn.textContent=cat;btn.title=cat;
    btn.onclick=()=>{
      currentEmojiCat=cat;
      tabsEl.querySelectorAll('.emoji-cat-tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');renderEmojiGrid(EMOJI_CATS[cat]);
      document.getElementById('emoji-search').value='';
    };
    tabsEl.appendChild(btn);
  });
  renderEmojiGrid(EMOJI_CATS[currentEmojiCat]);
}
function renderEmojiGrid(emojis){
  const grid=document.getElementById('emoji-grid');grid.innerHTML='';
  emojis.forEach(e=>{const btn=document.createElement('button');btn.className='emoji-cell';btn.textContent=e;btn.onclick=()=>insertEmojiChar(e);grid.appendChild(btn);});
}
window.filterEmojis=val=>{
  if(!val){renderEmojiGrid(EMOJI_CATS[currentEmojiCat]);return;}
  const all=[].concat(...Object.values(EMOJI_CATS));renderEmojiGrid(all);
};
function insertEmojiChar(e){
  const inp=document.getElementById('msg-input');const pos=inp.selectionStart;
  inp.value=inp.value.slice(0,pos)+e+inp.value.slice(inp.selectionEnd);
  inp.focus();inp.selectionStart=inp.selectionEnd=pos+e.length;autoResize(inp);
}
window.toggleEmojiPicker=e=>{e.stopPropagation();const p=document.getElementById('emoji-picker');p.classList.toggle('open');if(p.classList.contains('open'))document.getElementById('emoji-search').focus();};
document.addEventListener('click',e=>{const p=document.getElementById('emoji-picker');if(p&&p.classList.contains('open')&&!p.contains(e.target)&&!e.target.closest('.emoji-btn'))p.classList.remove('open');});

// ‚îÄ NEW CHAT ‚îÄ
window.openNewChatModal=()=>{
  document.getElementById('new-chat-modal').classList.add('open');
  document.getElementById('new-chat-input').value='';
  document.getElementById('group-desc-input').value='';
  document.getElementById('group-desc-wrap').style.display='none';
  setErr('new-chat-err','');
  document.getElementById('is-group').checked=false;
};
window.closeModal=id=>document.getElementById(id).classList.remove('open');
document.getElementById('is-group').addEventListener('change',e=>{
  document.getElementById('group-desc-wrap').style.display=e.target.checked?'block':'none';
});
window.createChat=async()=>{
  const val=document.getElementById('new-chat-input').value.trim().replace(/^@/,'');
  const isGroup=document.getElementById('is-group').checked;
  const groupDesc=document.getElementById('group-desc-input').value.trim();
  setErr('new-chat-err','');
  if(!val){setErr('new-chat-err','‚úó –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');return;}
  if(isGroup){
    const r=push(ref(db,'chats'));
    await set(r,{type:'group',name:val,description:groupDesc,members:{[CU.uid]:true},admins:{[CU.uid]:true},avatar:{color:COLORS[Math.floor(Math.random()*COLORS.length)],emoji:'üë•'},createdBy:CU.uid,createdAt:Date.now()});
    await set(ref(db,`userChats/${CU.uid}/${r.key}`),true);
    closeModal('new-chat-modal');
  }else{
    const u=await findUser(val);
    if(!u){setErr('new-chat-err','‚úó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');return;}
    if(u.uid===CU.uid){setErr('new-chat-err','‚úó –ù–µ–ª—å–∑—è —á–∞—Ç —Å —Å–æ–±–æ–π');return;}
    const ex=Object.entries(chatsData).find(([,c])=>c.type==='direct'&&c.members?.[CU.uid]&&c.members?.[u.uid]);
    if(ex){closeModal('new-chat-modal');openChat(ex[0],ex[1]);return;}
    const r=push(ref(db,'chats'));
    await set(r,{type:'direct',members:{[CU.uid]:true,[u.uid]:true},names:{[CU.uid]:CUdata?.name||CU.displayName,[u.uid]:u.name},avatars:{[CU.uid]:CUdata?.avatar||null,[u.uid]:u.avatar||null},createdAt:Date.now()});
    await set(ref(db,`userChats/${CU.uid}/${r.key}`),true);
    await set(ref(db,`userChats/${u.uid}/${r.key}`),true);
    closeModal('new-chat-modal');
  }
};
async function findUser(q){
  const snap=await get(ref(db,'users'));if(!snap.exists())return null;
  let found=null;
  snap.forEach(c=>{const u=c.val();if(u.email===q||u.nickLower===q.toLowerCase()||u.nick===q)found=u;});
  return found;
}

// ‚îÄ MY PROFILE ‚îÄ
window.openMyProfile=()=>{
  if(!CUdata)return;
  document.getElementById('my-profile-name').textContent=CUdata.name||'?';
  document.getElementById('my-profile-nick').textContent='@'+(CUdata.nick||'–Ω–µ—Ç username');
  document.getElementById('my-profile-name-input').value=CUdata.name||'';
  document.getElementById('my-profile-nick-input').value=CUdata.nick||'';
  document.getElementById('my-profile-bio-input').value=CUdata.bio||'';
  setErr('profile-save-err','');
  renderAvInEl(document.getElementById('my-profile-av'),CUdata.avatar,CUdata.name,88);
  const nick=CUdata.nick||'';
  document.getElementById('my-invite-link').textContent=nick?location.origin+location.pathname+'?adduser='+nick:'(–Ω–µ—Ç @username)';
  document.getElementById('my-profile-modal').classList.add('open');
};
window.copyMyLink=()=>{const t=document.getElementById('my-invite-link').textContent;if(t.startsWith('http'))navigator.clipboard.writeText(t).then(()=>toast('‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'));};
window.saveProfile=async()=>{
  const newName=document.getElementById('my-profile-name-input').value.trim();
  const newNick=document.getElementById('my-profile-nick-input').value.trim().replace(/^@/,'');
  const newBio=document.getElementById('my-profile-bio-input').value.trim();
  setErr('profile-save-err','');
  if(!newName){setErr('profile-save-err','‚úó –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');return;}
  if(newNick&&newNick.length<3){setErr('profile-save-err','‚úó Username –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');return;}
  if(newNick&&!/^[a-zA-Z0-9_]+$/.test(newNick)){setErr('profile-save-err','‚úó –¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _');return;}
  if(newNick&&newNick.toLowerCase()!==(CUdata.nick||'').toLowerCase()){
    const ns=await get(query(ref(db,'users'),orderByChild('nickLower'),equalTo(newNick.toLowerCase())));
    if(ns.exists()){setErr('profile-save-err','‚úó @'+newNick+' —É–∂–µ –∑–∞–Ω—è—Ç');return;}
    if(CUdata.nick)await remove(ref(db,`nickIndex/${CUdata.nick.toLowerCase()}`));
    await set(ref(db,`nickIndex/${newNick.toLowerCase()}`),CU.uid);
  }
  await updateProfile(CU,{displayName:newName});
  const updates={name:newName,bio:newBio};
  if(newNick){updates.nick=newNick;updates.nickLower=newNick.toLowerCase();}
  await update(ref(db,`users/${CU.uid}`),updates);
  Object.assign(CUdata,updates);
  document.getElementById('my-profile-name').textContent=newName;
  document.getElementById('my-profile-nick').textContent='@'+(newNick||CUdata.nick||'–Ω–µ—Ç username');
  const nickFinal=newNick||CUdata.nick||'';
  document.getElementById('my-invite-link').textContent=nickFinal?location.origin+location.pathname+'?adduser='+nickFinal:'(–Ω–µ—Ç @username)';
  updateMyAvBtn();toast('‚úì –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
};
window.sendPasswordReset=async()=>{
  if(!CU?.email){toast('‚úó Email –Ω–µ –Ω–∞–π–¥–µ–Ω');return;}
  try{await sendPasswordResetEmail(auth,CU.email);toast('‚úì –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ '+CU.email);}
  catch(e){toast('‚úó '+xlate(e.code));}
};

// ‚îÄ AVATAR PICKER ‚îÄ
window.openAvatarPicker=()=>{
  avatarPendingData=null;
  document.getElementById('avatar-upload-text').textContent='üì∑ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏';
  document.getElementById('avatar-file-input').value='';
  const cg=document.getElementById('av-color-grid');cg.innerHTML='';
  COLORS.forEach(c=>{const d=document.createElement('div');d.className='av-color'+(c===pickerColor?' sel':'');d.style.background=c;d.onclick=()=>{pickerColor=c;cg.querySelectorAll('.av-color').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');avatarPendingData=null;};cg.appendChild(d);});
  const eg=document.getElementById('av-emoji-grid');eg.innerHTML='';
  EMOJIS.forEach(e=>{const d=document.createElement('div');d.className='av-emoji'+(e===pickerEmoji?' sel':'');d.textContent=e;d.onclick=()=>{pickerEmoji=e;eg.querySelectorAll('.av-emoji').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');avatarPendingData=null;};eg.appendChild(d);});
  document.getElementById('avatar-modal').classList.add('open');
};
window.handleAvatarFile=e=>{
  const file=e.target.files[0];if(!file)return;
  if(file.size>5*1024*1024){toast('‚úó –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 5–ú–ë)');return;}
  cropTarget='user';
  openCropModal(file);
};
window.saveAvatar=async()=>{
  let av;
  if(avatarPendingData)av={photoData:avatarPendingData};
  else av={color:pickerColor,emoji:pickerEmoji};
  await update(ref(db,`users/${CU.uid}`),{avatar:av});
  CUdata.avatar=av;updateMyAvBtn();
  renderAvInEl(document.getElementById('my-profile-av'),av,CUdata.name,88);
  closeModal('avatar-modal');toast('‚úì –ê–≤–∞—Ç–∞—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
};

// ‚îÄ GROUP AVATAR ‚îÄ
window.openGroupAvatarPicker=()=>{
  if(!currentChatId)return;
  const chat=chatsData[currentChatId];
  if(!isAdmin(chat,CU.uid)){toast('‚úó –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã');return;}
  groupAvatarPendingData=null;
  document.getElementById('group-photo-text').textContent='üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –≥—Ä—É–ø–ø—ã';
  document.getElementById('group-avatar-file').value='';
  gravPickerColor=COLORS[0];gravPickerEmoji=EMOJIS[0];
  const cg=document.getElementById('grav-color-grid');cg.innerHTML='';
  COLORS.forEach(c=>{const d=document.createElement('div');d.className='av-color'+(c===gravPickerColor?' sel':'');d.style.background=c;d.onclick=()=>{gravPickerColor=c;cg.querySelectorAll('.av-color').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');};cg.appendChild(d);});
  const eg=document.getElementById('grav-emoji-grid');eg.innerHTML='';
  EMOJIS.forEach(e=>{const d=document.createElement('div');d.className='av-emoji'+(e===gravPickerEmoji?' sel':'');d.textContent=e;d.onclick=()=>{gravPickerEmoji=e;eg.querySelectorAll('.av-emoji').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');};eg.appendChild(d);});
  document.getElementById('group-avatar-modal').classList.add('open');
};
window.handleGroupAvatarFile=e=>{
  const file=e.target.files[0];if(!file)return;
  if(file.size>5*1024*1024){toast('‚úó –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π');return;}
  cropTarget='group';openCropModal(file);
};
window.saveGroupAvatar=async()=>{
  if(!currentChatId)return;
  let av;
  if(groupAvatarPendingData)av={photoData:groupAvatarPendingData};
  else av={color:gravPickerColor,emoji:gravPickerEmoji};
  await update(ref(db,`chats/${currentChatId}`),{avatar:av});
  chatsData[currentChatId].avatar=av;
  renderAvInEl(document.getElementById('topbar-av'),av,chatName(chatsData[currentChatId]),40);
  renderAvInEl(document.getElementById('gi-av'),av,'–ì—Ä—É–ø–ø–∞',88);
  renderChatList(chatsData);
  closeModal('group-avatar-modal');toast('‚úì –ê–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
};

// ‚îÄ IMAGE CROP ‚îÄ
let cropDragging=false,cropDragOffX=0,cropDragOffY=0;
let cropImgW=0,cropImgH=0,cropContW=300,cropContH=260;

function openCropModal(file){
  const url=URL.createObjectURL(file);
  const img=document.getElementById('crop-img');
  cropRawData=url;
  img.onload=()=>{
    cropImgW=img.naturalWidth;cropImgH=img.naturalHeight;
    cropScale=1;cropBoxSize=Math.min(cropContH,cropContW)*0.7;
    document.getElementById('crop-scale').value=1;
    applyImgTransform();
    // Center crop box
    const cont=document.getElementById('crop-container');
    cropContW=cont.clientWidth;cropContH=cont.clientHeight;
    cropBoxX=(cropContW-cropBoxSize)/2;cropBoxY=(cropContH-cropBoxSize)/2;
    updateCropBox();
  };
  img.src=url;
  document.getElementById('crop-modal').classList.add('open');
}
function applyImgTransform(){
  const img=document.getElementById('crop-img');
  const cont=document.getElementById('crop-container');
  cropContW=cont.clientWidth;cropContH=cont.clientHeight;
  const baseW=cropImgW*cropScale,baseH=cropImgH*cropScale;
  img.style.width=baseW+'px';img.style.height=baseH+'px';
  img.style.left=((cropContW-baseW)/2)+'px';img.style.top=((cropContH-baseH)/2)+'px';
}
function updateCropBox(){
  const box=document.getElementById('crop-box');
  box.style.left=cropBoxX+'px';box.style.top=cropBoxY+'px';
  box.style.width=cropBoxSize+'px';box.style.height=cropBoxSize+'px';
  box.style.borderRadius='50%';
}
window.updateCropScale=v=>{cropScale=parseFloat(v);applyImgTransform();};

// Crop box drag
const cropBox=document.getElementById('crop-box');
cropBox.addEventListener('mousedown',e=>{
  cropDragging=true;
  cropDragOffX=e.clientX-cropBoxX;cropDragOffY=e.clientY-cropBoxY;
  e.preventDefault();
});
document.addEventListener('mousemove',e=>{
  if(!cropDragging)return;
  cropBoxX=Math.max(0,Math.min(cropContW-cropBoxSize,e.clientX-cropDragOffX));
  cropBoxY=Math.max(0,Math.min(cropContH-cropBoxSize,e.clientY-cropDragOffY));
  updateCropBox();
});
document.addEventListener('mouseup',()=>cropDragging=false);
// Touch support
cropBox.addEventListener('touchstart',e=>{
  const t=e.touches[0];cropDragging=true;
  cropDragOffX=t.clientX-cropBoxX;cropDragOffY=t.clientY-cropBoxY;e.preventDefault();
},{passive:false});
document.addEventListener('touchmove',e=>{
  if(!cropDragging)return;
  const t=e.touches[0];
  cropBoxX=Math.max(0,Math.min(cropContW-cropBoxSize,t.clientX-cropDragOffX));
  cropBoxY=Math.max(0,Math.min(cropContH-cropBoxSize,t.clientY-cropDragOffY));
  updateCropBox();
},{passive:false});
document.addEventListener('touchend',()=>cropDragging=false);

window.applyCrop=()=>{
  const canvas=document.createElement('canvas');
  const size=256;canvas.width=size;canvas.height=size;
  const ctx=canvas.getContext('2d');
  ctx.beginPath();ctx.arc(size/2,size/2,size/2,0,Math.PI*2);ctx.clip();
  const img=document.getElementById('crop-img');
  const cont=document.getElementById('crop-container');
  const contRect=cont.getBoundingClientRect();
  const imgRect=img.getBoundingClientRect();
  // Map crop box in container coords to image natural coords
  const scaleX=cropImgW/(imgRect.width);
  const scaleY=cropImgH/(imgRect.height);
  const srcX=(cropBoxX-(imgRect.left-contRect.left))*scaleX;
  const srcY=(cropBoxY-(imgRect.top-contRect.top))*scaleY;
  const srcSize=cropBoxSize*scaleX;
  ctx.drawImage(img,srcX,srcY,srcSize,srcSize,0,0,size,size);
  const dataUrl=canvas.toDataURL('image/jpeg',0.85);
  if(cropTarget==='user'){avatarPendingData=dataUrl;document.getElementById('avatar-upload-text').textContent='‚úì –§–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–æ';}
  else{groupAvatarPendingData=dataUrl;document.getElementById('group-photo-text').textContent='‚úì –§–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–æ';}
  closeModal('crop-modal');
  URL.revokeObjectURL(cropRawData);
  toast('‚úì –§–æ—Ç–æ –æ–±—Ä–µ–∑–∞–Ω–æ');
};

// ‚îÄ USER PROFILE MODAL ‚îÄ
let upmCurrentUser=null;
function showUserModal(u){
  upmCurrentUser=u;
  renderAvInEl(document.getElementById('upm-av'),u.avatar,u.name,88);
  document.getElementById('upm-name').textContent=u.name;
  document.getElementById('upm-nick').textContent='@'+(u.nick||u.nickLower||'');
  document.getElementById('upm-bio').textContent=u.bio||'';
  const nick=u.nick||u.nickLower||'';
  const lw=document.getElementById('upm-link-wrap');
  if(nick){lw.style.display='flex';document.getElementById('upm-link').textContent=location.origin+location.pathname+'?adduser='+nick;}
  else lw.style.display='none';

  // Add to group list
  const myGroups=Object.entries(chatsData).filter(([,c])=>c.type==='group'&&isAdmin(c,CU.uid)&&!c.members?.[u.uid]);
  const addWrap=document.getElementById('upm-add-to-group-wrap');
  const groupList=document.getElementById('upm-group-list');
  if(myGroups.length>0&&u.uid!==CU.uid){
    addWrap.style.display='block';groupList.innerHTML='';
    myGroups.forEach(([id,c])=>{
      const item=document.createElement('div');item.className='fwd-chat-item';
      item.innerHTML=`${avHTML(chatAv(c),chatName(c),32,'round')}<div><div class="fwd-chat-name">${esc(chatName(c))}</div></div>`;
      item.onclick=async()=>{
        await update(ref(db,`chats/${id}/members`),{[u.uid]:true});
        await set(ref(db,`userChats/${u.uid}/${id}`),true);
        toast('‚úì '+u.name+' –¥–æ–±–∞–≤–ª–µ–Ω –≤ '+chatName(c));
        closeModal('user-profile-modal');
      };
      groupList.appendChild(item);
    });
  }else addWrap.style.display='none';

  const btn=document.getElementById('upm-msg-btn');
  btn.onclick=async()=>{
    closeModal('user-profile-modal');
    const ex=Object.entries(chatsData).find(([,c])=>c.type==='direct'&&c.members?.[CU.uid]&&c.members?.[u.uid]);
    if(ex){openChat(ex[0],ex[1]);return;}
    const r=push(ref(db,'chats'));
    const chat={type:'direct',members:{[CU.uid]:true,[u.uid]:true},names:{[CU.uid]:CUdata?.name||CU.displayName,[u.uid]:u.name},avatars:{[CU.uid]:CUdata?.avatar||null,[u.uid]:u.avatar||null},createdAt:Date.now()};
    await set(r,chat);
    await set(ref(db,`userChats/${CU.uid}/${r.key}`),true);
    await set(ref(db,`userChats/${u.uid}/${r.key}`),true);
    chatsData[r.key]=chat;openChat(r.key,chat);
  };
  document.getElementById('user-profile-modal').classList.add('open');
}
window.copyUpmLink=()=>{const t=document.getElementById('upm-link').textContent;navigator.clipboard.writeText(t).then(()=>toast('‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'));};
async function openUserById(uid){const snap=await get(ref(db,`users/${uid}`));if(snap.exists())showUserModal(snap.val());}

// ‚îÄ CHAT PROFILE ‚îÄ
window.openChatProfile=async()=>{
  const chat=chatsData[currentChatId];if(!chat)return;
  if(chat.type==='direct'){const o=Object.entries(chat.members||{}).find(([uid])=>uid!==CU.uid);if(o)await openUserById(o[0]);}
  else openGroupInfo();
};

// ‚îÄ GROUP INFO ‚îÄ
window.openGroupInfo=async()=>{
  const chat=chatsData[currentChatId];if(!chat||chat.type!=='group')return;
  const name=chatName(chat);
  const memberCount=Object.keys(chat.members||{}).length;
  renderAvInEl(document.getElementById('gi-av'),chat.avatar||{color:'#7c3aed',emoji:'üë•'},name,88);
  document.getElementById('gi-name').textContent=name;
  document.getElementById('gi-members-count').textContent=`${memberCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
  document.getElementById('gi-desc').textContent=chat.description||'';
  const amAdmin=isAdmin(chat,CU.uid);
  document.getElementById('gi-admin-section').style.display=amAdmin?'block':'none';
  document.getElementById('gi-av-overlay').style.display=amAdmin?'flex':'none';
  document.getElementById('gi-add-member-section').style.display=amAdmin?'block':'none';
  if(amAdmin){document.getElementById('gi-name-input').value=name;document.getElementById('gi-desc-input').value=chat.description||'';}
  setErr('gi-add-err','');
  const membersList=document.getElementById('gi-members-list');
  membersList.innerHTML='<div style="color:var(--muted);font-size:.75rem;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  const uids=Object.keys(chat.members||{});
  const users=await Promise.all(uids.map(uid=>get(ref(db,`users/${uid}`))));
  membersList.innerHTML='';
  users.forEach(snap=>{
    if(!snap.exists())return;
    const u=snap.val();const isAdm=isAdmin(chat,u.uid);
    const item=document.createElement('div');item.className='member-item';
    item.innerHTML=`${avHTML(u.avatar,u.name,34)}<div class="member-info"><div class="member-name">${esc(u.name)}</div><div class="member-nick">@${esc(u.nick||u.nickLower||'')}</div></div>`;
    if(isAdm){const badge=document.createElement('span');badge.className='member-badge';badge.textContent='ADMIN';item.appendChild(badge);}
    const acts=document.createElement('div');acts.className='member-actions';
    // View profile
    const profBtn=document.createElement('button');profBtn.className='member-act accent';profBtn.textContent='–ü—Ä–æ—Ñ–∏–ª—å';
    profBtn.onclick=()=>{closeModal('group-info-modal');showUserModal(u);};acts.appendChild(profBtn);
    if(amAdmin&&u.uid!==CU.uid){
      const admBtn=document.createElement('button');admBtn.className='member-act';admBtn.textContent=isAdm?'‚àí–ê–¥–º.':'+–ê–¥–º.';
      admBtn.onclick=async()=>{
        if(isAdm)await remove(ref(db,`chats/${currentChatId}/admins/${u.uid}`));
        else await update(ref(db,`chats/${currentChatId}/admins`),{[u.uid]:true});
        const updated=await get(ref(db,`chats/${currentChatId}`));if(updated.exists())chatsData[currentChatId]=updated.val();
        openGroupInfo();toast(isAdm?'–ü—Ä–∞–≤–∞ —Å–Ω—è—Ç—ã':'‚úì –ù–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º');
      };acts.appendChild(admBtn);
      const kickBtn=document.createElement('button');kickBtn.className='member-act danger';kickBtn.textContent='–£–¥–∞–ª–∏—Ç—å';
      kickBtn.onclick=async()=>{
        if(!confirm('–£–¥–∞–ª–∏—Ç—å '+u.name+'?'))return;
        await remove(ref(db,`chats/${currentChatId}/members/${u.uid}`));
        await remove(ref(db,`userChats/${u.uid}/${currentChatId}`));
        const updated=await get(ref(db,`chats/${currentChatId}`));if(updated.exists())chatsData[currentChatId]=updated.val();
        openGroupInfo();toast('‚úì –£–¥–∞–ª—ë–Ω –∏–∑ –≥—Ä—É–ø–ø—ã');
      };acts.appendChild(kickBtn);
    }
    item.appendChild(acts);membersList.appendChild(item);
  });
  document.getElementById('group-info-modal').classList.add('open');
};

window.saveGroupInfo=async()=>{
  const newName=document.getElementById('gi-name-input').value.trim();
  const newDesc=document.getElementById('gi-desc-input').value.trim();
  if(!newName){toast('‚úó –ù–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ');return;}
  await update(ref(db,`chats/${currentChatId}`),{name:newName,description:newDesc});
  chatsData[currentChatId].name=newName;chatsData[currentChatId].description=newDesc;
  document.getElementById('gi-name').textContent=newName;
  document.getElementById('gi-desc').textContent=newDesc;
  document.getElementById('topbar-name').textContent=newName;
  renderChatList(chatsData);toast('‚úì –ì—Ä—É–ø–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
};

window.addMemberToGroup=async()=>{
  const val=document.getElementById('gi-add-nick-input').value.trim().replace(/^@/,'');
  setErr('gi-add-err','');
  if(!val){setErr('gi-add-err','‚úó –í–≤–µ–¥–∏—Ç–µ username –∏–ª–∏ email');return;}
  const u=await findUser(val);
  if(!u){setErr('gi-add-err','‚úó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');return;}
  if(chatsData[currentChatId]?.members?.[u.uid]){setErr('gi-add-err','‚úó –£–∂–µ –≤ –≥—Ä—É–ø–ø–µ');return;}
  await update(ref(db,`chats/${currentChatId}/members`),{[u.uid]:true});
  await set(ref(db,`userChats/${u.uid}/${currentChatId}`),true);
  document.getElementById('gi-add-nick-input').value='';
  const updated=await get(ref(db,`chats/${currentChatId}`));if(updated.exists())chatsData[currentChatId]=updated.val();
  openGroupInfo();toast('‚úì '+u.name+' –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É');
};

// ‚îÄ SHARE / MEMBERS ‚îÄ
window.shareInvite=()=>{
  const chat=chatsData[currentChatId];if(!chat)return;
  const link=chat.type==='group'?location.origin+location.pathname+'?joingroup='+currentChatId:location.origin+location.pathname+'?adduser='+(CUdata?.nick||'');
  navigator.clipboard.writeText(link).then(()=>toast('‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!')).catch(()=>prompt('–°—Å—ã–ª–∫–∞:',link));
};
window.showMembers=()=>{
  const chat=chatsData[currentChatId];if(!chat)return;
  if(chat.type==='group'){openGroupInfo();return;}
  // For direct ‚Äî open the other person's profile
  const o=Object.entries(chat.members||{}).find(([uid])=>uid!==CU.uid);
  if(o)openUserById(o[0]);
};

// ‚îÄ INVITE PARAMS ‚îÄ
async function checkInviteParam(){
  const p=new URLSearchParams(location.search);
  const adduser=p.get('adduser'),joingroup=p.get('joingroup');
  if(adduser){history.replaceState({},'',location.pathname);const u=await findUser(adduser);if(u)showUserModal(u);else toast('‚úó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');}
  if(joingroup){
    history.replaceState({},'',location.pathname);
    const snap=await get(ref(db,`chats/${joingroup}`));
    if(snap.exists()&&snap.val().type==='group'){
      await update(ref(db,`chats/${joingroup}/members`),{[CU.uid]:true});
      await set(ref(db,`userChats/${CU.uid}/${joingroup}`),true);
      toast('‚úì –í—ã –≤—Å—Ç—É–ø–∏–ª–∏ –≤ –≥—Ä—É–ø–ø—É: '+snap.val().name);
    }else toast('‚úó –ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
  }
}

function showEmpty(){document.getElementById('empty-placeholder').style.display='flex';document.getElementById('active-chat').style.display='none';}

function xlate(code){
  const m={'auth/email-already-in-use':'Email –∑–∞–Ω—è—Ç','auth/invalid-email':'–ù–µ–≤–µ—Ä–Ω—ã–π email','auth/weak-password':'–°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å','auth/user-not-found':'–ù–µ –Ω–∞–π–¥–µ–Ω','auth/wrong-password':'–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å','auth/invalid-credential':'–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å','auth/too-many-requests':'–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫','auth/network-request-failed':'–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞'};
  return m[code]||('–û—à–∏–±–∫–∞: '+code);
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(el=>el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open');}));

// Keyboard shortcuts
document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
document.getElementById('reg-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doRegister();});
document.getElementById('login-id').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('login-pass').focus();});
document.getElementById('new-chat-input').addEventListener('keydown',e=>{if(e.key==='Enter')createChat();});
document.getElementById('user-search-input').addEventListener('keydown',e=>{if(e.key==='Escape')switchTab('chats');});
</script>
</body>
</html>
