<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WAVE ‚Äî –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a0f;--surface:#111118;--surface2:#18181f;--border:#252530;
  --accent:#7c3aed;--accent2:#a855f7;--glow:rgba(124,58,237,.35);
  --text:#e8e8f0;--muted:#6b6b80;--online:#22d3ee;--danger:#f87171;
  --read:#22d3ee;--delivered:#a0a0b0;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;height:100dvh;display:flex;flex-direction:column;overflow:hidden;}

/* AUTH */
#auth-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100dvh;background:radial-gradient(ellipse 80% 60% at 50% -10%,rgba(124,58,237,.25),transparent);}
.auth-logo{font-size:3.5rem;font-weight:800;letter-spacing:-2px;background:linear-gradient(135deg,#a855f7,#38bdf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;}
.auth-sub{color:var(--muted);font-family:'Space Mono',monospace;font-size:.72rem;letter-spacing:3px;margin-bottom:40px;text-transform:uppercase;}
.auth-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px 36px;width:340px;display:flex;flex-direction:column;gap:14px;box-shadow:0 0 60px rgba(0,0,0,.5);}
.auth-box h2{font-size:1.1rem;font-weight:700;}
.auth-input{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px 16px;color:var(--text);font-family:'Space Mono',monospace;font-size:.83rem;width:100%;outline:none;transition:border-color .2s;}
.auth-input:focus{border-color:var(--accent2);}
.auth-btn{background:linear-gradient(135deg,var(--accent),#9333ea);border:none;border-radius:10px;padding:13px;color:#fff;font-family:'Syne',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;transition:opacity .2s,transform .1s;}
.auth-btn:hover{opacity:.9;}.auth-btn:active{transform:scale(.98);}.auth-btn:disabled{opacity:.5;cursor:not-allowed;}
.auth-switch{text-align:center;font-size:.8rem;color:var(--muted);}
.auth-switch a{color:var(--accent2);cursor:pointer;}
.auth-error{color:var(--danger);font-family:'Space Mono',monospace;font-size:.73rem;min-height:16px;}

/* APP LAYOUT */
#app-screen{display:none;flex-direction:row;height:100dvh;overflow:hidden;}
#app-screen.visible{display:flex;}

/* SIDEBAR */
#sidebar{width:280px;min-width:280px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:width .2s;}
.sidebar-header{padding:14px 14px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
.sidebar-logo{font-size:1.3rem;font-weight:800;letter-spacing:-1px;background:linear-gradient(135deg,#a855f7,#38bdf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;flex:1;}
.my-av-btn{width:34px;height:34px;border-radius:10px;cursor:pointer;border:2px solid var(--border);transition:border-color .2s;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;color:#fff;}
.my-av-btn:hover{border-color:var(--accent2);}
.logout-btn{background:none;border:1px solid var(--border);border-radius:7px;color:var(--muted);padding:4px 9px;font-family:'Space Mono',monospace;font-size:.62rem;cursor:pointer;transition:border-color .2s,color .2s;white-space:nowrap;}
.logout-btn:hover{border-color:var(--danger);color:var(--danger);}
.sidebar-tabs{display:flex;border-bottom:1px solid var(--border);}
.s-tab{flex:1;padding:9px 4px;font-size:.68rem;font-weight:600;text-align:center;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:color .2s,border-color .2s;}
.s-tab.active{color:var(--accent2);border-bottom-color:var(--accent2);}
.sidebar-search{padding:10px 12px;border-bottom:1px solid var(--border);}
.search-wrap{position:relative;display:flex;align-items:center;}
.search-icon{position:absolute;left:10px;color:var(--muted);font-size:.85rem;pointer-events:none;}
.search-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:8px 10px 8px 30px;color:var(--text);font-family:'Space Mono',monospace;font-size:.76rem;outline:none;transition:border-color .2s;}
.search-input:focus{border-color:var(--accent2);}
.new-chat-btn{margin:10px 12px;background:none;border:1px dashed var(--border);border-radius:10px;padding:9px;color:var(--muted);font-family:'Syne',sans-serif;font-size:.8rem;cursor:pointer;display:flex;align-items:center;gap:8px;transition:border-color .2s,color .2s;}
.new-chat-btn:hover{border-color:var(--accent2);color:var(--accent2);}
.section-label{padding:6px 14px 3px;font-size:.62rem;font-family:'Space Mono',monospace;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;}
#chat-list,#user-search-results{flex:1;overflow-y:auto;padding:2px 0;}
#chat-list::-webkit-scrollbar,#user-search-results::-webkit-scrollbar{width:3px;}
#chat-list::-webkit-scrollbar-thumb,#user-search-results::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.chat-item{display:flex;align-items:center;gap:11px;padding:10px 14px;cursor:pointer;border-left:2px solid transparent;transition:background .15s,border-color .15s;position:relative;}
.chat-item:hover{background:var(--surface2);}
.chat-item.active{background:var(--surface2);border-left-color:var(--accent2);}
.chat-item-fav{position:absolute;right:8px;top:8px;font-size:.6rem;color:var(--accent2);}
.av{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1rem;flex-shrink:0;overflow:hidden;}
.av img{width:100%;height:100%;object-fit:cover;}
.av.round{border-radius:50%;}
.chat-info{flex:1;min-width:0;}
.chat-name{font-size:.87rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.chat-preview{font-size:.72rem;color:var(--muted);font-family:'Space Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;}
.chat-meta{display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0;}
.chat-time{font-size:.63rem;color:var(--muted);font-family:'Space Mono',monospace;}
.chat-unread{background:var(--accent2);color:#fff;border-radius:10px;font-size:.6rem;font-weight:700;padding:1px 5px;min-width:16px;text-align:center;}
.user-item{display:flex;align-items:center;gap:11px;padding:10px 14px;cursor:pointer;transition:background .15s;}
.user-item:hover{background:var(--surface2);}
.user-item-info{flex:1;min-width:0;}
.user-item-name{font-size:.87rem;font-weight:600;}
.user-item-nick{font-size:.72rem;color:var(--muted);font-family:'Space Mono',monospace;}
.user-item-btn{background:var(--accent);border:none;border-radius:7px;padding:5px 12px;color:#fff;font-family:'Syne',sans-serif;font-size:.75rem;font-weight:700;cursor:pointer;transition:opacity .2s;white-space:nowrap;}
.user-item-btn:hover{opacity:.85;}

/* CHAT AREA */
#chat-area{flex:1;display:flex;flex-direction:column;min-width:0;background:var(--bg);background-image:radial-gradient(ellipse 50% 40% at 80% 10%,rgba(124,58,237,.07),transparent);overflow:hidden;}
.chat-topbar{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;background:var(--surface);flex-shrink:0;}
.chat-topbar-name{font-size:.95rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.chat-topbar-status{font-size:.68rem;color:var(--online);font-family:'Space Mono',monospace;}
.topbar-actions{margin-left:auto;display:flex;gap:6px;flex-shrink:0;}
.icon-btn{background:none;border:1px solid var(--border);border-radius:8px;padding:6px 9px;color:var(--muted);cursor:pointer;font-size:.85rem;transition:border-color .2s,color .2s;white-space:nowrap;}
.icon-btn:hover{border-color:var(--accent2);color:var(--accent2);}
.back-btn{display:none;background:none;border:1px solid var(--border);border-radius:8px;padding:6px 9px;color:var(--muted);cursor:pointer;font-size:.82rem;}

/* GROUP INFO PANEL (right side) */
#group-panel{width:0;min-width:0;background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:width .25s;flex-shrink:0;}
#group-panel.open{width:300px;min-width:300px;}
.gp-header{padding:0;position:relative;flex-shrink:0;}
/* cover photo area */
.gp-cover{height:140px;background:var(--surface2);position:relative;overflow:hidden;cursor:pointer;}
.gp-cover img{width:100%;height:100%;object-fit:cover;}
.gp-cover-overlay{position:absolute;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s;}
.gp-cover:hover .gp-cover-overlay{opacity:1;}
.gp-cover-overlay-text{font-size:.72rem;color:#fff;font-family:'Space Mono',monospace;}
.gp-avatar-wrap{position:absolute;bottom:-30px;left:16px;}
.gp-avatar{width:60px;height:60px;border-radius:50%;border:3px solid var(--surface);overflow:hidden;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.4rem;cursor:pointer;}
.gp-avatar img{width:100%;height:100%;object-fit:cover;}
.gp-close-btn{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.5);border:none;border-radius:50%;width:28px;height:28px;color:#fff;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;}
.gp-meta{padding:38px 16px 14px;border-bottom:1px solid var(--border);}
.gp-name{font-size:1rem;font-weight:700;margin-bottom:2px;}
.gp-count{font-size:.72rem;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:6px;}
.gp-desc{font-size:.78rem;color:var(--muted);line-height:1.5;}
/* Action buttons row */
.gp-actions{display:flex;gap:6px;padding:12px 16px;border-bottom:1px solid var(--border);flex-shrink:0;}
.gp-action-btn{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:8px 4px;color:var(--text);font-family:'Syne',sans-serif;font-size:.7rem;cursor:pointer;transition:border-color .2s,background .2s;display:flex;flex-direction:column;align-items:center;gap:3px;}
.gp-action-btn:hover{border-color:var(--accent2);background:rgba(124,58,237,.1);}
.gp-action-btn .gp-action-icon{font-size:1.1rem;}
.gp-action-btn.danger{color:var(--danger);}
.gp-action-btn.danger:hover{border-color:var(--danger);background:rgba(248,113,113,.1);}
/* Members in panel */
.gp-section-title{padding:10px 16px 4px;font-size:.62rem;font-family:'Space Mono',monospace;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;}
.gp-members{flex:1;overflow-y:auto;padding:0 8px 8px;}
.gp-members::-webkit-scrollbar{width:3px;}
.gp-members::-webkit-scrollbar-thumb{background:var(--border);}
.gp-member-item{display:flex;align-items:center;gap:9px;padding:7px 8px;border-radius:10px;cursor:pointer;transition:background .15s;}
.gp-member-item:hover{background:var(--surface2);}
.gp-member-name{font-size:.83rem;font-weight:600;}
.gp-member-nick{font-size:.68rem;color:var(--muted);font-family:'Space Mono',monospace;}
.gp-member-badge{font-size:.58rem;background:rgba(124,58,237,.25);color:var(--accent2);border:1px solid var(--accent);border-radius:4px;padding:1px 5px;}
.gp-add-member{display:flex;gap:6px;padding:8px 16px;border-top:1px solid var(--border);flex-shrink:0;}
.gp-add-input{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:7px 10px;color:var(--text);font-family:'Space Mono',monospace;font-size:.75rem;outline:none;}
.gp-add-input:focus{border-color:var(--accent2);}
.gp-add-btn{background:var(--accent);border:none;border-radius:8px;padding:7px 12px;color:#fff;font-size:.8rem;cursor:pointer;white-space:nowrap;}

/* MESSAGES */
#messages{flex:1;overflow-y:auto;padding:16px 16px 6px;display:flex;flex-direction:column;gap:2px;}
#messages::-webkit-scrollbar{width:3px;}
#messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.msg-group{display:flex;flex-direction:column;gap:1px;margin-bottom:5px;}
.msg-group.sent{align-items:flex-end;}
.msg-group.recv{align-items:flex-start;}
.msg-sender{font-size:.67rem;font-family:'Space Mono',monospace;color:var(--accent2);margin-bottom:2px;padding:0 4px;cursor:pointer;}
.msg-sender:hover{text-decoration:underline;}
.msg-bubble{max-width:68%;padding:8px 13px;border-radius:16px;font-size:.87rem;line-height:1.5;word-break:break-word;animation:popIn .15s ease;cursor:pointer;}
@keyframes popIn{from{opacity:0;transform:scale(.93) translateY(4px);}to{opacity:1;transform:scale(1) translateY(0);}}
.msg-group.sent .msg-bubble{background:linear-gradient(135deg,var(--accent),#9333ea);color:#fff;border-bottom-right-radius:4px;}
.msg-group.recv .msg-bubble{background:var(--surface2);border:1px solid var(--border);color:var(--text);border-bottom-left-radius:4px;}
/* Time + status row */
.msg-meta-row{display:flex;align-items:center;gap:4px;margin-top:2px;padding:0 4px;}
.msg-time{font-size:.59rem;font-family:'Space Mono',monospace;color:var(--muted);}
.msg-status{font-size:.75rem;line-height:1;}
.msg-status.delivered{color:var(--delivered);}
.msg-status.read{color:var(--read);}

/* Reply inside bubble */
.reply-preview{border-left:3px solid rgba(255,255,255,.4);padding:3px 8px;margin-bottom:5px;border-radius:4px;background:rgba(0,0,0,.2);cursor:pointer;}
.msg-group.recv .reply-preview{border-left-color:var(--accent2);background:rgba(124,58,237,.12);}
.reply-preview-name{font-size:.64rem;font-weight:700;opacity:.8;}
.reply-preview-text{font-size:.7rem;opacity:.65;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px;}
/* Forward */
.fwd-label{font-size:.63rem;font-family:'Space Mono',monospace;opacity:.55;margin-bottom:3px;}
/* Reactions */
.msg-reactions{display:flex;gap:3px;flex-wrap:wrap;margin-top:2px;padding:0 2px;}
.reaction-pill{background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:2px 7px;font-size:.76rem;cursor:pointer;display:flex;align-items:center;gap:3px;transition:border-color .2s;user-select:none;}
.reaction-pill:hover{border-color:var(--accent2);}
.reaction-pill.mine{background:rgba(124,58,237,.2);border-color:var(--accent);}
.reaction-count{font-size:.64rem;color:var(--muted);font-family:'Space Mono',monospace;}

.date-divider{display:flex;align-items:center;gap:10px;margin:8px 0;}
.date-divider::before,.date-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.date-divider span{font-size:.62rem;font-family:'Space Mono',monospace;color:var(--muted);white-space:nowrap;}

/* READ TOOLTIP */
.read-tooltip{position:fixed;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-size:.72rem;font-family:'Space Mono',monospace;z-index:300;pointer-events:none;max-width:200px;box-shadow:0 6px 20px rgba(0,0,0,.5);}
.read-tooltip-title{color:var(--accent2);margin-bottom:4px;font-size:.65rem;}
.read-tooltip-item{color:var(--muted);padding:1px 0;}

/* REPLY BAR */
.reply-bar{display:none;padding:7px 16px;background:var(--surface);border-top:1px solid var(--border);align-items:center;gap:10px;flex-shrink:0;}
.reply-bar.show{display:flex;}
.reply-bar-content{flex:1;min-width:0;}
.reply-bar-name{font-size:.7rem;color:var(--accent2);font-weight:700;}
.reply-bar-text{font-size:.74rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.reply-bar-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1rem;flex-shrink:0;}
.reply-bar-close:hover{color:var(--text);}

/* INPUT */
.input-area{padding:10px 16px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end;background:var(--surface);flex-shrink:0;}
.msg-input-wrap{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:12px;display:flex;align-items:flex-end;gap:7px;padding:8px 12px;transition:border-color .2s;position:relative;}
.msg-input-wrap:focus-within{border-color:var(--accent2);}
.msg-input{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'Syne',sans-serif;font-size:.87rem;resize:none;max-height:110px;line-height:1.5;}
.emoji-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.05rem;padding:0;transition:color .2s;}
.emoji-btn:hover{color:var(--accent2);}
.send-btn{background:linear-gradient(135deg,var(--accent),#9333ea);border:none;border-radius:12px;width:42px;height:42px;color:#fff;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:opacity .2s,transform .1s;box-shadow:0 4px 18px var(--glow);}
.send-btn:hover{opacity:.9;}.send-btn:active{transform:scale(.9);}

/* EMOJI PICKER */
.emoji-picker{position:absolute;bottom:50px;left:0;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:10px;width:310px;box-shadow:0 10px 40px rgba(0,0,0,.5);z-index:50;display:none;flex-direction:column;gap:7px;}
.emoji-picker.open{display:flex;}
.emoji-cat-tabs{display:flex;gap:3px;overflow-x:auto;padding-bottom:2px;}
.emoji-cat-tabs::-webkit-scrollbar{height:2px;}
.emoji-cat-tab{background:none;border:1px solid transparent;border-radius:7px;padding:3px 7px;font-size:.8rem;cursor:pointer;color:var(--muted);transition:background .15s;}
.emoji-cat-tab.active{background:var(--surface2);border-color:var(--border);color:var(--text);}
.emoji-search{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:5px 10px;color:var(--text);font-family:'Space Mono',monospace;font-size:.74rem;width:100%;outline:none;}
.emoji-search:focus{border-color:var(--accent2);}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;max-height:170px;overflow-y:auto;}
.emoji-cell{border:none;background:none;font-size:1.2rem;cursor:pointer;border-radius:6px;padding:4px;transition:background .1s;text-align:center;}
.emoji-cell:hover{background:var(--surface2);}

/* CONTEXT MENU */
.ctx-menu{position:fixed;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:6px;min-width:210px;box-shadow:0 14px 44px rgba(0,0,0,.7);z-index:500;display:none;}
.ctx-menu.show{display:block;}
.ctx-reaction-row{display:flex;gap:3px;padding:7px 8px;border-bottom:1px solid var(--border);margin-bottom:4px;}
.ctx-react-btn{background:none;border:1px solid transparent;border-radius:8px;font-size:1.4rem;padding:3px 6px;cursor:pointer;transition:background .1s,border-color .1s;flex:1;text-align:center;}
.ctx-react-btn:hover{background:var(--surface2);border-color:var(--border);}
.ctx-react-btn.active{background:rgba(124,58,237,.2);border-color:var(--accent);}
.ctx-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:9px;cursor:pointer;font-size:.84rem;transition:background .12s;color:var(--text);}
.ctx-item:hover{background:var(--surface2);}
.ctx-item.danger{color:var(--danger);}
.ctx-item-icon{font-size:.95rem;width:20px;text-align:center;}

/* EMPTY STATE */
.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;color:var(--muted);}
.empty-icon{font-size:2.8rem;opacity:.3;}
.empty-state h3{font-size:.97rem;font-weight:600;color:var(--muted);}
.empty-state p{font-size:.77rem;font-family:'Space Mono',monospace;}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:24px 28px;width:420px;display:flex;flex-direction:column;gap:13px;transform:scale(.94);transition:transform .2s;max-height:90dvh;overflow-y:auto;}
.modal-overlay.open .modal{transform:scale(1);}
.modal::-webkit-scrollbar{width:3px;}
.modal::-webkit-scrollbar-thumb{background:var(--border);}
.modal h3{font-size:1rem;font-weight:700;}
.modal-actions{display:flex;gap:9px;margin-top:4px;}
.modal-cancel{flex:1;background:none;border:1px solid var(--border);border-radius:9px;padding:10px;color:var(--muted);font-family:'Syne',sans-serif;font-size:.83rem;cursor:pointer;}
.modal-cancel:hover{border-color:var(--muted);}
.modal-ok{flex:1;background:linear-gradient(135deg,var(--accent),#9333ea);border:none;border-radius:9px;padding:10px;color:#fff;font-family:'Syne',sans-serif;font-size:.83rem;font-weight:700;cursor:pointer;}
.modal-ok:hover{opacity:.9;}
.modal-danger{flex:1;background:none;border:1px solid var(--danger);border-radius:9px;padding:10px;color:var(--danger);font-family:'Syne',sans-serif;font-size:.83rem;cursor:pointer;}
.modal-danger:hover{background:rgba(248,113,113,.1);}
.modal-section{font-size:.68rem;font-family:'Space Mono',monospace;color:var(--muted);letter-spacing:1px;text-transform:uppercase;border-top:1px solid var(--border);padding-top:10px;margin-top:2px;}

/* PROFILE HEADER with photo gallery */
.profile-header{position:relative;background:var(--surface2);border-radius:12px;overflow:hidden;margin-bottom:4px;}
.profile-photos-scroll{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;gap:0;}
.profile-photos-scroll::-webkit-scrollbar{display:none;}
.profile-photo-slide{width:100%;flex-shrink:0;scroll-snap-align:start;height:160px;position:relative;}
.profile-photo-slide img{width:100%;height:100%;object-fit:cover;}
.profile-photo-slide.empty{display:flex;align-items:center;justify-content:center;background:var(--surface2);height:160px;}
.profile-avatar-over{position:absolute;bottom:-32px;left:50%;transform:translateX(-50%);}
.profile-main-av{width:68px;height:68px;border-radius:50%;border:3px solid var(--surface);display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:700;overflow:hidden;cursor:pointer;}
.profile-main-av img{width:100%;height:100%;object-fit:cover;}
.profile-photo-dots{position:absolute;bottom:6px;left:0;right:0;display:flex;justify-content:center;gap:4px;}
.profile-photo-dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.4);transition:background .2s;}
.profile-photo-dot.active{background:#fff;}
.profile-add-photo-btn{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.5);border:none;border-radius:50%;width:28px;height:28px;color:#fff;font-size:.85rem;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.profile-info-center{text-align:center;padding:40px 16px 6px;}
.profile-name-big{font-size:1.05rem;font-weight:700;}
.profile-nick-small{font-size:.75rem;color:var(--muted);font-family:'Space Mono',monospace;margin-top:2px;}
.profile-bio-small{font-size:.75rem;color:var(--muted);line-height:1.5;margin-top:6px;font-style:italic;}

/* Color/emoji picker */
.av-color-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;}
.av-color{width:100%;aspect-ratio:1;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:border-color .2s,transform .1s;}
.av-color:hover,.av-color.sel{border-color:#fff;transform:scale(1.08);}
.av-emoji-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;}
.av-emoji{width:100%;aspect-ratio:1;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2rem;background:var(--surface2);border:2px solid transparent;transition:border-color .2s,transform .1s;}
.av-emoji:hover,.av-emoji.sel{border-color:var(--accent2);transform:scale(1.08);}

/* Upload area */
.photo-upload-area{border:2px dashed var(--border);border-radius:10px;padding:14px;text-align:center;cursor:pointer;transition:border-color .2s;position:relative;overflow:hidden;}
.photo-upload-area:hover{border-color:var(--accent2);}
.photo-upload-area input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.photo-upload-text{font-size:.74rem;color:var(--muted);font-family:'Space Mono',monospace;pointer-events:none;}

/* CROP */
#crop-container{position:relative;width:100%;height:220px;overflow:hidden;background:#000;border-radius:10px;cursor:crosshair;}
#crop-img{position:absolute;transform-origin:top left;}
#crop-box{position:absolute;border:2px solid var(--accent2);box-shadow:0 0 0 9999px rgba(0,0,0,.6);border-radius:50%;cursor:move;}
.crop-controls{display:flex;gap:8px;align-items:center;margin-top:6px;}
.crop-slider{flex:1;accent-color:var(--accent2);}

/* Members / member item */
.member-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);}
.member-item:last-child{border-bottom:none;}
.member-info{flex:1;min-width:0;}
.member-name{font-size:.85rem;font-weight:600;}
.member-nick{font-size:.7rem;color:var(--muted);font-family:'Space Mono',monospace;}
.member-badge{font-size:.6rem;background:rgba(124,58,237,.3);color:var(--accent2);border:1px solid var(--accent);border-radius:5px;padding:2px 6px;}
.member-actions{display:flex;gap:5px;flex-wrap:wrap;}
.member-act{background:none;border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-size:.65rem;cursor:pointer;color:var(--muted);transition:color .15s,border-color .15s;white-space:nowrap;}
.member-act:hover{color:var(--text);border-color:var(--muted);}
.member-act.danger{color:var(--danger);}
.member-act.danger:hover{border-color:var(--danger);}
.member-act.accent{color:var(--accent2);}
.member-act.accent:hover{border-color:var(--accent2);}

/* Forward */
.fwd-chat-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;cursor:pointer;transition:background .15s;}
.fwd-chat-item:hover{background:var(--surface2);}
.fwd-chat-item.sel{background:rgba(124,58,237,.15);border:1px solid var(--accent);}
.fwd-chat-name{font-size:.85rem;font-weight:600;}
.fwd-chat-type{font-size:.68rem;color:var(--muted);font-family:'Space Mono',monospace;}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 18px;font-size:.82rem;font-family:'Space Mono',monospace;opacity:0;transition:opacity .25s,transform .25s;z-index:999;pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* Invite-link */
.invite-link-wrap{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:8px;}
.invite-link-text{flex:1;font-family:'Space Mono',monospace;font-size:.7rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.copy-btn{background:var(--accent);border:none;border-radius:7px;padding:5px 10px;color:#fff;font-family:'Space Mono',monospace;font-size:.65rem;cursor:pointer;white-space:nowrap;}
.copy-btn:hover{opacity:.85;}

/* MEDIA MESSAGES */
.msg-image{max-width:260px;max-height:200px;border-radius:10px;cursor:pointer;display:block;object-fit:cover;}
.msg-video{max-width:260px;border-radius:10px;cursor:pointer;display:block;}
.msg-file-bubble{display:flex;align-items:center;gap:9px;padding:8px 12px;background:rgba(0,0,0,.15);border-radius:10px;cursor:pointer;min-width:180px;}
.msg-file-icon{font-size:1.5rem;flex-shrink:0;}
.msg-file-info{flex:1;min-width:0;}
.msg-file-name{font-size:.78rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.msg-file-size{font-size:.63rem;color:rgba(255,255,255,.6);font-family:'Space Mono',monospace;}
.msg-sticker{width:120px;height:120px;object-fit:contain;display:block;cursor:pointer;}
.msg-video-note{width:200px;height:200px;border-radius:50%;overflow:hidden;cursor:pointer;position:relative;flex-shrink:0;}
.msg-video-note video{width:100%;height:100%;object-fit:cover;}
.msg-video-note-play{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.3);font-size:2rem;}
.msg-audio{display:flex;align-items:center;gap:8px;padding:6px 10px;min-width:200px;}
.audio-play-btn{background:rgba(255,255,255,.2);border:none;border-radius:50%;width:32px;height:32px;color:#fff;font-size:.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.audio-play-btn:hover{background:rgba(255,255,255,.35);}
.audio-waveform{flex:1;height:28px;display:flex;align-items:center;gap:1px;cursor:pointer;position:relative;}
.audio-bar{width:3px;background:rgba(255,255,255,.4);border-radius:2px;transition:background .1s;}
.audio-bar.played{background:rgba(255,255,255,.9);}
.audio-duration{font-size:.62rem;font-family:'Space Mono',monospace;white-space:nowrap;opacity:.75;}
.attach-menu{position:absolute;bottom:54px;left:0;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:8px;box-shadow:0 10px 40px rgba(0,0,0,.5);z-index:50;display:none;flex-direction:column;gap:4px;min-width:170px;}
.attach-menu.open{display:flex;}
.attach-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:9px;cursor:pointer;font-size:.84rem;transition:background .12s;color:var(--text);}
.attach-item:hover{background:var(--surface2);}
.attach-item-icon{font-size:1.1rem;width:22px;text-align:center;}
.record-btn{background:none;border:1px solid var(--border);border-radius:12px;width:42px;height:42px;color:var(--muted);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;}
.record-btn:hover{border-color:var(--danger);color:var(--danger);}
.record-btn.recording{background:var(--danger);border-color:var(--danger);color:#fff;animation:pulse 1s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.6;}}
.record-timer{font-size:.72rem;font-family:'Space Mono',monospace;color:var(--danger);display:none;}
.record-timer.show{display:block;}
.sticker-picker{position:absolute;bottom:50px;left:0;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:10px;width:340px;box-shadow:0 10px 40px rgba(0,0,0,.5);z-index:50;display:none;flex-direction:column;gap:7px;max-height:380px;}
.sticker-picker.open{display:flex;}
.sticker-tabs{display:flex;gap:4px;overflow-x:auto;padding-bottom:4px;}
.sticker-tabs::-webkit-scrollbar{height:2px;}
.sticker-tab{background:none;border:1px solid transparent;border-radius:8px;padding:4px 10px;font-size:.75rem;cursor:pointer;color:var(--muted);white-space:nowrap;transition:background .15s;}
.sticker-tab.active{background:var(--surface2);border-color:var(--border);color:var(--text);}
.sticker-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;overflow-y:auto;flex:1;}
.sticker-cell{aspect-ratio:1;border-radius:8px;cursor:pointer;padding:4px;transition:background .1s;display:flex;align-items:center;justify-content:center;font-size:2.4rem;}
.sticker-cell:hover{background:var(--surface2);}
.sticker-cell img{width:100%;height:100%;object-fit:contain;}
.spack-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;border:1px solid var(--border);margin-bottom:6px;}
.spack-thumb{width:48px;height:48px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:2rem;background:var(--surface2);}
.spack-info{flex:1;min-width:0;}
.spack-name{font-size:.85rem;font-weight:600;}
.spack-count{font-size:.68rem;color:var(--muted);font-family:'Space Mono',monospace;}
.spack-add-btn{background:var(--accent);border:none;border-radius:8px;padding:5px 12px;color:#fff;font-size:.75rem;cursor:pointer;}
.spack-remove-btn{background:none;border:1px solid var(--danger);border-radius:8px;padding:5px 12px;color:var(--danger);font-size:.75rem;cursor:pointer;}
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:1000;display:none;align-items:center;justify-content:center;}
#lightbox.open{display:flex;}
#lightbox img,#lightbox video{max-width:90vw;max-height:90vh;border-radius:12px;object-fit:contain;}
#lightbox-close{position:absolute;top:16px;right:16px;background:rgba(255,255,255,.1);border:none;border-radius:50%;width:40px;height:40px;color:#fff;font-size:1.3rem;cursor:pointer;display:flex;align-items:center;justify-content:center;}
@media(max-width:640px){
  #sidebar{width:100%;min-width:unset;}
  #sidebar.hidden{display:none;}
  #chat-area{display:none;}
  #chat-area.visible{display:flex;}
  .back-btn{display:flex!important;}
  .modal{width:95vw;padding:18px;}
  #group-panel.open{width:100%;position:absolute;right:0;top:0;bottom:0;z-index:10;}
}
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth-screen">
  <div class="auth-logo">WAVE</div>
  <div class="auth-sub">messenger ¬∑ v7.0</div>
  <div class="auth-box" id="login-box">
    <h2>–í–æ–π—Ç–∏</h2>
    <input class="auth-input" id="login-id" type="text" placeholder="Email –∏–ª–∏ @username">
    <input class="auth-input" id="login-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <div class="auth-error" id="login-error"></div>
    <button class="auth-btn" id="login-btn" onclick="doLogin()">–í–æ–π—Ç–∏ ‚Üí</button>
    <div class="auth-switch">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="toggleAuth(true)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></div>
  </div>
  <div class="auth-box" id="reg-box" style="display:none">
    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input class="auth-input" id="reg-name" type="text" placeholder="–ò–º—è" maxlength="30">
    <input class="auth-input" id="reg-nick" type="text" placeholder="@username" maxlength="20">
    <input class="auth-input" id="reg-email" type="email" placeholder="Email">
    <input class="auth-input" id="reg-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6)">
    <div class="auth-error" id="reg-error"></div>
    <button class="auth-btn" id="reg-btn" onclick="doRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí</button>
    <div class="auth-switch">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="toggleAuth(false)">–í–æ–π—Ç–∏</a></div>
  </div>
</div>

<!-- APP -->
<div id="app-screen">
  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-logo">WAVE</span>
      <div class="my-av-btn" id="my-av-btn" onclick="openMyProfile()" title="–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å"></div>
      <button class="logout-btn" onclick="doLogout()">–≤—ã–π—Ç–∏</button>
    </div>
    <div class="sidebar-tabs">
      <div class="s-tab active" id="tab-chats" onclick="switchTab('chats')">–ß–∞—Ç—ã</div>
      <div class="s-tab" id="tab-search" onclick="switchTab('search')">üîç –õ—é–¥–∏</div>
      <div class="s-tab" id="tab-favs" onclick="switchTab('favs')">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
    </div>
    <!-- Chats -->
    <div id="pane-chats" style="display:flex;flex-direction:column;flex:1;overflow:hidden;">
      <div class="sidebar-search">
        <div class="search-wrap">
          <span class="search-icon">‚åï</span>
          <input class="search-input" id="chat-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç–∞–º..." oninput="filterChats()">
        </div>
      </div>
      <button class="new-chat-btn" onclick="openNewChatModal()">Ôºã –ù–æ–≤—ã–π —á–∞—Ç</button>
      <div class="section-label">–î–∏–∞–ª–æ–≥–∏</div>
      <div id="chat-list"></div>
    </div>
    <!-- Search -->
    <div id="pane-search" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
      <div class="sidebar-search">
        <div class="search-wrap">
          <span class="search-icon">‚åï</span>
          <input class="search-input" id="user-search-input" placeholder="@username –∏–ª–∏ –∏–º—è..." oninput="searchUsers(this.value)">
        </div>
      </div>
      <div class="section-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
      <div id="user-search-results"><div style="padding:16px;font-size:.76rem;color:var(--muted);font-family:'Space Mono',monospace;">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ @–Ω–∏–∫</div></div>
    </div>
    <!-- Favorites ‚Äî just a shortcut to open fav chat -->
    <div id="pane-favs" style="display:none;flex-direction:column;flex:1;overflow:hidden;align-items:center;justify-content:center;gap:12px;">
      <div style="font-size:3rem;">‚≠ê</div>
      <div style="font-size:.9rem;font-weight:700;color:var(--text);">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
      <div style="font-size:.76rem;color:var(--muted);font-family:'Space Mono',monospace;text-align:center;padding:0 24px;">–õ–∏—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–º–µ—Ç–æ–∫ –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</div>
      <button class="modal-ok" style="max-width:180px;" onclick="openFavoritesChat()">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</button>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div id="chat-area">
    <div id="empty-placeholder" class="empty-state">
      <div class="empty-icon">üí¨</div>
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
      <p>–∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ü–æ–∏—Å–∫–µ</p>
    </div>
    <div id="active-chat" style="display:none;flex-direction:column;height:100%;overflow:hidden;">
      <div class="chat-topbar">
        <button class="back-btn" onclick="goBack()">‚Üê</button>
        <div class="av" id="topbar-av" style="cursor:pointer;flex-shrink:0;" onclick="openChatProfile()"></div>
        <div style="cursor:pointer;flex:1;min-width:0;" onclick="openChatProfile()">
          <div class="chat-topbar-name" id="topbar-name"></div>
          <div class="chat-topbar-status" id="topbar-status"></div>
        </div>
        <div class="topbar-actions">
          <button class="icon-btn" id="fav-topbar-btn" onclick="toggleChatFavorite()" title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">‚òÜ</button>
          <button class="icon-btn" id="group-panel-btn" onclick="toggleGroupPanel()" title="–ò–Ω—Ñ–æ –æ –≥—Ä—É–ø–ø–µ" style="display:none">‚ÑπÔ∏è</button>
          <button class="icon-btn" onclick="shareInvite()" title="–°—Å—ã–ª–∫–∞">üîó</button>
        </div>
      </div>
      <div id="messages"></div>
      <div class="reply-bar" id="reply-bar">
        <div style="font-size:.85rem;color:var(--accent2);">‚Ü©</div>
        <div class="reply-bar-content">
          <div class="reply-bar-name" id="reply-bar-name"></div>
          <div class="reply-bar-text" id="reply-bar-text"></div>
        </div>
        <button class="reply-bar-close" onclick="cancelReply()">‚úï</button>
      </div>
      <div class="input-area">
        <div class="msg-input-wrap" style="position:relative;">
          <div class="attach-menu" id="attach-menu">
            <div class="attach-item" onclick="pickMedia('image')"><span class="attach-item-icon">üñº</span>–§–æ—Ç–æ / –í–∏–¥–µ–æ</div>
            <div class="attach-item" onclick="pickMedia('file')"><span class="attach-item-icon">üìé</span>–§–∞–π–ª</div>
            <div class="attach-item" onclick="startVideoNote()"><span class="attach-item-icon">‚≠ï</span>–í–∏–¥–µ–æ–∫—Ä—É–∂–æ–∫</div>
          </div>
          <div class="sticker-picker" id="sticker-picker">
            <div class="sticker-tabs" id="sticker-tabs"></div>
            <div class="sticker-grid" id="sticker-grid"></div>
            <div style="display:flex;gap:6px;border-top:1px solid var(--border);padding-top:8px;flex-shrink:0;">
              <button class="modal-cancel" style="flex:1;padding:6px;font-size:.73rem;" onclick="openStickerManager()">üé® –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
            </div>
          </div>
          <button class="emoji-btn" onclick="toggleAttachMenu(event)" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å">üìé</button>
          <textarea class="msg-input" id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"
            onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
          <button class="emoji-btn" onclick="toggleStickerPicker(event)" title="–°—Ç–∏–∫–µ—Ä—ã">üé≠</button>
          <button class="emoji-btn" onclick="toggleEmojiPicker(event)" title="–≠–º–æ–¥–∑–∏">‚ò∫</button>
          <div class="emoji-picker" id="emoji-picker">
            <input class="emoji-search" id="emoji-search" placeholder="–ü–æ–∏—Å–∫..." oninput="filterEmojis(this.value)">
            <div class="emoji-cat-tabs" id="emoji-cat-tabs"></div>
            <div class="emoji-grid" id="emoji-grid"></div>
          </div>
          <input type="file" id="media-input" accept="image/*,video/*" style="display:none;" onchange="handleMediaFile(event)">
          <input type="file" id="file-input" style="display:none;" onchange="handleFileAttach(event)">
        </div>
        <span class="record-timer" id="record-timer">00:00</span>
        <button class="record-btn" id="record-btn" onclick="toggleRecord()" title="–ê—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏–µ">üéô</button>
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>

  <!-- GROUP PANEL (right) -->
  <div id="group-panel">
    <div class="gp-header">
      <div class="gp-cover" id="gp-cover" onclick="openGroupCoverPicker()">
        <div class="gp-cover-overlay"><span class="gp-cover-overlay-text">üì∑ –ò–∑–º–µ–Ω–∏—Ç—å –æ–±–ª–æ–∂–∫—É</span></div>
      </div>
      <div class="gp-avatar-wrap">
        <div class="gp-avatar" id="gp-avatar" onclick="openGroupAvatarPickerFromPanel()"></div>
      </div>
      <button class="gp-close-btn" onclick="toggleGroupPanel()">‚úï</button>
    </div>
    <div class="gp-meta">
      <div class="gp-name" id="gp-panel-name"></div>
      <div class="gp-count" id="gp-panel-count"></div>
      <div class="gp-desc" id="gp-panel-desc"></div>
    </div>
    <!-- Action buttons -->
    <div class="gp-actions" id="gp-actions">
      <button class="gp-action-btn" onclick="openGpEditName()">
        <span class="gp-action-icon">‚úèÔ∏è</span><span>–ò–∑–º–µ–Ω–∏—Ç—å</span>
      </button>
      <button class="gp-action-btn" onclick="shareInvite()">
        <span class="gp-action-icon">üîó</span><span>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</span>
      </button>
      <button class="gp-action-btn danger" id="gp-leave-btn" onclick="leaveOrDeleteGroup()">
        <span class="gp-action-icon">üö™</span><span id="gp-leave-label">–ü–æ–∫–∏–Ω—É—Ç—å</span>
      </button>
    </div>
    <!-- Edit section (admin only, toggleable) -->
    <div id="gp-edit-section" style="display:none;padding:10px 16px;border-bottom:1px solid var(--border);">
      <input class="auth-input" id="gp-edit-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" style="margin-bottom:8px;">
      <textarea class="auth-input" id="gp-edit-desc-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." rows="2" style="resize:none;margin-bottom:8px;"></textarea>
      <div style="display:flex;gap:6px;">
        <button class="modal-ok" style="font-size:.75rem;padding:7px;" onclick="saveGroupFromPanel()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="modal-cancel" style="font-size:.75rem;padding:7px;" onclick="document.getElementById('gp-edit-section').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
    <div class="gp-section-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
    <div class="gp-members" id="gp-members-list"></div>
    <div class="gp-add-member" id="gp-add-member-row" style="display:none;">
      <input class="gp-add-input" id="gp-add-input" placeholder="@username –∏–ª–∏ email">
      <button class="gp-add-btn" onclick="addMemberFromPanel()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-reaction-row" id="ctx-reactions"></div>
  <div class="ctx-item" id="ctx-reply"><span class="ctx-item-icon">‚Ü©</span>–û—Ç–≤–µ—Ç–∏—Ç—å</div>
  <div class="ctx-item" id="ctx-forward"><span class="ctx-item-icon">‚Ü™</span>–ü–µ—Ä–µ—Å–ª–∞—Ç—å</div>
  <div class="ctx-item" id="ctx-save-fav"><span class="ctx-item-icon">‚≠ê</span>–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
  <div class="ctx-item" id="ctx-copy"><span class="ctx-item-icon">üìã</span>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
  <div class="ctx-item" id="ctx-read-by" style="display:none"><span class="ctx-item-icon">üëÅ</span>–ö—Ç–æ –ø—Ä–æ—á–∏—Ç–∞–ª</div>
  <div class="ctx-item danger" id="ctx-delete" style="display:none"><span class="ctx-item-icon">üóë</span>–£–¥–∞–ª–∏—Ç—å</div>
</div>

<!-- Read-by tooltip -->
<div class="read-tooltip" id="read-tooltip" style="display:none;"></div>

<!-- New Chat Modal -->
<div class="modal-overlay" id="new-chat-modal">
  <div class="modal">
    <h3>–ù–æ–≤—ã–π —á–∞—Ç</h3>
    <input class="auth-input" id="new-chat-input" placeholder="@username / email / –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
    <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;color:var(--muted);cursor:pointer;">
      <input type="checkbox" id="is-group" style="accent-color:var(--accent);"> –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç
    </label>
    <div id="group-desc-wrap" style="display:none;">
      <input class="auth-input" id="group-desc-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" maxlength="200">
    </div>
    <div class="auth-error" id="new-chat-err"></div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('new-chat-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-ok" onclick="createChat()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- My Profile Modal -->
<div class="modal-overlay" id="my-profile-modal">
  <div class="modal">
    <h3>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h3>
    <!-- Photo gallery header -->
    <div class="profile-header" id="my-profile-header">
      <div style="position:relative;">
        <div class="profile-photos-scroll" id="my-photos-scroll"></div>
        <div class="profile-photo-dots" id="my-photo-dots"></div>
        <button class="profile-add-photo-btn" onclick="addMyPhoto()" title="–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ">Ôºã</button>
        <input type="file" id="my-extra-photo-input" accept="image/*" style="display:none;" onchange="handleMyExtraPhoto(event)">
      </div>
      <div class="profile-avatar-over">
        <div class="profile-main-av" id="my-profile-av" onclick="openAvatarPicker()"></div>
      </div>
    </div>
    <div class="profile-info-center">
      <div class="profile-name-big" id="my-profile-name"></div>
      <div class="profile-nick-small" id="my-profile-nick"></div>
    </div>
    <div class="modal-section">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
    <input class="auth-input" id="my-profile-name-input" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è">
    <input class="auth-input" id="my-profile-nick-input" placeholder="@username" maxlength="20">
    <textarea class="auth-input" id="my-profile-bio-input" placeholder="–û —Å–µ–±–µ..." maxlength="200" rows="3" style="resize:none;"></textarea>
    <div class="auth-error" id="profile-save-err"></div>
    <button class="modal-ok" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <div class="modal-section">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</div>
    <button class="modal-ok" style="background:none;border:1px solid var(--border);color:var(--text);" onclick="sendPasswordReset()">üìß –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</button>
    <div class="modal-section">–ú–æ—è —Å—Å—ã–ª–∫–∞</div>
    <div class="invite-link-wrap">
      <span class="invite-link-text" id="my-invite-link"></span>
      <button class="copy-btn" onclick="copyMyLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div class="modal-actions"><button class="modal-cancel" onclick="closeModal('my-profile-modal')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div>
</div>

<!-- Avatar Picker Modal -->
<div class="modal-overlay" id="avatar-modal">
  <div class="modal">
    <h3>–ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</h3>
    <div class="photo-upload-area">
      <input type="file" id="avatar-file-input" accept="image/*" onchange="handleAvatarFile(event)">
      <div class="photo-upload-text" id="avatar-upload-text">üì∑ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</div>
    </div>
    <div class="modal-section">–ò–ª–∏ –≤—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏</div>
    <div style="font-size:.72rem;color:var(--muted);">–¶–≤–µ—Ç —Ñ–æ–Ω–∞</div>
    <div class="av-color-grid" id="av-color-grid"></div>
    <div style="font-size:.72rem;color:var(--muted);margin-top:6px;">–≠–º–æ–¥–∑–∏</div>
    <div class="av-emoji-grid" id="av-emoji-grid"></div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('avatar-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-ok" onclick="saveAvatar()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Group Avatar (from panel) -->
<div class="modal-overlay" id="group-avatar-modal">
  <div class="modal">
    <h3>–ê–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã</h3>
    <div class="photo-upload-area">
      <input type="file" id="group-avatar-file" accept="image/*" onchange="handleGroupAvatarFile(event)">
      <div class="photo-upload-text" id="group-photo-text">üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</div>
    </div>
    <div class="modal-section">–ò–ª–∏ —ç–º–æ–¥–∑–∏</div>
    <div class="av-color-grid" id="grav-color-grid"></div>
    <div style="font-size:.72rem;color:var(--muted);margin-top:6px;">–≠–º–æ–¥–∑–∏</div>
    <div class="av-emoji-grid" id="grav-emoji-grid"></div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('group-avatar-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-ok" onclick="saveGroupAvatar()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Image Crop Modal -->
<div class="modal-overlay" id="crop-modal">
  <div class="modal" style="width:440px;">
    <h3>–ö–∞–¥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ</h3>
    <div id="crop-container">
      <img id="crop-img" draggable="false">
      <div id="crop-box"></div>
    </div>
    <div class="crop-controls">
      <span style="font-size:.72rem;color:var(--muted);">–ú–∞—Å—à—Ç–∞–±</span>
      <input type="range" class="crop-slider" id="crop-scale" min="0.2" max="2" step="0.01" value="0.6" oninput="updateCropScale(this.value)">
    </div>
    <p style="font-size:.7rem;color:var(--muted);font-family:'Space Mono',monospace;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫—Ä—É–≥ –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ–±–ª–∞—Å—Ç–∏</p>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('crop-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-ok" onclick="applyCrop()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- User Profile Modal -->
<div class="modal-overlay" id="user-profile-modal">
  <div class="modal">
    <!-- Photo gallery header for other user -->
    <div class="profile-header">
      <div style="position:relative;">
        <div class="profile-photos-scroll" id="upm-photos-scroll"></div>
        <div class="profile-photo-dots" id="upm-photo-dots"></div>
      </div>
      <div class="profile-avatar-over">
        <div class="profile-main-av" id="upm-av" style="cursor:default;pointer-events:none;"></div>
      </div>
    </div>
    <div class="profile-info-center">
      <div class="profile-name-big" id="upm-name"></div>
      <div class="profile-nick-small" id="upm-nick"></div>
      <div class="profile-bio-small" id="upm-bio"></div>
    </div>
    <div class="invite-link-wrap" id="upm-link-wrap" style="display:none;">
      <span class="invite-link-text" id="upm-link"></span>
      <button class="copy-btn" onclick="copyUpmLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div id="upm-add-to-group-wrap" style="display:none;">
      <div class="modal-section">–î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É</div>
      <div id="upm-group-list" style="max-height:140px;overflow-y:auto;"></div>
    </div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('user-profile-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="modal-ok" id="upm-msg-btn">–ù–∞–ø–∏—Å–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- Forward Modal -->
<div class="modal-overlay" id="forward-modal">
  <div class="modal">
    <h3>–ü–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
    <p style="font-size:.77rem;color:var(--muted);font-family:'Space Mono',monospace;" id="fwd-msg-preview"></p>
    <div id="fwd-chat-list" style="max-height:280px;overflow-y:auto;display:flex;flex-direction:column;gap:4px;"></div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('forward-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-ok" onclick="doForward()">–ü–µ—Ä–µ—Å–ª–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- Delete Group Confirm Modal -->
<div class="modal-overlay" id="delete-group-modal">
  <div class="modal">
    <h3>‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?</h3>
    <p style="font-size:.82rem;color:var(--muted);line-height:1.6;">–ì—Ä—É–ø–ø–∞ –∏ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal('delete-group-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-danger" onclick="confirmDeleteGroup()">–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Lightbox -->
<div id="lightbox" onclick="closeLightbox()">
  <button id="lightbox-close" onclick="closeLightbox()">‚úï</button>
  <div id="lightbox-content"></div>
</div>

<!-- Video Note Capture Modal -->
<div class="modal-overlay" id="videonote-modal">
  <div class="modal" style="align-items:center;gap:12px;max-width:340px;">
    <h3>‚≠ï –í–∏–¥–µ–æ–∫—Ä—É–∂–æ–∫</h3>
    <div style="width:240px;height:240px;border-radius:50%;overflow:hidden;background:#000;position:relative;flex-shrink:0;">
      <video id="videonote-preview" autoplay muted playsinline style="width:100%;height:100%;object-fit:cover;"></video>
      <div id="videonote-rec-indicator" style="position:absolute;top:12px;right:12px;width:12px;height:12px;border-radius:50%;background:var(--danger);display:none;animation:pulse 1s infinite;"></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button class="modal-cancel" onclick="closeVideoNote()">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-ok" id="videonote-btn" onclick="toggleVideoNoteRec()">‚óè –ó–∞–ø–∏—Å—å</button>
    </div>
    <p style="font-size:.68rem;color:var(--muted);font-family:'Space Mono',monospace;">–ú–∞–∫—Å. 60 —Å–µ–∫</p>
  </div>
</div>

<!-- Sticker Manager Modal -->
<div class="modal-overlay" id="sticker-manager-modal">
  <div class="modal" style="max-width:460px;">
    <h3>üé® –°—Ç–∏–∫–µ—Ä-–ø–∞–∫–∏</h3>
    <div class="modal-section">–ú–æ–∏ –ø–∞–∫–∏</div>
    <div id="my-packs-list" style="max-height:200px;overflow-y:auto;"></div>
    <div class="modal-section">–°–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –ø–∞–∫</div>
    <input class="auth-input" id="new-pack-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–∫–∞" maxlength="30">
    <div style="font-size:.72rem;color:var(--muted);">–°—Ç–∏–∫–µ—Ä—ã ‚Äî —ç—Ç–æ —ç–º–æ–¥–∑–∏ –∏–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏. –î–æ–±–∞–≤—å—Ç–µ —ç–º–æ–¥–∑–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:</div>
    <input class="auth-input" id="new-pack-emojis" placeholder="üòÑ,üî•,üíú,üöÄ,..." >
    <div class="auth-error" id="pack-create-err"></div>
    <button class="modal-ok" onclick="createStickerPack()">–°–æ–∑–¥–∞—Ç—å –ø–∞–∫</button>
    <div class="modal-section">–ü–∞–∫–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</div>
    <div id="community-packs-list" style="max-height:200px;overflow-y:auto;"></div>
    <div class="modal-actions"><button class="modal-cancel" onclick="closeModal('sticker-manager-modal')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signOut, onAuthStateChanged, updateProfile, setPersistence, browserLocalPersistence,
  sendPasswordResetEmail
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import {
  getDatabase, ref, set, get, push, onValue, off, update, remove,
  query, orderByChild, limitToLast, equalTo
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
import {
  getStorage, ref as sref, uploadBytes, getDownloadURL, uploadBytesResumable
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

const FC = {
  apiKey:"AIzaSyDaMGT4kvbS5_sKhPQm7u5g30baMaPxYvw",
  authDomain:"wawe-23d7c.firebaseapp.com",
  databaseURL:"https://wawe-23d7c-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"wawe-23d7c",
  storageBucket:"wawe-23d7c.firebasestorage.app",
  messagingSenderId:"843038206524",
  appId:"1:843038206524:web:bbcbdd32fa7ca8890ef139"
};
const app=initializeApp(FC);
const auth=getAuth(app);
const db=getDatabase(app);
const storage=getStorage(app);
setPersistence(auth,browserLocalPersistence).catch(console.error);

const COLORS=['#7c3aed','#059669','#db2777','#0891b2','#d97706','#6366f1','#ef4444','#f97316','#14b8a6','#8b5cf6','#ec4899','#22c55e'];
const EMOJIS=['üòä','üî•','üíú','üëæ','üöÄ','üéØ','üåä','‚ö°','üé∏','ü¶ä','üê∫','üåô','üíé','üéÆ','ü¶ã','ü§ñ','üêâ','üå∫','üëë','üé≤','ü¶Ö','üåà'];
const EMOJI_CATS={
  'üòä':['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üòâ','üòå','üòç','ü•∞','üòò','üòã','üòõ','üòú','üòé','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','‚òπÔ∏è','üò£','üò¢','üò≠','üò§','üò†','üò°','ü§¨','üòà','üëø','üíÄ','‚ò†Ô∏è','üí©','ü§°','üëª','üëΩ','üëæ','ü§ñ'],
  'üëã':['üëã','ü§ö','üñê','‚úã','üññ','üëå','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üëá','‚òùÔ∏è','üëç','üëé','‚úä','üëä','üëè','üôå','üôè','‚úçÔ∏è','üí™','ü¶æ'],
  '‚ù§Ô∏è':['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù§Ô∏è‚Äçüî•','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù'],
  'üéâ':['üéâ','üéä','üéà','üéÅ','üéÄ','üèÜ','ü•á','ü•à','ü•â','üé≠','üé®','üé≤','üß©','üéØ','üé≥'],
  'üê∂':['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','ü¶Ñ','ü¶ã','üêù','üêõ','üêû'],
  'üå∫':['üå∏','üíê','üåπ','üå∑','üå∫','üåª','üåº','üåø','üçÄ','üçÅ','üçÇ','üå±','üå≤','üå≥','üå¥','üåµ','üåä','üåà','‚õÖ','‚ùÑÔ∏è','üî•','üíß','üåô','‚≠ê','‚ú®','‚ö°'],
  'üçï':['üçï','üçî','üåÆ','üåØ','ü•™','üç£','üç±','üçõ','üçú','üçù','ü•ò','üçû','ü•ê','üßÄ','ü•ö','üç≥','ü•û','ü•ì','üçó','üçñ','üçü','üç∞','üéÇ','üßÅ','üç≠','üç´','üç©','üç™','‚òï','üçµ','üç∫','ü•Ç','üç∑','üç∏','üçπ'],
  '‚öΩ':['‚öΩ','üèÄ','üèà','‚öæ','üéæ','üèê','üèâ','üé±','üèì','üè∏','‚õ≥','üéø','üõ∑','üéØ'],
  'üöÄ':['üöÄ','üõ∏','‚úàÔ∏è','üöÇ','üöÑ','üöá','üöï','üöó','üöô','üõª','üöö','üöí','üöë','üöì','üèé','üèç','üõµ','üö≤','‚õΩ','üöß'],
  'üí°':['üí°','üî¶','üß±','üöø','üõÅ','üß¥','üßπ','üß∫','üßª','üßº','üõí','üö™','üîß','üî®','‚öôÔ∏è','üî©','üí£','‚öîÔ∏è','üõ°','üîÆ','üßø','üíà']
};

// State
let CU=null,CUdata=null;
let currentChatId=null,chatsData={},msgListener=null,chatsListener=null;
let pickerColor=COLORS[0],pickerEmoji=EMOJIS[0];
let gravPickerColor=COLORS[0],gravPickerEmoji=EMOJIS[0];
let currentEmojiCat=Object.keys(EMOJI_CATS)[0];
let avatarPendingData=null,groupAvatarPendingData=null;
let replyTo=null,ctxMsg=null,fwdMsg=null,fwdSelectedChatId=null;
let cropScale=0.6,cropBoxX=0,cropBoxY=0,cropBoxSize=130,cropRawData=null,cropTarget='user';
let cropImgW=0,cropImgH=0,cropContW=400,cropContH=220;
let cropDragging=false,cropDragOffX=0,cropDragOffY=0;
let groupPanelOpen=false;
// My extra photos (stored in localStorage keyed by uid)
let myExtraPhotos=[];

const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const setErr=(id,msg)=>{const e=document.getElementById(id);if(e)e.textContent=msg;};
const setBtn=(id,load,lbl)=>{const b=document.getElementById(id);if(!b)return;b.disabled=load;b.textContent=load?'‚è≥...':lbl;};
const toast=msg=>{const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);};
const fmt=ts=>new Date(ts).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
const fmtFull=ts=>new Date(ts).toLocaleString('ru-RU',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
const fmtDate=ts=>new Date(ts).toLocaleDateString('ru-RU',{day:'numeric',month:'long'});
const strColor=str=>{let h=0;for(let c of str)h=c.charCodeAt(0)+((h<<5)-h);return COLORS[Math.abs(h)%COLORS.length];};

function avHTML(av,name,size=42,cls=''){
  const r=cls.includes('round')?'50%':'12px';
  const photoSrc=av?.photoUrl||av?.photoData;
  if(photoSrc)return`<div class="av ${cls}" style="width:${size}px;height:${size}px;min-width:${size}px;border-radius:${r};overflow:hidden;"><img src="${photoSrc}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'"></div>`;
  const color=av?.color||strColor(name||'?');const emoji=av?.emoji;const letter=(name||'?')[0].toUpperCase();
  const fs=Math.round(size*(emoji?.45:.38));
  return`<div class="av ${cls}" style="width:${size}px;height:${size}px;min-width:${size}px;background:${color};font-size:${fs}px;font-weight:700;color:#fff;border-radius:${r};">${emoji||letter}</div>`;
}
function renderAvInEl(el,av,name,size=42){
  const color=av?.color||strColor(name||'?');const emoji=av?.emoji;const letter=(name||'?')[0].toUpperCase();
  el.style.cssText+=`;width:${size}px;height:${size}px;min-width:${size}px;color:#fff;font-weight:700;`;
  const photoSrc=av?.photoUrl||av?.photoData;
  if(photoSrc){el.textContent='';el.style.background='transparent';let img=el.querySelector('img');if(!img){img=document.createElement('img');img.style='width:100%;height:100%;object-fit:cover;';el.appendChild(img);}img.src=photoSrc;}
  else{const img=el.querySelector('img');if(img)img.remove();el.style.background=color;el.style.fontSize=Math.round(size*(emoji?.45:.38))+'px';el.textContent=emoji||letter;}
}
function updateMyAvBtn(){
  const btn=document.getElementById('my-av-btn');if(!btn||!CUdata)return;
  const av=CUdata.avatar,name=CUdata.name||'?';
  const photoSrc=av?.photoUrl||av?.photoData;
  if(photoSrc){btn.textContent='';btn.style.background='transparent';let img=btn.querySelector('img');if(!img){img=document.createElement('img');img.style='width:100%;height:100%;object-fit:cover;border-radius:8px;';btn.appendChild(img);}img.src=photoSrc;}
  else{const img=btn.querySelector('img');if(img)img.remove();btn.style.background=av?.color||strColor(name);btn.style.fontSize=av?.emoji?'1rem':'.85rem';btn.textContent=av?.emoji||name[0].toUpperCase();}
}
function isAdmin(chat,uid){if(!chat)return false;if(chat.createdBy===uid)return true;return!!(chat.admins&&chat.admins[uid]);}

// ‚îÄ Extra photos helpers ‚îÄ
function getMyPhotos(){return JSON.parse(localStorage.getItem('wave_photos_'+CU?.uid)||'[]');}
function saveMyPhotos(arr){localStorage.setItem('wave_photos_'+CU?.uid,JSON.stringify(arr.slice(0,6)));}

// ‚îÄ AUTH ‚îÄ
window.toggleAuth=showReg=>{
  document.getElementById('login-box').style.display=showReg?'none':'flex';
  document.getElementById('reg-box').style.display=showReg?'flex':'none';
  setErr('login-error','');setErr('reg-error','');
};
window.doRegister=async()=>{
  const name=document.getElementById('reg-name').value.trim();
  const nick=document.getElementById('reg-nick').value.trim().replace(/^@/,'');
  const email=document.getElementById('reg-email').value.trim();
  const pass=document.getElementById('reg-pass').value;
  setErr('reg-error','');
  if(!name){setErr('reg-error','‚úó –í–≤–µ–¥–∏—Ç–µ –∏–º—è');return;}
  if(!nick||nick.length<3){setErr('reg-error','‚úó Username –º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞');return;}
  if(!/^[a-zA-Z0-9_–∞-—è–ê-–Ø—ë–Å]+$/.test(nick)){setErr('reg-error','‚úó –ë—É–∫–≤—ã (–≤–∫–ª—é—á–∞—è —Ä—É—Å.), —Ü–∏—Ñ—Ä—ã –∏ _');return;}
  if(!email){setErr('reg-error','‚úó –í–≤–µ–¥–∏—Ç–µ email');return;}
  if(pass.length<6){setErr('reg-error','‚úó –ü–∞—Ä–æ–ª—å –º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤');return;}
  setBtn('reg-btn',true,'–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí');
  try{
    const ns=await get(query(ref(db,'users'),orderByChild('nickLower'),equalTo(nick.toLowerCase())));
    if(ns.exists()){setErr('reg-error','‚úó @'+nick+' —É–∂–µ –∑–∞–Ω—è—Ç');setBtn('reg-btn',false,'–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí');return;}
    const cred=await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(cred.user,{displayName:name});
    const av={color:COLORS[Math.floor(Math.random()*COLORS.length)],emoji:EMOJIS[Math.floor(Math.random()*EMOJIS.length)]};
    await set(ref(db,`users/${cred.user.uid}`),{uid:cred.user.uid,name,nick,nickLower:nick.toLowerCase(),email,bio:'',createdAt:Date.now(),avatar:av});
  }catch(e){setErr('reg-error','‚úó '+xlate(e.code));setBtn('reg-btn',false,'–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí');}
};
window.doLogin=async()=>{
  const login=document.getElementById('login-id').value.trim().replace(/^@/,'');
  const pass=document.getElementById('login-pass').value;
  setErr('login-error','');
  if(!login){setErr('login-error','‚úó –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω');return;}
  if(!pass){setErr('login-error','‚úó –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');return;}
  setBtn('login-btn',true,'–í–æ–π—Ç–∏ ‚Üí');
  try{
    let email=login;
    if(!login.includes('@')||/\s/.test(login)){
      const snap=await get(query(ref(db,'users'),orderByChild('nickLower'),equalTo(login.toLowerCase())));
      if(!snap.exists()){setErr('login-error','‚úó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');setBtn('login-btn',false,'–í–æ–π—Ç–∏ ‚Üí');return;}
      snap.forEach(c=>{email=c.val().email;});
    }
    await signInWithEmailAndPassword(auth,email,pass);
  }catch(e){setErr('login-error','‚úó '+xlate(e.code));setBtn('login-btn',false,'–í–æ–π—Ç–∏ ‚Üí');}
};
window.doLogout=async()=>{
  if(msgListener&&currentChatId)off(ref(db,`chats/${currentChatId}/messages`));
  if(chatsListener)off(ref(db,`userChats/${CU?.uid}`));
  currentChatId=null;chatsData={};CUdata=null;groupPanelOpen=false;
  await signOut(auth);
};

onAuthStateChanged(auth,async user=>{
  if(user){
    CU=user;
    const snap=await get(ref(db,`users/${user.uid}`));
    CUdata=snap.exists()?snap.val():{name:user.displayName||'?',nick:'',avatar:null,bio:''};
    document.getElementById('auth-screen').style.display='none';
    document.getElementById('app-screen').classList.add('visible');
    setBtn('login-btn',false,'–í–æ–π—Ç–∏ ‚Üí');setBtn('reg-btn',false,'–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç ‚Üí');
    updateMyAvBtn();checkInviteParam();loadChats();initEmojiPicker();initStickerPicker();
    ensureFavoritesChat();
  }else{
    CU=null;CUdata=null;
    document.getElementById('auth-screen').style.display='flex';
    document.getElementById('app-screen').classList.remove('visible');
    document.getElementById('chat-list').innerHTML='';
    document.getElementById('messages').innerHTML='';
    showEmpty();
  }
});

// ‚îÄ FAVORITES CHAT ‚îÄ
// The favorites chat is a virtual chat stored with special key: 'fav_<uid>'
// We store it in userChats but type='favorites'; no members except self.
const FAV_CHAT_ID_KEY='wave_fav_chat_id_';
function getFavChatId(){return localStorage.getItem(FAV_CHAT_ID_KEY+(CU?.uid||''));}
function setFavChatId(id){localStorage.setItem(FAV_CHAT_ID_KEY+(CU?.uid||''),id);}

async function ensureFavoritesChat(){
  // Check if we already have it
  let favId=getFavChatId();
  if(favId){
    const snap=await get(ref(db,`chats/${favId}`));
    if(snap.exists())return;
  }
  // Create new favorites chat
  const r=push(ref(db,'chats'));
  await set(r,{type:'favorites',name:'‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ',members:{[CU.uid]:true},createdBy:CU.uid,createdAt:Date.now(),avatar:{color:'#d97706',emoji:'‚≠ê'}});
  await set(ref(db,`userChats/${CU.uid}/${r.key}`),true);
  setFavChatId(r.key);
}

window.openFavoritesChat=()=>{
  const favId=getFavChatId();
  if(!favId){toast('‚úó –ó–∞–≥—Ä—É–∑–∫–∞...');return;}
  const chat=chatsData[favId];
  if(chat){openChat(favId,chat);switchTab('chats');}
  else{toast('‚úó –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');ensureFavoritesChat();}
};

// ‚îÄ TABS ‚îÄ
window.switchTab=tab=>{
  ['chats','search','favs'].forEach(t=>{
    document.getElementById('tab-'+t).classList.toggle('active',t===tab);
    document.getElementById('pane-'+t).style.display=t===tab?'flex':'none';
  });
  if(tab==='search')document.getElementById('user-search-input').focus();
};
document.getElementById('pane-chats').style.display='flex';
document.getElementById('pane-search').style.display='none';
document.getElementById('pane-favs').style.display='none';

// ‚îÄ USER SEARCH ‚îÄ
let searchTimer=null;
window.searchUsers=val=>{
  clearTimeout(searchTimer);
  const q=val.trim().replace(/^@/,'');
  const res=document.getElementById('user-search-results');
  if(!q){res.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--muted);">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ @–Ω–∏–∫</div>';return;}
  res.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--muted);">–ò—â—É...</div>';
  searchTimer=setTimeout(async()=>{
    try{
      const snap=await get(ref(db,'users'));
      const ql=q.toLowerCase();const found=[];
      snap.forEach(c=>{const u=c.val();if(u.uid!==CU?.uid&&(u.nickLower?.includes(ql)||u.name?.toLowerCase().includes(ql)))found.push(u);});
      res.innerHTML='';
      if(!found.length){res.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--muted);">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';return;}
      found.forEach(u=>{
        const div=document.createElement('div');div.className='user-item';
        div.innerHTML=`${avHTML(u.avatar,u.name,40)}<div class="user-item-info"><div class="user-item-name">${esc(u.name)}</div><div class="user-item-nick">@${esc(u.nick||u.nickLower||'')}</div></div><button class="user-item-btn">–ü—Ä–æ—Ñ–∏–ª—å</button>`;
        div.querySelector('button').onclick=()=>showUserModal(u);
        res.appendChild(div);
      });
    }catch(e){res.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--danger);">–û—à–∏–±–∫–∞</div>';}
  },400);
};

// ‚îÄ CHATS ‚îÄ
function loadChats(){
  chatsListener=onValue(ref(db,`userChats/${CU.uid}`),async snap=>{
    const ids=Object.keys(snap.val()||{});
    if(!ids.length){renderChatList({});return;}
    const results=await Promise.all(ids.map(id=>get(ref(db,`chats/${id}`))));
    chatsData={};
    results.forEach(r=>{if(r.exists())chatsData[r.key]=r.val();});
    ids.forEach(id=>{
      onValue(query(ref(db,`chats/${id}/messages`),orderByChild('ts'),limitToLast(1)),s=>{
        const v=s.val();
        if(v&&chatsData[id])chatsData[id].lastMsg=Object.values(v)[0];
        renderChatList(chatsData);
      });
    });
  });
}
function renderChatList(data){
  const list=document.getElementById('chat-list');
  const q=(document.getElementById('chat-search').value||'').toLowerCase();
  const favId=getFavChatId();
  const sorted=Object.entries(data)
    .filter(([,c])=>chatName(c).toLowerCase().includes(q))
    .sort(([ia,a],[ib,b])=>{
      if(ia===favId)return -1;if(ib===favId)return 1;
      return(b.lastMsg?.ts||b.createdAt||0)-(a.lastMsg?.ts||a.createdAt||0);
    });
  list.innerHTML='';
  if(!sorted.length){list.innerHTML='<div style="padding:16px;font-size:.76rem;color:var(--muted);">–ù–µ—Ç —á–∞—Ç–æ–≤</div>';return;}
  sorted.forEach(([id,c])=>{
    const name=chatName(c);const av=chatAv(c);const isFav=id===favId;
    const item=document.createElement('div');
    item.className='chat-item'+(id===currentChatId?' active':'');
    item.dataset.chatId=id;
    let preview='...';
    if(c.lastMsg){
      const lm=c.lastMsg;
      if(lm.type==='image')preview='üñº –§–æ—Ç–æ';
      else if(lm.type==='video')preview='üé¨ –í–∏–¥–µ–æ';
      else if(lm.type==='audio')preview='üéô –ì–æ–ª–æ—Å–æ–≤–æ–µ';
      else if(lm.type==='videonote')preview='‚≠ï –í–∏–¥–µ–æ–∫—Ä—É–∂–æ–∫';
      else if(lm.type==='file')preview='üìé '+(lm.fileName||'–§–∞–π–ª');
      else if(lm.type==='sticker')preview='üé≠ –°—Ç–∏–∫–µ—Ä';
      else preview=lm.text||'...';
      if(lm.forwarded)preview='‚Ü™ '+preview;
      if(lm.replyTo)preview='‚Ü© '+preview;
    }
    item.innerHTML=`${avHTML(av,name,42,c.type==='group'||c.type==='favorites'?'round':'')}
      <div class="chat-info"><div class="chat-name">${esc(name)}</div><div class="chat-preview">${esc(preview.substring(0,36))}</div></div>
      <div class="chat-meta"><span class="chat-time">${c.lastMsg?.ts?fmt(c.lastMsg.ts):''}</span></div>
      ${isFav?'<span class="chat-item-fav">‚òÖ</span>':''}`;
    item.onclick=()=>openChat(id,c);
    list.appendChild(item);
  });
}
window.filterChats=()=>renderChatList(chatsData);

function chatName(c){
  if(c.type==='favorites')return'‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ';
  if(c.type==='group')return c.name||'–ì—Ä—É–ø–ø–∞';
  if(c.names){const o=Object.entries(c.names).find(([uid])=>uid!==CU?.uid);return o?o[1]:'–ß–∞—Ç';}
  return'–ß–∞—Ç';
}
function chatAv(c){
  if(c.type==='favorites')return{color:'#d97706',emoji:'‚≠ê'};
  if(c.type==='group')return c.avatar||{color:'#7c3aed',emoji:'üë•'};
  if(c.avatars){const o=Object.entries(c.avatars).find(([uid])=>uid!==CU?.uid);return o?o[1]:null;}
  return null;
}

// Favorites (chat-pin level)
function getFavChats(){return new Set(JSON.parse(localStorage.getItem('wave_fav_chats')||'[]'));}
function setFavChats(s){localStorage.setItem('wave_fav_chats',JSON.stringify([...s]));}
window.toggleChatFavorite=()=>{
  if(!currentChatId||currentChatId===getFavChatId())return;
  const favs=getFavChats();const isFav=favs.has(currentChatId);
  if(isFav)favs.delete(currentChatId);else favs.add(currentChatId);
  setFavChats(favs);updateFavTopbarBtn();renderChatList(chatsData);
  toast(isFav?'–£–±—Ä–∞–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ':'‚òÖ –ß–∞—Ç –∑–∞–∫—Ä–µ–ø–ª—ë–Ω');
};
function updateFavTopbarBtn(){
  const btn=document.getElementById('fav-topbar-btn');if(!btn||!currentChatId)return;
  const isFav=getFavChats().has(currentChatId)||currentChatId===getFavChatId();
  btn.textContent=isFav?'‚òÖ':'‚òÜ';btn.style.color=isFav?'var(--accent2)':'var(--muted)';
}

// ‚îÄ OPEN CHAT ‚îÄ
window.openChat=(chatId,chat)=>{
  if(msgListener&&currentChatId)off(ref(db,`chats/${currentChatId}/messages`));
  currentChatId=chatId;cancelReply();
  document.getElementById('sidebar').classList.add('hidden');
  document.getElementById('chat-area').classList.add('visible');
  document.getElementById('empty-placeholder').style.display='none';
  document.getElementById('active-chat').style.display='flex';
  const name=chatName(chat);
  document.getElementById('topbar-name').textContent=name;
  const tav=document.getElementById('topbar-av');
  tav.className='av'+(chat.type==='group'||chat.type==='favorites'?' round':'');
  renderAvInEl(tav,chatAv(chat),name,40);
  const isGroup=chat.type==='group';
  const isFav=chat.type==='favorites';
  document.getElementById('topbar-status').textContent=isGroup?`${Object.keys(chat.members||{}).length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`:isFav?'–¢–æ–ª—å–∫–æ –¥–ª—è –≤–∞—Å':'–æ–Ω–ª–∞–π–Ω';
  document.getElementById('group-panel-btn').style.display=isGroup?'flex':'none';
  // Hide group panel when switching
  if(groupPanelOpen&&!isGroup){groupPanelOpen=false;document.getElementById('group-panel').classList.remove('open');}
  if(groupPanelOpen&&isGroup)populateGroupPanel();
  document.querySelectorAll('.chat-item').forEach(el=>el.classList.toggle('active',el.dataset.chatId===chatId));
  updateFavTopbarBtn();
  // Mark messages as read
  markRead(chatId);
  loadMessages(chatId);
};
window.goBack=()=>{document.getElementById('sidebar').classList.remove('hidden');document.getElementById('chat-area').classList.remove('visible');};

// Mark read
async function markRead(chatId){
  if(!CU)return;
  const now=Date.now();
  await update(ref(db,`chats/${chatId}/read/${CU.uid}`),{ts:now,name:CUdata?.name||'?'});
}

// ‚îÄ MESSAGES ‚îÄ
function loadMessages(chatId){
  const el=document.getElementById('messages');el.innerHTML='';
  msgListener=onValue(query(ref(db,`chats/${chatId}/messages`),orderByChild('ts'),limitToLast(100)),s=>{
    const chat=chatsData[chatId];
    renderMessages(s.val()||{},chat);
    // Update read receipt when new messages arrive
    markRead(chatId);
  });
}

function renderMessages(data,chat){
  const el=document.getElementById('messages');
  const atBot=el.scrollHeight-el.scrollTop<=el.clientHeight+80;
  el.innerHTML='';
  const msgs=Object.entries(data).map(([k,v])=>({...v,_key:k})).sort((a,b)=>a.ts-b.ts);
  const readData=chat?.read||{};
  const members=chat?.members||{};
  let lastDate=null;
  msgs.forEach(msg=>{
    const ds=fmtDate(msg.ts);
    if(ds!==lastDate){const d=document.createElement('div');d.className='date-divider';d.innerHTML=`<span>${ds}</span>`;el.appendChild(d);lastDate=ds;}
    const sent=msg.uid===CU.uid;
    const canDelete=sent||(chat&&isAdmin(chat,CU.uid));
    const g=document.createElement('div');g.className='msg-group '+(sent?'sent':'recv');

    if(!sent&&chat?.type==='group'){const s=document.createElement('div');s.className='msg-sender';s.textContent=msg.senderName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';s.onclick=()=>openUserById(msg.uid);g.appendChild(s);}

    const b=document.createElement('div');b.className='msg-bubble';
    if(msg.forwarded){const fl=document.createElement('div');fl.className='fwd-label';fl.textContent='‚Ü™ –ü–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–µ –æ—Ç '+esc(msg.originalSender||'?');b.appendChild(fl);}
    if(msg.replyTo){
      const rp=document.createElement('div');rp.className='reply-preview';
      rp.innerHTML=`<div class="reply-preview-name">${esc(msg.replyTo.senderName||'?')}</div><div class="reply-preview-text">${esc(msg.replyTo.text||'')}</div>`;
      rp.onclick=e=>{e.stopPropagation();scrollToMsg(msg.replyTo.key);};b.appendChild(rp);
    }
    // Render message content based on type
    if(msg.type==='sticker'){
      const sEl=document.createElement('span');sEl.style.fontSize='3.5rem';sEl.style.cursor='default';sEl.textContent=msg.sticker||'';b.appendChild(sEl);
      b.style.background='transparent';b.style.border='none';b.style.padding='2px';
    }else if(msg.type==='image'&&msg.mediaUrl){
      const img=document.createElement('img');img.className='msg-image';img.src=msg.mediaUrl;img.alt='–§–æ—Ç–æ';
      img.onclick=ev=>{ev.stopPropagation();openLightbox(msg.mediaUrl,'image');};b.appendChild(img);
      if(msg.text){const t=document.createElement('div');t.textContent=msg.text;t.style.marginTop='5px';b.appendChild(t);}
    }else if(msg.type==='video'&&msg.mediaUrl){
      const vid=document.createElement('video');vid.className='msg-video';vid.src=msg.mediaUrl;vid.controls=true;vid.preload='metadata';b.appendChild(vid);
      if(msg.text){const t=document.createElement('div');t.textContent=msg.text;t.style.marginTop='5px';b.appendChild(t);}
    }else if(msg.type==='videonote'&&msg.mediaUrl){
      const vn=document.createElement('div');vn.className='msg-video-note';
      const vid=document.createElement('video');vid.src=msg.mediaUrl;vid.preload='metadata';vid.loop=true;
      const play=document.createElement('div');play.className='msg-video-note-play';play.textContent='‚ñ∂';
      vn.appendChild(vid);vn.appendChild(play);
      vn.onclick=ev=>{ev.stopPropagation();if(vid.paused){vid.play();play.style.display='none';}else{vid.pause();play.style.display='flex';}};
      b.appendChild(vn);b.style.background='transparent';b.style.border='none';b.style.padding='0';
    }else if(msg.type==='audio'&&msg.mediaUrl){
      const audioEl=buildAudioPlayer(msg.mediaUrl,msg.audioDuration||0);b.appendChild(audioEl);
    }else if(msg.type==='file'&&msg.mediaUrl){
      const fb=document.createElement('div');fb.className='msg-file-bubble';
      const ext=(msg.fileName||'').split('.').pop().toLowerCase();
      const icons={pdf:'üìÑ',doc:'üìù',docx:'üìù',xls:'üìä',xlsx:'üìä',zip:'üóú',rar:'üóú',mp3:'üéµ',wav:'üéµ',txt:'üìÑ'};
      fb.innerHTML=`<div class="msg-file-icon">${icons[ext]||'üìÅ'}</div><div class="msg-file-info"><div class="msg-file-name">${esc(msg.fileName||'–§–∞–π–ª')}</div><div class="msg-file-size">${msg.fileSize||''}</div></div><span style="font-size:.9rem;opacity:.7;">‚Üì</span>`;
      fb.onclick=ev=>{ev.stopPropagation();window.open(msg.mediaUrl,'_blank');};b.appendChild(fb);
    }else{
      const textNode=document.createElement('div');textNode.textContent=msg.text||'';b.appendChild(textNode);
    }
    b.addEventListener('click',e=>{e.stopPropagation();openCtxMenu(e,msg,canDelete,chat,readData);});
    g.appendChild(b);

    // Time + read status
    const metaRow=document.createElement('div');metaRow.className='msg-meta-row';
    const timeEl=document.createElement('span');timeEl.className='msg-time';timeEl.textContent=fmt(msg.ts);metaRow.appendChild(timeEl);
    if(sent){
      // Delivery: always ‚úì (message is in db = delivered)
      // Read: check if any other member has read ts >= msg.ts
      const readers=Object.entries(readData).filter(([uid,rd])=>uid!==CU.uid&&rd.ts>=msg.ts);
      const statusEl=document.createElement('span');
      if(readers.length>0){
        statusEl.className='msg-status read';statusEl.textContent='‚úì‚úì';
        statusEl.title=readers.map(([,rd])=>`${rd.name} ‚Äî ${fmtFull(rd.ts)}`).join('\n');
      }else{statusEl.className='msg-status delivered';statusEl.textContent='‚úì';}
      metaRow.appendChild(statusEl);
    }
    g.appendChild(metaRow);

    // Reactions
    const reactions=msg.reactions||{};
    const hasR=Object.values(reactions).some(u=>Object.keys(u).length>0);
    if(hasR){
      const rw=document.createElement('div');rw.className='msg-reactions';
      ['thumbs_up','heart','thumbs_down'].forEach(rKey=>{
        const em={'thumbs_up':'üëç','heart':'‚ù§Ô∏è','thumbs_down':'üëé'};
        const users=reactions[rKey]||{};const count=Object.keys(users).length;
        if(count>0){
          const pill=document.createElement('div');pill.className='reaction-pill'+(users[CU.uid]?' mine':'');
          pill.innerHTML=`${em[rKey]} <span class="reaction-count">${count}</span>`;
          pill.title=Object.values(users).join(', ');
          pill.onclick=e=>{e.stopPropagation();toggleReaction(msg._key,rKey,users);};
          rw.appendChild(pill);
        }
      });g.appendChild(rw);
    }
    g.dataset.msgKey=msg._key;
    el.appendChild(g);
  });
  if(atBot||msgs.length<=20)el.scrollTop=el.scrollHeight;
}

function scrollToMsg(key){
  const el=document.querySelector(`[data-msg-key="${key}"]`);
  if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.outline='2px solid var(--accent2)';setTimeout(()=>el.style.outline='',1500);}
}

// ‚îÄ CONTEXT MENU ‚îÄ
function openCtxMenu(e,msg,canDelete,chat,readData){
  ctxMsg=msg;
  const menu=document.getElementById('ctx-menu');
  const rr=document.getElementById('ctx-reactions');rr.innerHTML='';
  const emojiMap={'thumbs_up':'üëç','heart':'‚ù§Ô∏è','thumbs_down':'üëé'};
  Object.entries(emojiMap).forEach(([rKey,emoji])=>{
    const users=(msg.reactions||{})[rKey]||{};
    const btn=document.createElement('button');btn.className='ctx-react-btn'+(users[CU.uid]?' active':'');
    btn.textContent=emoji;
    btn.onclick=()=>{toggleReaction(msg._key,rKey,users);menu.classList.remove('show');};
    rr.appendChild(btn);
  });
  document.getElementById('ctx-reply').onclick=()=>{setReplyTo(msg);menu.classList.remove('show');};
  document.getElementById('ctx-forward').onclick=()=>{openForwardModal(msg);menu.classList.remove('show');};
  document.getElementById('ctx-save-fav').onclick=()=>{saveMsgToFav(msg);menu.classList.remove('show');};
  document.getElementById('ctx-copy').onclick=()=>{navigator.clipboard.writeText(msg.text||'').then(()=>toast('‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'));menu.classList.remove('show');};
  // Read-by (group)
  const readByEl=document.getElementById('ctx-read-by');
  if(chat?.type==='group'&&msg.uid===CU.uid){
    readByEl.style.display='flex';
    readByEl.onclick=()=>{showReadByTooltip(e,msg,readData);menu.classList.remove('show');};
  }else readByEl.style.display='none';
  const delEl=document.getElementById('ctx-delete');
  delEl.style.display=canDelete?'flex':'none';
  delEl.onclick=()=>{deleteMessage(msg._key);menu.classList.remove('show');};

  menu.classList.add('show');
  const vw=window.innerWidth,vh=window.innerHeight;
  let x=e.clientX,y=e.clientY;
  const mw=menu.offsetWidth,mh=menu.offsetHeight;
  if(x+mw>vw-10)x=vw-mw-10;
  if(y+mh>vh-10)y=vh-mh-10;
  menu.style.left=x+'px';menu.style.top=y+'px';
}

function showReadByTooltip(e,msg,readData){
  const readers=Object.entries(readData).filter(([uid,rd])=>uid!==CU.uid&&rd.ts>=msg.ts);
  const tip=document.getElementById('read-tooltip');
  if(!readers.length){tip.innerHTML='<div class="read-tooltip-title">üëÅ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ</div><div class="read-tooltip-item">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–ª</div>';}
  else{
    tip.innerHTML=`<div class="read-tooltip-title">üëÅ –ü—Ä–æ—á–∏—Ç–∞–ª–∏ (${readers.length})</div>`+
      readers.map(([,rd])=>`<div class="read-tooltip-item">${esc(rd.name)} ‚Äî ${fmtFull(rd.ts)}</div>`).join('');
  }
  const vw=window.innerWidth,vh=window.innerHeight;
  let x=e.clientX,y=e.clientY;
  tip.style.display='block';
  const tw=tip.offsetWidth,th=tip.offsetHeight;
  if(x+tw>vw-10)x=vw-tw-10;if(y+th>vh-10)y=vh-th-10;
  tip.style.left=x+'px';tip.style.top=y+'px';
  setTimeout(()=>tip.style.display='none',4000);
}
document.addEventListener('click',()=>{
  document.getElementById('ctx-menu').classList.remove('show');
  document.getElementById('read-tooltip').style.display='none';
});
document.addEventListener('keydown',e=>{if(e.key==='Escape'){document.getElementById('ctx-menu').classList.remove('show');cancelReply();}});

// ‚îÄ REACTIONS ‚îÄ
async function toggleReaction(msgKey,reactionKey,currentUsers){
  if(!currentChatId)return;
  const path=`chats/${currentChatId}/messages/${msgKey}/reactions/${reactionKey}`;
  const name=CUdata?.name||CU.displayName||'?';
  if(currentUsers[CU.uid])await remove(ref(db,`${path}/${CU.uid}`));
  else await set(ref(db,`${path}/${CU.uid}`),name);
}
async function deleteMessage(msgKey){
  if(!currentChatId)return;if(!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?'))return;
  await remove(ref(db,`chats/${currentChatId}/messages/${msgKey}`));toast('‚úì –£–¥–∞–ª–µ–Ω–æ');
}

// ‚îÄ SAVE TO FAV CHAT ‚îÄ
async function saveMsgToFav(msg){
  const favId=getFavChatId();if(!favId){toast('‚úó –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');return;}
  const senderName=CUdata?.name||'?';
  await push(ref(db,`chats/${favId}/messages`),{
    text:msg.text,uid:CU.uid,senderName,ts:Date.now(),
    forwarded:true,originalSender:msg.senderName||'?'
  });
  toast('‚≠ê –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ');
}

// ‚îÄ REPLY ‚îÄ
function getMsgPreviewText(msg){
  if(msg.type==='image')return'üñº –§–æ—Ç–æ';
  if(msg.type==='video')return'üé¨ –í–∏–¥–µ–æ';
  if(msg.type==='audio')return'üéô –ì–æ–ª–æ—Å–æ–≤–æ–µ';
  if(msg.type==='videonote')return'‚≠ï –í–∏–¥–µ–æ–∫—Ä—É–∂–æ–∫';
  if(msg.type==='file')return'üìé '+(msg.fileName||'–§–∞–π–ª');
  if(msg.type==='sticker')return'üé≠ –°—Ç–∏–∫–µ—Ä';
  return msg.text||'';
}
function setReplyTo(msg){
  replyTo={key:msg._key,senderName:msg.senderName||'?',text:getMsgPreviewText(msg)};
  document.getElementById('reply-bar-name').textContent=replyTo.senderName;
  document.getElementById('reply-bar-text').textContent=replyTo.text;
  document.getElementById('reply-bar').classList.add('show');
  document.getElementById('msg-input').focus();
}
window.cancelReply=()=>{replyTo=null;document.getElementById('reply-bar').classList.remove('show');};

// ‚îÄ FORWARD ‚îÄ
function openForwardModal(msg){
  fwdMsg=msg;fwdSelectedChatId=null;
  document.getElementById('fwd-msg-preview').textContent='¬´'+((msg.text||'').substring(0,60))+'¬ª';
  const list=document.getElementById('fwd-chat-list');list.innerHTML='';
  Object.entries(chatsData).forEach(([id,c])=>{
    const item=document.createElement('div');item.className='fwd-chat-item';
    item.innerHTML=`${avHTML(chatAv(c),chatName(c),36,c.type==='group'||c.type==='favorites'?'round':'')}<div><div class="fwd-chat-name">${esc(chatName(c))}</div><div class="fwd-chat-type">${c.type==='group'?'–ì—Ä—É–ø–ø–∞':c.type==='favorites'?'–ò–∑–±—Ä–∞–Ω–Ω–æ–µ':'–õ–∏—á–Ω—ã–π'}</div></div>`;
    item.onclick=()=>{list.querySelectorAll('.fwd-chat-item').forEach(el=>el.classList.remove('sel'));item.classList.add('sel');fwdSelectedChatId=id;};
    list.appendChild(item);
  });
  document.getElementById('forward-modal').classList.add('open');
}
window.doForward=async()=>{
  if(!fwdMsg||!fwdSelectedChatId){toast('‚úó –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç');return;}
  const senderName=CUdata?.name||'?';const originalSender=fwdMsg.senderName||'?';
  await push(ref(db,`chats/${fwdSelectedChatId}/messages`),{text:fwdMsg.text,uid:CU.uid,senderName,ts:Date.now(),forwarded:true,originalSender});
  await update(ref(db,`chats/${fwdSelectedChatId}`),{lastMsgTs:Date.now()});
  closeModal('forward-modal');toast('‚úì –ü–µ—Ä–µ—Å–ª–∞–Ω–æ');
};

// ‚îÄ SEND ‚îÄ
window.sendMessage=async()=>{
  const inp=document.getElementById('msg-input');
  const text=inp.value.trim();if(!text||!currentChatId)return;
  inp.value='';inp.style.height='auto';
  const senderName=CUdata?.name||'?';
  const msgData={text,uid:CU.uid,senderName,ts:Date.now()};
  if(replyTo)msgData.replyTo=replyTo;
  cancelReply();
  await push(ref(db,`chats/${currentChatId}/messages`),msgData);
  await update(ref(db,`chats/${currentChatId}`),{lastMsgTs:Date.now()});
};
window.handleKey=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}};
window.autoResize=el=>{el.style.height='auto';el.style.height=Math.min(el.scrollHeight,110)+'px';};

// ‚îÄ LIGHTBOX ‚îÄ
window.openLightbox=(src,type)=>{
  const box=document.getElementById('lightbox');
  const cont=document.getElementById('lightbox-content');
  cont.innerHTML='';
  if(type==='image'){const img=document.createElement('img');img.src=src;cont.appendChild(img);}
  else{const vid=document.createElement('video');vid.src=src;vid.controls=true;vid.autoplay=true;cont.appendChild(vid);}
  box.classList.add('open');
};
window.closeLightbox=()=>{
  document.getElementById('lightbox').classList.remove('open');
  document.getElementById('lightbox-content').querySelectorAll('video').forEach(v=>v.pause());
};

// ‚îÄ AUDIO PLAYER ‚îÄ
function buildAudioPlayer(url,dur){
  const wrap=document.createElement('div');wrap.className='msg-audio';
  const playBtn=document.createElement('button');playBtn.className='audio-play-btn';playBtn.textContent='‚ñ∂';
  const waveform=document.createElement('div');waveform.className='audio-waveform';
  const barCount=24;
  for(let i=0;i<barCount;i++){const bar=document.createElement('div');bar.className='audio-bar';bar.style.height=(Math.random()*18+6)+'px';waveform.appendChild(bar);}
  const durationEl=document.createElement('span');durationEl.className='audio-duration';durationEl.textContent=formatAudioDur(dur);
  const audio=new Audio(url);
  audio.addEventListener('timeupdate',()=>{
    const pct=audio.duration?audio.currentTime/audio.duration:0;
    const bars=waveform.querySelectorAll('.audio-bar');
    bars.forEach((b,i)=>b.classList.toggle('played',i<Math.floor(pct*barCount)));
    durationEl.textContent=formatAudioDur(audio.duration-audio.currentTime);
  });
  audio.addEventListener('ended',()=>{playBtn.textContent='‚ñ∂';waveform.querySelectorAll('.audio-bar').forEach(b=>b.classList.remove('played'));durationEl.textContent=formatAudioDur(dur);});
  playBtn.onclick=()=>{if(audio.paused){audio.play();playBtn.textContent='‚è∏';}else{audio.pause();playBtn.textContent='‚ñ∂';}};
  wrap.appendChild(playBtn);wrap.appendChild(waveform);wrap.appendChild(durationEl);
  return wrap;
}
function formatAudioDur(s){if(!s||isNaN(s))return'0:00';const m=Math.floor(s/60);const sec=Math.floor(s%60);return m+':'+(sec<10?'0':'')+sec;}

// ‚îÄ ATTACH MENU ‚îÄ
window.toggleAttachMenu=e=>{
  e.stopPropagation();
  const m=document.getElementById('attach-menu');
  const sp=document.getElementById('sticker-picker');
  const ep=document.getElementById('emoji-picker');
  sp.classList.remove('open');ep.classList.remove('open');
  m.classList.toggle('open');
};
window.pickMedia=type=>{
  document.getElementById('attach-menu').classList.remove('open');
  if(type==='image')document.getElementById('media-input').click();
  else document.getElementById('file-input').click();
};
document.addEventListener('click',e=>{
  const m=document.getElementById('attach-menu');
  if(m&&m.classList.contains('open')&&!m.contains(e.target)&&!e.target.closest('[onclick*="toggleAttachMenu"]'))m.classList.remove('open');
  const sp=document.getElementById('sticker-picker');
  if(sp&&sp.classList.contains('open')&&!sp.contains(e.target)&&!e.target.closest('[onclick*="toggleStickerPicker"]'))sp.classList.remove('open');
});

// ‚îÄ MEDIA UPLOAD ‚îÄ
async function uploadToStorage(file,path){
  const storRef=sref(storage,path);
  const snap=await uploadBytes(storRef,file,{contentType:file.type});
  return await getDownloadURL(snap.ref);
}
function formatBytes(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB';}

window.handleMediaFile=async e=>{
  const file=e.target.files[0];if(!file||!currentChatId)return;
  if(file.size>50*1024*1024){toast('‚úó –ú–∞–∫—Å–∏–º—É–º 50MB');return;}
  const isVideo=file.type.startsWith('video/');
  toast('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...');
  try{
    const path=`media/${currentChatId}/${Date.now()}_${file.name}`;
    const url=await uploadToStorage(file,path);
    const senderName=CUdata?.name||'?';
    await push(ref(db,`chats/${currentChatId}/messages`),{type:isVideo?'video':'image',mediaUrl:url,uid:CU.uid,senderName,ts:Date.now(),text:''});
    await update(ref(db,`chats/${currentChatId}`),{lastMsgTs:Date.now()});
    toast('‚úì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
  }catch(err){console.error(err);toast('‚úó –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');}
  e.target.value='';
};

window.handleFileAttach=async e=>{
  const file=e.target.files[0];if(!file||!currentChatId)return;
  if(file.size>100*1024*1024){toast('‚úó –ú–∞–∫—Å–∏–º—É–º 100MB');return;}
  toast('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...');
  try{
    const path=`files/${currentChatId}/${Date.now()}_${file.name}`;
    const url=await uploadToStorage(file,path);
    const senderName=CUdata?.name||'?';
    await push(ref(db,`chats/${currentChatId}/messages`),{type:'file',mediaUrl:url,fileName:file.name,fileSize:formatBytes(file.size),uid:CU.uid,senderName,ts:Date.now()});
    await update(ref(db,`chats/${currentChatId}`),{lastMsgTs:Date.now()});
    toast('‚úì –§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
  }catch(err){console.error(err);toast('‚úó –û—à–∏–±–∫–∞');}
  e.target.value='';
};

// ‚îÄ AUDIO RECORDING ‚îÄ
let mediaRecorder=null,audioChunks=[],recordTimer=null,recordStart=0,isRecordingVideo=false;
window.toggleRecord=async()=>{
  if(isRecordingVideo){toast('‚úó –°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ –≤–∏–¥–µ–æ–∫—Ä—É–∂–æ–∫');return;}
  const btn=document.getElementById('record-btn');
  const timerEl=document.getElementById('record-timer');
  if(mediaRecorder&&mediaRecorder.state!=='inactive'){
    mediaRecorder.stop();return;
  }
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    audioChunks=[];
    const opts=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?{mimeType:'audio/webm;codecs=opus'}:{};
    mediaRecorder=new MediaRecorder(stream,opts);
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data);};
    mediaRecorder.onstop=async()=>{
      stream.getTracks().forEach(t=>t.stop());
      btn.classList.remove('recording');btn.textContent='üéô';
      timerEl.classList.remove('show');clearInterval(recordTimer);
      if(!currentChatId||audioChunks.length===0)return;
      const dur=Math.round((Date.now()-recordStart)/1000);
      toast('‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...');
      try{
        const blob=new Blob(audioChunks,{type:audioChunks[0].type||'audio/webm'});
        const path=`audio/${currentChatId}/${Date.now()}.webm`;
        const url=await uploadToStorage(blob,path);
        const senderName=CUdata?.name||'?';
        await push(ref(db,`chats/${currentChatId}/messages`),{type:'audio',mediaUrl:url,audioDuration:dur,uid:CU.uid,senderName,ts:Date.now()});
        await update(ref(db,`chats/${currentChatId}`),{lastMsgTs:Date.now()});
        toast('‚úì –ì–æ–ª–æ—Å–æ–≤–æ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
      }catch(e){console.error(e);toast('‚úó –û—à–∏–±–∫–∞');}
    };
    mediaRecorder.start(250);
    btn.classList.add('recording');btn.textContent='‚èπ';
    timerEl.classList.add('show');
    recordStart=Date.now();
    recordTimer=setInterval(()=>{
      const s=Math.floor((Date.now()-recordStart)/1000);
      timerEl.textContent=(Math.floor(s/60)+'').padStart(2,'0')+':'+(s%60+'').padStart(2,'0');
      if(s>=120){mediaRecorder.stop();}
    },500);
  }catch(e){toast('‚úó –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');}
};

// ‚îÄ VIDEO NOTE ‚îÄ
let videoNoteStream=null,videoNoteRecorder=null,videoNoteChunks=[],videoNoteTimer=null;
window.startVideoNote=async()=>{
  document.getElementById('attach-menu').classList.remove('open');
  try{
    videoNoteStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:400,height:400},audio:true});
    const preview=document.getElementById('videonote-preview');
    preview.srcObject=videoNoteStream;
    document.getElementById('videonote-modal').classList.add('open');
    document.getElementById('videonote-btn').textContent='‚óè –ó–∞–ø–∏—Å—å';
    isRecordingVideo=false;
  }catch(e){toast('‚úó –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');}
};
window.closeVideoNote=()=>{
  if(videoNoteRecorder&&videoNoteRecorder.state!=='inactive')videoNoteRecorder.stop();
  if(videoNoteStream)videoNoteStream.getTracks().forEach(t=>t.stop());
  clearInterval(videoNoteTimer);
  isRecordingVideo=false;
  closeModal('videonote-modal');
};
window.toggleVideoNoteRec=async()=>{
  if(!isRecordingVideo){
    videoNoteChunks=[];
    const opts=MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus')?{mimeType:'video/webm;codecs=vp9,opus'}:{};
    videoNoteRecorder=new MediaRecorder(videoNoteStream,opts);
    videoNoteRecorder.ondataavailable=e=>{if(e.data.size>0)videoNoteChunks.push(e.data);};
    videoNoteRecorder.onstop=async()=>{
      clearInterval(videoNoteTimer);
      document.getElementById('videonote-rec-indicator').style.display='none';
      document.getElementById('videonote-btn').textContent='‚óè –ó–∞–ø–∏—Å—å';
      isRecordingVideo=false;
      closeVideoNote();
      if(!currentChatId||videoNoteChunks.length===0)return;
      toast('‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫—Ä—É–∂–∫–∞...');
      try{
        const blob=new Blob(videoNoteChunks,{type:'video/webm'});
        const path=`videonotes/${currentChatId}/${Date.now()}.webm`;
        const url=await uploadToStorage(blob,path);
        const senderName=CUdata?.name||'?';
        await push(ref(db,`chats/${currentChatId}/messages`),{type:'videonote',mediaUrl:url,uid:CU.uid,senderName,ts:Date.now()});
        await update(ref(db,`chats/${currentChatId}`),{lastMsgTs:Date.now()});
        toast('‚úì –ö—Ä—É–∂–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      }catch(e){console.error(e);toast('‚úó –û—à–∏–±–∫–∞');}
    };
    videoNoteRecorder.start(250);
    isRecordingVideo=true;
    document.getElementById('videonote-rec-indicator').style.display='block';
    document.getElementById('videonote-btn').textContent='‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
    let sec=0;
    videoNoteTimer=setInterval(()=>{sec++;if(sec>=60){videoNoteRecorder.stop();}},1000);
  }else{
    if(videoNoteRecorder)videoNoteRecorder.stop();
  }
};

// ‚îÄ STICKERS ‚îÄ
const BUILTIN_PACKS=[
  {id:'wave_cute',name:'–ú–∏–ª–∞—à–∫–∏',stickers:['üòä','ü•∞','üòç','ü§©','üòé','ü•≥','üòè','ü§≠','üòá','ü§ó','üòú','üòõ','ü§™','üòã','ü§ì','ü•∏','ü§ë','üò§','üò§','ü´°']},
  {id:'wave_animals',name:'–ó–≤–µ—Ä—è—Ç–∞',stickers:['ü¶ä','üê∫','üêª','üêº','üê®','ü¶Å','üêØ','üêÆ','üê∑','ü¶ã','üêù','ü¶Ñ','üêô','ü¶ñ','ü¶ï','ü¶é','üêä','ü¶Ö','ü¶Ü','ü¶â']},
  {id:'wave_fire',name:'–û–≥–æ–Ω—å',stickers:['üî•','‚ö°','üí•','‚ú®','üåü','üí´','üåä','‚ùÑÔ∏è','üå™Ô∏è','üåà','‚òÑÔ∏è','üåã','üíé','üèÜ','üëë','‚öîÔ∏è','üõ°Ô∏è','üöÄ','üõ∏','üí£']},
  {id:'wave_love',name:'–õ—é–±–æ–≤—å',stickers:['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','‚ù§Ô∏è‚Äçüî•','üíî','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','ü´∂','ü´Ä']},
  {id:'wave_moods',name:'–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è',stickers:['üò¢','üò≠','üò§','üò†','üò°','ü§¨','üòà','üò∞','üò±','üò®','üò∂','ü§ê','üòë','üòí','üòî','üòü','üòï','‚òπÔ∏è','üôÅ','üò£']},
];
let userStickerPacks=[];

function getMyPacks(){
  try{return JSON.parse(localStorage.getItem('wave_sticker_packs_'+(CU?.uid||''))||'[]');}catch{return[];}
}
function saveMyPacks(packs){localStorage.setItem('wave_sticker_packs_'+(CU?.uid||''),JSON.stringify(packs));}
function getAllPacks(){return[...BUILTIN_PACKS,...userStickerPacks];}

function initStickerPicker(){
  userStickerPacks=getMyPacks();
  renderStickerPicker();
}
function renderStickerPicker(){
  const allPacks=getAllPacks();
  const tabs=document.getElementById('sticker-tabs');
  const grid=document.getElementById('sticker-grid');
  tabs.innerHTML='';grid.innerHTML='';
  if(!allPacks.length)return;
  let activePack=allPacks[0];
  function renderTab(pack,active){
    const t=document.createElement('button');
    t.className='sticker-tab'+(active?' active':'');
    t.textContent=pack.stickers[0]||pack.name;t.title=pack.name;
    t.onclick=()=>{activePack=pack;tabs.querySelectorAll('.sticker-tab').forEach(b=>b.classList.remove('active'));t.classList.add('active');renderGrid(pack);};
    tabs.appendChild(t);
  }
  function renderGrid(pack){
    grid.innerHTML='';
    pack.stickers.forEach(s=>{
      const cell=document.createElement('div');cell.className='sticker-cell';
      if(s.startsWith('http')){const img=document.createElement('img');img.src=s;cell.appendChild(img);}
      else cell.textContent=s;
      cell.onclick=()=>sendSticker(s);
      grid.appendChild(cell);
    });
  }
  allPacks.forEach((p,i)=>renderTab(p,i===0));
  renderGrid(activePack);
}

async function sendSticker(sticker){
  if(!currentChatId)return;
  document.getElementById('sticker-picker').classList.remove('open');
  const senderName=CUdata?.name||'?';
  await push(ref(db,`chats/${currentChatId}/messages`),{type:'sticker',sticker,uid:CU.uid,senderName,ts:Date.now()});
  await update(ref(db,`chats/${currentChatId}`),{lastMsgTs:Date.now()});
}

window.toggleStickerPicker=e=>{
  e.stopPropagation();
  const sp=document.getElementById('sticker-picker');
  const ep=document.getElementById('emoji-picker');
  const am=document.getElementById('attach-menu');
  ep.classList.remove('open');am.classList.remove('open');
  sp.classList.toggle('open');
  if(sp.classList.contains('open'))renderStickerPicker();
};

window.openStickerManager=()=>{
  document.getElementById('sticker-picker').classList.remove('open');
  renderMyPacksList();
  renderCommunityPacks();
  document.getElementById('sticker-manager-modal').classList.add('open');
};

function renderMyPacksList(){
  const el=document.getElementById('my-packs-list');el.innerHTML='';
  const packs=getMyPacks();
  if(!packs.length){el.innerHTML='<div style="font-size:.76rem;color:var(--muted);padding:8px;">–ù–µ—Ç —Å–≤–æ–∏—Ö –ø–∞–∫–æ–≤</div>';return;}
  packs.forEach((pack,idx)=>{
    const item=document.createElement('div');item.className='spack-item';
    item.innerHTML=`<div class="spack-thumb">${pack.stickers[0]||'üé≠'}</div><div class="spack-info"><div class="spack-name">${esc(pack.name)}</div><div class="spack-count">${pack.stickers.length} —Å—Ç–∏–∫–µ—Ä–æ–≤</div></div>`;
    const del=document.createElement('button');del.className='spack-remove-btn';del.textContent='–£–¥–∞–ª–∏—Ç—å';
    del.onclick=()=>{
      const my=getMyPacks();my.splice(idx,1);saveMyPacks(my);
      userStickerPacks=my;renderMyPacksList();toast('‚úì –ü–∞–∫ —É–¥–∞–ª—ë–Ω');
    };
    item.appendChild(del);el.appendChild(item);
  });
}

async function renderCommunityPacks(){
  const el=document.getElementById('community-packs-list');el.innerHTML='<div style="font-size:.76rem;color:var(--muted);padding:8px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  try{
    const snap=await get(ref(db,'stickerPacks'));
    el.innerHTML='';
    if(!snap.exists()){el.innerHTML='<div style="font-size:.76rem;color:var(--muted);padding:8px;">–ù–µ—Ç –ø—É–±–ª–∏—á–Ω—ã—Ö –ø–∞–∫–æ–≤</div>';return;}
    snap.forEach(c=>{
      const pack=c.val();const packId=c.key;
      const myPacks=getMyPacks();
      const alreadyHave=myPacks.some(p=>p.id===packId)||BUILTIN_PACKS.some(p=>p.id===packId);
      const item=document.createElement('div');item.className='spack-item';
      const stickers=pack.stickers||[];
      item.innerHTML=`<div class="spack-thumb">${stickers[0]||'üé≠'}</div><div class="spack-info"><div class="spack-name">${esc(pack.name)}</div><div class="spack-count">${stickers.length} —Å—Ç–∏–∫–µ—Ä–æ–≤ ¬∑ @${esc(pack.creator||'')}</div></div>`;
      if(!alreadyHave){
        const add=document.createElement('button');add.className='spack-add-btn';add.textContent='+–î–æ–±–∞–≤–∏—Ç—å';
        add.onclick=()=>{const my=getMyPacks();my.push({id:packId,name:pack.name,stickers});saveMyPacks(my);userStickerPacks=my;add.textContent='‚úì';add.disabled=true;toast('‚úì –ü–∞–∫ –¥–æ–±–∞–≤–ª–µ–Ω');};
        item.appendChild(add);
      }else{
        const added=document.createElement('span');added.style='font-size:.72rem;color:var(--muted);';added.textContent='‚úì –î–æ–±–∞–≤–ª–µ–Ω';item.appendChild(added);
      }
      el.appendChild(item);
    });
  }catch(e){el.innerHTML='<div style="font-size:.76rem;color:var(--danger);padding:8px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';}
}

window.createStickerPack=async()=>{
  const name=document.getElementById('new-pack-name').value.trim();
  const emojisRaw=document.getElementById('new-pack-emojis').value.trim();
  setErr('pack-create-err','');
  if(!name){setErr('pack-create-err','‚úó –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}
  if(!emojisRaw){setErr('pack-create-err','‚úó –î–æ–±–∞–≤—å—Ç–µ —Å—Ç–∏–∫–µ—Ä—ã');return;}
  // Parse: split by comma or space, filter non-empty
  const stickers=[...new Set(emojisRaw.split(/[,\s]+/).map(s=>s.trim()).filter(s=>s.length>0))].slice(0,30);
  if(!stickers.length){setErr('pack-create-err','‚úó –ù–µ—Ç —Å—Ç–∏–∫–µ—Ä–æ–≤');return;}
  const packId='pack_'+CU.uid+'_'+Date.now();
  const packData={id:packId,name,stickers,creator:CUdata?.nick||CUdata?.name||'?',createdAt:Date.now(),creatorUid:CU.uid};
  // Save to community packs in DB
  await set(ref(db,`stickerPacks/${packId}`),packData);
  // Add to local
  const my=getMyPacks();my.push({id:packId,name,stickers});saveMyPacks(my);userStickerPacks=my;
  document.getElementById('new-pack-name').value='';document.getElementById('new-pack-emojis').value='';
  renderMyPacksList();renderCommunityPacks();
  toast('‚úì –ü–∞–∫ —Å–æ–∑–¥–∞–Ω –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!');
};

// ‚îÄ EMOJI PICKER ‚îÄ
function initEmojiPicker(){
  const tabsEl=document.getElementById('emoji-cat-tabs');tabsEl.innerHTML='';
  Object.keys(EMOJI_CATS).forEach((cat,i)=>{
    const btn=document.createElement('button');btn.className='emoji-cat-tab'+(i===0?' active':'');
    btn.textContent=cat;btn.title=cat;
    btn.onclick=()=>{currentEmojiCat=cat;tabsEl.querySelectorAll('.emoji-cat-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderEmojiGrid(EMOJI_CATS[cat]);document.getElementById('emoji-search').value='';};
    tabsEl.appendChild(btn);
  });
  renderEmojiGrid(EMOJI_CATS[currentEmojiCat]);
}
function renderEmojiGrid(emojis){
  const grid=document.getElementById('emoji-grid');grid.innerHTML='';
  emojis.forEach(e=>{const btn=document.createElement('button');btn.className='emoji-cell';btn.textContent=e;btn.onclick=()=>insertEmojiChar(e);grid.appendChild(btn);});
}
window.filterEmojis=val=>{if(!val){renderEmojiGrid(EMOJI_CATS[currentEmojiCat]);return;}renderEmojiGrid([].concat(...Object.values(EMOJI_CATS)));};
function insertEmojiChar(e){const inp=document.getElementById('msg-input');const pos=inp.selectionStart;inp.value=inp.value.slice(0,pos)+e+inp.value.slice(inp.selectionEnd);inp.focus();inp.selectionStart=inp.selectionEnd=pos+e.length;autoResize(inp);}
window.toggleEmojiPicker=e=>{e.stopPropagation();const p=document.getElementById('emoji-picker');p.classList.toggle('open');if(p.classList.contains('open'))document.getElementById('emoji-search').focus();};
document.addEventListener('click',e=>{const p=document.getElementById('emoji-picker');if(p&&p.classList.contains('open')&&!p.contains(e.target)&&!e.target.closest('.emoji-btn'))p.classList.remove('open');});

// ‚îÄ NEW CHAT ‚îÄ
window.openNewChatModal=()=>{
  document.getElementById('new-chat-modal').classList.add('open');
  document.getElementById('new-chat-input').value='';
  document.getElementById('group-desc-input').value='';
  document.getElementById('group-desc-wrap').style.display='none';
  setErr('new-chat-err','');document.getElementById('is-group').checked=false;
};
window.closeModal=id=>document.getElementById(id).classList.remove('open');
document.getElementById('is-group').addEventListener('change',e=>{document.getElementById('group-desc-wrap').style.display=e.target.checked?'block':'none';});
window.createChat=async()=>{
  const val=document.getElementById('new-chat-input').value.trim().replace(/^@/,'');
  const isGroup=document.getElementById('is-group').checked;
  const groupDesc=document.getElementById('group-desc-input').value.trim();
  setErr('new-chat-err','');if(!val){setErr('new-chat-err','‚úó –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');return;}
  if(isGroup){
    const r=push(ref(db,'chats'));
    await set(r,{type:'group',name:val,description:groupDesc,members:{[CU.uid]:true},admins:{[CU.uid]:true},avatar:{color:COLORS[Math.floor(Math.random()*COLORS.length)],emoji:'üë•'},createdBy:CU.uid,createdAt:Date.now()});
    await set(ref(db,`userChats/${CU.uid}/${r.key}`),true);
    closeModal('new-chat-modal');
  }else{
    const u=await findUser(val);
    if(!u){setErr('new-chat-err','‚úó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');return;}
    if(u.uid===CU.uid){setErr('new-chat-err','‚úó –ù–µ–ª—å–∑—è —á–∞—Ç —Å —Å–æ–±–æ–π');return;}
    const ex=Object.entries(chatsData).find(([,c])=>c.type==='direct'&&c.members?.[CU.uid]&&c.members?.[u.uid]);
    if(ex){closeModal('new-chat-modal');openChat(ex[0],ex[1]);return;}
    const r=push(ref(db,'chats'));
    await set(r,{type:'direct',members:{[CU.uid]:true,[u.uid]:true},names:{[CU.uid]:CUdata?.name||CU.displayName,[u.uid]:u.name},avatars:{[CU.uid]:CUdata?.avatar||null,[u.uid]:u.avatar||null},createdAt:Date.now()});
    await set(ref(db,`userChats/${CU.uid}/${r.key}`),true);
    await set(ref(db,`userChats/${u.uid}/${r.key}`),true);
    closeModal('new-chat-modal');
  }
};
async function findUser(q){
  const snap=await get(ref(db,'users'));if(!snap.exists())return null;
  let found=null;
  snap.forEach(c=>{const u=c.val();if(u.email===q||u.nickLower===q.toLowerCase()||u.nick===q)found=u;});
  return found;
}

// ‚îÄ GROUP PANEL ‚îÄ
window.toggleGroupPanel=()=>{
  const panel=document.getElementById('group-panel');
  const chat=chatsData[currentChatId];
  if(!chat||chat.type!=='group')return;
  groupPanelOpen=!groupPanelOpen;
  panel.classList.toggle('open',groupPanelOpen);
  if(groupPanelOpen)populateGroupPanel();
};

async function populateGroupPanel(){
  const chat=chatsData[currentChatId];if(!chat)return;
  const name=chatName(chat);
  const amAdmin=isAdmin(chat,CU.uid);
  // Cover
  const cover=document.getElementById('gp-cover');
  cover.innerHTML='<div class="gp-cover-overlay"><span class="gp-cover-overlay-text">üì∑ –û–±–ª–æ–∂–∫–∞</span></div>';
  if(chat.cover){const img=document.createElement('img');img.src=chat.cover;cover.insertBefore(img,cover.firstChild);}
  else cover.style.background='linear-gradient(135deg,var(--accent),#9333ea)';
  if(!amAdmin)cover.style.pointerEvents='none';else cover.style.pointerEvents='';
  // Avatar
  const gpAv=document.getElementById('gp-avatar');
  const av=chat.avatar||{color:'#7c3aed',emoji:'üë•'};
  gpAv.style.background=av.color||'#7c3aed';
  gpAv.style.color='#fff';gpAv.style.fontSize='1.5rem';
  const gpPhotoSrc=av.photoUrl||av.photoData;
  if(gpPhotoSrc){gpAv.textContent='';gpAv.style.background='transparent';let img=gpAv.querySelector('img');if(!img){img=document.createElement('img');img.style='width:100%;height:100%;object-fit:cover;border-radius:50%;';gpAv.appendChild(img);}img.src=gpPhotoSrc;}
  else{const img=gpAv.querySelector('img');if(img)img.remove();gpAv.textContent=av.emoji||'üë•';}
  if(!amAdmin)gpAv.style.pointerEvents='none';else gpAv.style.pointerEvents='';
  // Meta
  document.getElementById('gp-panel-name').textContent=name;
  document.getElementById('gp-panel-count').textContent=`${Object.keys(chat.members||{}).length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
  document.getElementById('gp-panel-desc').textContent=chat.description||'';
  // Admin actions visibility
  document.getElementById('gp-add-member-row').style.display=amAdmin?'flex':'none';
  // Leave/Delete button
  document.getElementById('gp-leave-label').textContent=amAdmin&&chat.createdBy===CU.uid?'–£–¥–∞–ª–∏—Ç—å':'–ü–æ–∫–∏–Ω—É—Ç—å';
  // Members
  const ml=document.getElementById('gp-members-list');ml.innerHTML='<div style="padding:8px;font-size:.72rem;color:var(--muted);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  const uids=Object.keys(chat.members||{});
  const users=await Promise.all(uids.map(uid=>get(ref(db,`users/${uid}`))));
  ml.innerHTML='';
  users.forEach(snap=>{
    if(!snap.exists())return;
    const u=snap.val();const isAdm=isAdmin(chat,u.uid);
    const item=document.createElement('div');item.className='gp-member-item';
    item.innerHTML=`${avHTML(u.avatar,u.name,34,'round')}<div style="flex:1;min-width:0;"><div class="gp-member-name">${esc(u.name)}</div><div class="gp-member-nick">@${esc(u.nick||u.nickLower||'')}</div></div>${isAdm?'<span class="gp-member-badge">ADMIN</span>':''}`;
    item.onclick=()=>showUserModal(u);
    // Long press / right click for admin actions
    if(amAdmin&&u.uid!==CU.uid){
      item.addEventListener('contextmenu',e=>{e.preventDefault();showMemberCtx(e,u,isAdm,chat);});
    }
    ml.appendChild(item);
  });
}

let memberCtxUser=null,memberCtxIsAdm=false;
function showMemberCtx(e,u,isAdm,chat){
  memberCtxUser=u;memberCtxIsAdm=isAdm;
  // Reuse ctx-menu as quick action
  const menu=document.getElementById('ctx-menu');
  document.getElementById('ctx-reactions').innerHTML='';
  document.getElementById('ctx-reply').style.display='none';
  document.getElementById('ctx-forward').style.display='none';
  document.getElementById('ctx-save-fav').style.display='none';
  document.getElementById('ctx-copy').style.display='none';
  document.getElementById('ctx-read-by').style.display='none';
  // Repurpose delete as kick
  const del=document.getElementById('ctx-delete');
  del.style.display='flex';del.querySelector('.ctx-item-icon').textContent='üö™';
  del.childNodes[del.childNodes.length-1].textContent=isAdm?'–°–Ω—è—Ç—å –ø—Ä–∞–≤–∞':'–£–¥–∞–ª–∏—Ç—å –∏–∑ –≥—Ä—É–ø–ø—ã';
  del.onclick=async()=>{
    if(isAdm){await remove(ref(db,`chats/${currentChatId}/admins/${u.uid}`));}
    else{
      if(!confirm('–£–¥–∞–ª–∏—Ç—å '+u.name+' –∏–∑ –≥—Ä—É–ø–ø—ã?'))return;
      await remove(ref(db,`chats/${currentChatId}/members/${u.uid}`));
      await remove(ref(db,`userChats/${u.uid}/${currentChatId}`));
    }
    const updated=await get(ref(db,`chats/${currentChatId}`));if(updated.exists())chatsData[currentChatId]=updated.val();
    populateGroupPanel();menu.classList.remove('show');
    // Restore ctx-menu items
    restoreCtxMenu();toast('‚úì –ì–æ—Ç–æ–≤–æ');
  };
  menu.classList.add('show');
  const vw=window.innerWidth,vh=window.innerHeight;
  let x=e.clientX,y=e.clientY;
  const mw=menu.offsetWidth,mh=menu.offsetHeight;
  if(x+mw>vw-10)x=vw-mw-10;if(y+mh>vh-10)y=vh-mh-10;
  menu.style.left=x+'px';menu.style.top=y+'px';
}
function restoreCtxMenu(){
  ['ctx-reply','ctx-forward','ctx-save-fav','ctx-copy'].forEach(id=>document.getElementById(id).style.display='');
  const del=document.getElementById('ctx-delete');
  del.querySelector('.ctx-item-icon').textContent='üóë';
  del.childNodes[del.childNodes.length-1].textContent='–£–¥–∞–ª–∏—Ç—å';
}

window.openGpEditName=()=>{
  const chat=chatsData[currentChatId];if(!chat||!isAdmin(chat,CU.uid))return;
  document.getElementById('gp-edit-name-input').value=chatName(chat);
  document.getElementById('gp-edit-desc-input').value=chat.description||'';
  const sec=document.getElementById('gp-edit-section');
  sec.style.display=sec.style.display==='none'?'block':'none';
};
window.saveGroupFromPanel=async()=>{
  const newName=document.getElementById('gp-edit-name-input').value.trim();
  const newDesc=document.getElementById('gp-edit-desc-input').value.trim();
  if(!newName){toast('‚úó –ù–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ');return;}
  await update(ref(db,`chats/${currentChatId}`),{name:newName,description:newDesc});
  chatsData[currentChatId].name=newName;chatsData[currentChatId].description=newDesc;
  document.getElementById('topbar-name').textContent=newName;
  document.getElementById('gp-panel-name').textContent=newName;
  document.getElementById('gp-panel-desc').textContent=newDesc;
  document.getElementById('gp-edit-section').style.display='none';
  renderChatList(chatsData);toast('‚úì –ì—Ä—É–ø–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
};

window.openGroupCoverPicker=()=>{
  const chat=chatsData[currentChatId];if(!isAdmin(chat,CU.uid))return;
  const inp=document.createElement('input');inp.type='file';inp.accept='image/*';
  inp.onchange=async e=>{
    const file=e.target.files[0];if(!file)return;
    if(file.size>5*1024*1024){toast('‚úó –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π');return;}
    const reader=new FileReader();
    reader.onload=async ev=>{
      await update(ref(db,`chats/${currentChatId}`),{cover:ev.target.result});
      chatsData[currentChatId].cover=ev.target.result;
      populateGroupPanel();toast('‚úì –û–±–ª–æ–∂–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
    };
    reader.readAsDataURL(file);
  };
  inp.click();
};

window.openGroupAvatarPickerFromPanel=()=>{
  const chat=chatsData[currentChatId];if(!isAdmin(chat,CU.uid)){toast('‚úó –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã');return;}
  groupAvatarPendingData=null;
  document.getElementById('group-photo-text').textContent='üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ';
  document.getElementById('group-avatar-file').value='';
  gravPickerColor=COLORS[0];gravPickerEmoji=EMOJIS[0];
  const cg=document.getElementById('grav-color-grid');cg.innerHTML='';
  COLORS.forEach(c=>{const d=document.createElement('div');d.className='av-color'+(c===gravPickerColor?' sel':'');d.style.background=c;d.onclick=()=>{gravPickerColor=c;cg.querySelectorAll('.av-color').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');};cg.appendChild(d);});
  const eg=document.getElementById('grav-emoji-grid');eg.innerHTML='';
  EMOJIS.forEach(e=>{const d=document.createElement('div');d.className='av-emoji'+(e===gravPickerEmoji?' sel':'');d.textContent=e;d.onclick=()=>{gravPickerEmoji=e;eg.querySelectorAll('.av-emoji').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');};eg.appendChild(d);});
  document.getElementById('group-avatar-modal').classList.add('open');
};
window.handleGroupAvatarFile=e=>{
  const file=e.target.files[0];if(!file)return;
  if(file.size>5*1024*1024){toast('‚úó –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π');return;}
  cropTarget='group';openCropModal(file);
};
window.saveGroupAvatar=async()=>{
  if(!currentChatId)return;
  let av;
  if(groupAvatarPendingData){
    try{
      toast('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...');
      const res=await fetch(groupAvatarPendingData);const blob=await res.blob();
      const storRef=sref(storage,`avatars/groups/${currentChatId}_${Date.now()}.jpg`);
      await uploadBytes(storRef,blob,{contentType:'image/jpeg'});
      const url=await getDownloadURL(storRef);
      av={photoUrl:url};
    }catch(e){av={photoData:groupAvatarPendingData};}
  }else{av={color:gravPickerColor,emoji:gravPickerEmoji};}
  await update(ref(db,`chats/${currentChatId}`),{avatar:av});
  chatsData[currentChatId].avatar=av;
  renderAvInEl(document.getElementById('topbar-av'),av,chatName(chatsData[currentChatId]),40);
  renderChatList(chatsData);populateGroupPanel();
  closeModal('group-avatar-modal');toast('‚úì –ê–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
};

window.leaveOrDeleteGroup=async()=>{
  const chat=chatsData[currentChatId];if(!chat)return;
  const isOwner=chat.createdBy===CU.uid;
  if(isOwner){document.getElementById('delete-group-modal').classList.add('open');}
  else{
    if(!confirm('–ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É?'))return;
    await remove(ref(db,`chats/${currentChatId}/members/${CU.uid}`));
    await remove(ref(db,`userChats/${CU.uid}/${currentChatId}`));
    document.getElementById('group-panel').classList.remove('open');groupPanelOpen=false;
    showEmpty();toast('‚úì –í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥—Ä—É–ø–ø—É');
  }
};
window.confirmDeleteGroup=async()=>{
  if(!currentChatId)return;
  const chat=chatsData[currentChatId];
  // Remove from all members
  const uids=Object.keys(chat?.members||{});
  await Promise.all(uids.map(uid=>remove(ref(db,`userChats/${uid}/${currentChatId}`))));
  await remove(ref(db,`chats/${currentChatId}`));
  closeModal('delete-group-modal');
  document.getElementById('group-panel').classList.remove('open');groupPanelOpen=false;
  delete chatsData[currentChatId];currentChatId=null;
  renderChatList(chatsData);showEmpty();toast('‚úì –ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞');
};

window.addMemberFromPanel=async()=>{
  const val=document.getElementById('gp-add-input').value.trim().replace(/^@/,'');
  if(!val)return;
  const u=await findUser(val);
  if(!u){toast('‚úó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');return;}
  if(chatsData[currentChatId]?.members?.[u.uid]){toast('‚úó –£–∂–µ –≤ –≥—Ä—É–ø–ø–µ');return;}
  await update(ref(db,`chats/${currentChatId}/members`),{[u.uid]:true});
  await set(ref(db,`userChats/${u.uid}/${currentChatId}`),true);
  document.getElementById('gp-add-input').value='';
  const updated=await get(ref(db,`chats/${currentChatId}`));if(updated.exists())chatsData[currentChatId]=updated.val();
  populateGroupPanel();toast('‚úì '+u.name+' –¥–æ–±–∞–≤–ª–µ–Ω');
};

// ‚îÄ MY PROFILE ‚îÄ
window.openMyProfile=()=>{
  if(!CUdata)return;
  document.getElementById('my-profile-name').textContent=CUdata.name||'?';
  document.getElementById('my-profile-nick').textContent='@'+(CUdata.nick||'–Ω–µ—Ç username');
  document.getElementById('my-profile-name-input').value=CUdata.name||'';
  document.getElementById('my-profile-nick-input').value=CUdata.nick||'';
  document.getElementById('my-profile-bio-input').value=CUdata.bio||'';
  setErr('profile-save-err','');
  renderAvInEl(document.getElementById('my-profile-av'),CUdata.avatar,CUdata.name,68);
  const nick=CUdata.nick||'';
  document.getElementById('my-invite-link').textContent=nick?location.origin+location.pathname+'?adduser='+nick:'(–Ω–µ—Ç @username)';
  // Photos
  myExtraPhotos=getMyPhotos();
  renderPhotoGallery('my-photos-scroll','my-photo-dots',myExtraPhotos);
  document.getElementById('my-profile-modal').classList.add('open');
};
window.copyMyLink=()=>{const t=document.getElementById('my-invite-link').textContent;if(t.startsWith('http'))navigator.clipboard.writeText(t).then(()=>toast('‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'));};
window.saveProfile=async()=>{
  const newName=document.getElementById('my-profile-name-input').value.trim();
  const newNick=document.getElementById('my-profile-nick-input').value.trim().replace(/^@/,'');
  const newBio=document.getElementById('my-profile-bio-input').value.trim();
  setErr('profile-save-err','');
  if(!newName){setErr('profile-save-err','‚úó –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');return;}
  if(newNick&&newNick.length<3){setErr('profile-save-err','‚úó Username –º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞');return;}
  if(newNick&&!/^[a-zA-Z0-9_–∞-—è–ê-–Ø—ë–Å]+$/.test(newNick)){setErr('profile-save-err','‚úó –ë—É–∫–≤—ã (–≤–∫–ª—é—á–∞—è —Ä—É—Å.), —Ü–∏—Ñ—Ä—ã –∏ _');return;}
  if(newNick&&newNick.toLowerCase()!==(CUdata.nick||'').toLowerCase()){
    const ns=await get(query(ref(db,'users'),orderByChild('nickLower'),equalTo(newNick.toLowerCase())));
    if(ns.exists()){setErr('profile-save-err','‚úó @'+newNick+' —É–∂–µ –∑–∞–Ω—è—Ç');return;}
    if(CUdata.nick)await remove(ref(db,`nickIndex/${CUdata.nick.toLowerCase()}`));
    await set(ref(db,`nickIndex/${newNick.toLowerCase()}`),CU.uid);
  }
  await updateProfile(CU,{displayName:newName});
  const updates={name:newName,bio:newBio};
  if(newNick){updates.nick=newNick;updates.nickLower=newNick.toLowerCase();}
  await update(ref(db,`users/${CU.uid}`),updates);Object.assign(CUdata,updates);
  document.getElementById('my-profile-name').textContent=newName;
  document.getElementById('my-profile-nick').textContent='@'+(newNick||CUdata.nick||'–Ω–µ—Ç username');
  const nickFinal=newNick||CUdata.nick||'';
  document.getElementById('my-invite-link').textContent=nickFinal?location.origin+location.pathname+'?adduser='+nickFinal:'(–Ω–µ—Ç @username)';
  updateMyAvBtn();toast('‚úì –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
};
window.sendPasswordReset=async()=>{
  if(!CU?.email){toast('‚úó Email –Ω–µ –Ω–∞–π–¥–µ–Ω');return;}
  try{await sendPasswordResetEmail(auth,CU.email);toast('‚úì –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');}
  catch(e){toast('‚úó '+xlate(e.code));}
};

// ‚îÄ PHOTO GALLERY ‚îÄ
function renderPhotoGallery(scrollId,dotsId,photos){
  const scroll=document.getElementById(scrollId);
  const dotsEl=document.getElementById(dotsId);
  scroll.innerHTML='';dotsEl.innerHTML='';
  if(!photos||!photos.length){
    // Show empty placeholder
    const slide=document.createElement('div');slide.className='profile-photo-slide empty';
    slide.innerHTML='<div style="color:var(--muted);font-size:.8rem;font-family:\'Space Mono\',monospace;">–Ω–µ—Ç —Ñ–æ—Ç–æ</div>';
    scroll.appendChild(slide);return;
  }
  photos.forEach((src,i)=>{
    const slide=document.createElement('div');slide.className='profile-photo-slide';
    const img=document.createElement('img');img.src=src;slide.appendChild(img);
    // Remove button
    if(scrollId==='my-photos-scroll'){
      const del=document.createElement('button');
      del.style='position:absolute;top:6px;right:6px;background:rgba(0,0,0,.5);border:none;border-radius:50%;width:24px;height:24px;color:#fff;font-size:.75rem;cursor:pointer;display:flex;align-items:center;justify-content:center;';
      del.textContent='‚úï';del.onclick=e=>{e.stopPropagation();removeMyPhoto(i);};slide.appendChild(del);
    }
    const dot=document.createElement('div');dot.className='profile-photo-dot'+(i===0?' active':'');dotsEl.appendChild(dot);
    scroll.appendChild(slide);
  });
  // Scroll dots sync
  scroll.addEventListener('scroll',()=>{
    const idx=Math.round(scroll.scrollLeft/scroll.clientWidth);
    dotsEl.querySelectorAll('.profile-photo-dot').forEach((d,i)=>d.classList.toggle('active',i===idx));
  });
}

window.addMyPhoto=()=>document.getElementById('my-extra-photo-input').click();
window.handleMyExtraPhoto=e=>{
  const file=e.target.files[0];if(!file)return;
  if(file.size>5*1024*1024){toast('‚úó –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π');return;}
  const reader=new FileReader();
  reader.onload=ev=>{
    myExtraPhotos=getMyPhotos();
    if(myExtraPhotos.length>=6){toast('‚úó –ú–∞–∫—Å–∏–º—É–º 6 —Ñ–æ—Ç–æ');return;}
    myExtraPhotos.push(ev.target.result);
    saveMyPhotos(myExtraPhotos);
    renderPhotoGallery('my-photos-scroll','my-photo-dots',myExtraPhotos);
    toast('‚úì –§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
  };
  reader.readAsDataURL(file);
  e.target.value='';
};
function removeMyPhoto(idx){
  myExtraPhotos=getMyPhotos();myExtraPhotos.splice(idx,1);
  saveMyPhotos(myExtraPhotos);
  renderPhotoGallery('my-photos-scroll','my-photo-dots',myExtraPhotos);
  toast('‚úì –§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ');
}

// ‚îÄ AVATAR PICKER ‚îÄ
window.openAvatarPicker=()=>{
  avatarPendingData=null;
  document.getElementById('avatar-upload-text').textContent='üì∑ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏';
  document.getElementById('avatar-file-input').value='';
  const cg=document.getElementById('av-color-grid');cg.innerHTML='';
  COLORS.forEach(c=>{const d=document.createElement('div');d.className='av-color'+(c===pickerColor?' sel':'');d.style.background=c;d.onclick=()=>{pickerColor=c;cg.querySelectorAll('.av-color').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');avatarPendingData=null;};cg.appendChild(d);});
  const eg=document.getElementById('av-emoji-grid');eg.innerHTML='';
  EMOJIS.forEach(e=>{const d=document.createElement('div');d.className='av-emoji'+(e===pickerEmoji?' sel':'');d.textContent=e;d.onclick=()=>{pickerEmoji=e;eg.querySelectorAll('.av-emoji').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');avatarPendingData=null;};eg.appendChild(d);});
  document.getElementById('avatar-modal').classList.add('open');
};
window.handleAvatarFile=e=>{
  const file=e.target.files[0];if(!file)return;
  if(file.size>5*1024*1024){toast('‚úó –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π');return;}
  cropTarget='user';openCropModal(file);
};
window.saveAvatar=async()=>{
  let av;
  if(avatarPendingData){
    try{
      toast('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞...');
      // Convert base64 to blob
      const res=await fetch(avatarPendingData);const blob=await res.blob();
      const storePath=`avatars/${CU.uid}/avatar_${Date.now()}.jpg`;
      const storRef=sref(storage,storePath);
      await uploadBytes(storRef,blob,{contentType:'image/jpeg'});
      const url=await getDownloadURL(storRef);
      av={photoUrl:url};
    }catch(e){
      console.error('Avatar upload error:',e);
      // Fallback to base64 if storage fails
      av={photoData:avatarPendingData};
    }
  }else{av={color:pickerColor,emoji:pickerEmoji};}
  await update(ref(db,`users/${CU.uid}`),{avatar:av});
  CUdata.avatar=av;updateMyAvBtn();
  renderAvInEl(document.getElementById('my-profile-av'),av,CUdata.name,68);
  closeModal('avatar-modal');toast('‚úì –ê–≤–∞—Ç–∞—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
};

// ‚îÄ CROP ‚îÄ
function openCropModal(file){
  const url=URL.createObjectURL(file);cropRawData=url;
  const img=document.getElementById('crop-img');
  img.onload=()=>{
    cropImgW=img.naturalWidth;cropImgH=img.naturalHeight;
    cropScale=0.6;
    document.getElementById('crop-scale').value=0.6;
    const cont=document.getElementById('crop-container');
    cropContW=cont.clientWidth;cropContH=cont.clientHeight;
    cropBoxSize=Math.min(cropContH,cropContW)*0.5;
    applyImgTransform();
    cropBoxX=(cropContW-cropBoxSize)/2;cropBoxY=(cropContH-cropBoxSize)/2;
    updateCropBox();
  };
  img.src=url;
  document.getElementById('crop-modal').classList.add('open');
}
function applyImgTransform(){
  const img=document.getElementById('crop-img');
  const cont=document.getElementById('crop-container');
  cropContW=cont.clientWidth;cropContH=cont.clientHeight;
  const w=cropImgW*cropScale,h=cropImgH*cropScale;
  img.style.width=w+'px';img.style.height=h+'px';
  img.style.left=((cropContW-w)/2)+'px';img.style.top=((cropContH-h)/2)+'px';
}
function updateCropBox(){
  const box=document.getElementById('crop-box');
  box.style.left=cropBoxX+'px';box.style.top=cropBoxY+'px';
  box.style.width=cropBoxSize+'px';box.style.height=cropBoxSize+'px';
}
window.updateCropScale=v=>{cropScale=parseFloat(v);applyImgTransform();};

const cropBox=document.getElementById('crop-box');
cropBox.addEventListener('mousedown',e=>{cropDragging=true;cropDragOffX=e.clientX-cropBoxX;cropDragOffY=e.clientY-cropBoxY;e.preventDefault();});
document.addEventListener('mousemove',e=>{if(!cropDragging)return;cropBoxX=Math.max(0,Math.min(cropContW-cropBoxSize,e.clientX-cropDragOffX));cropBoxY=Math.max(0,Math.min(cropContH-cropBoxSize,e.clientY-cropDragOffY));updateCropBox();});
document.addEventListener('mouseup',()=>cropDragging=false);
cropBox.addEventListener('touchstart',e=>{const t=e.touches[0];cropDragging=true;cropDragOffX=t.clientX-cropBoxX;cropDragOffY=t.clientY-cropBoxY;e.preventDefault();},{passive:false});
document.addEventListener('touchmove',e=>{if(!cropDragging)return;const t=e.touches[0];cropBoxX=Math.max(0,Math.min(cropContW-cropBoxSize,t.clientX-cropDragOffX));cropBoxY=Math.max(0,Math.min(cropContH-cropBoxSize,t.clientY-cropDragOffY));updateCropBox();},{passive:false});
document.addEventListener('touchend',()=>cropDragging=false);

window.applyCrop=()=>{
  const canvas=document.createElement('canvas');const size=256;canvas.width=size;canvas.height=size;
  const ctx=canvas.getContext('2d');
  ctx.beginPath();ctx.arc(size/2,size/2,size/2,0,Math.PI*2);ctx.clip();
  const img=document.getElementById('crop-img');const cont=document.getElementById('crop-container');
  const cRect=cont.getBoundingClientRect();const iRect=img.getBoundingClientRect();
  const sx=(cropBoxX-(iRect.left-cRect.left))*(cropImgW/iRect.width);
  const sy=(cropBoxY-(iRect.top-cRect.top))*(cropImgH/iRect.height);
  const ss=cropBoxSize*(cropImgW/iRect.width);
  ctx.drawImage(img,sx,sy,ss,ss,0,0,size,size);
  const dataUrl=canvas.toDataURL('image/jpeg',0.85);
  if(cropTarget==='user'){avatarPendingData=dataUrl;document.getElementById('avatar-upload-text').textContent='‚úì –§–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–æ';}
  else{groupAvatarPendingData=dataUrl;document.getElementById('group-photo-text').textContent='‚úì –§–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–æ';}
  closeModal('crop-modal');URL.revokeObjectURL(cropRawData);toast('‚úì –ö–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–æ');
};

// ‚îÄ USER PROFILE MODAL ‚îÄ
function showUserModal(u){
  // Photos from localStorage if current user
  renderAvInEl(document.getElementById('upm-av'),u.avatar,u.name,68);
  document.getElementById('upm-name').textContent=u.name;
  document.getElementById('upm-nick').textContent='@'+(u.nick||u.nickLower||'');
  document.getElementById('upm-bio').textContent=u.bio||'';
  const nick=u.nick||u.nickLower||'';
  const lw=document.getElementById('upm-link-wrap');
  if(nick){lw.style.display='flex';document.getElementById('upm-link').textContent=location.origin+location.pathname+'?adduser='+nick;}
  else lw.style.display='none';
  // Photo gallery ‚Äî we store other user's extra photos in db under users/{uid}/photos
  const uPhotos=u.photos?Object.values(u.photos):[];
  renderPhotoGallery('upm-photos-scroll','upm-photo-dots',uPhotos);
  // Add to group
  const myGroups=Object.entries(chatsData).filter(([,c])=>c.type==='group'&&isAdmin(c,CU.uid)&&!c.members?.[u.uid]);
  const addWrap=document.getElementById('upm-add-to-group-wrap');
  const groupList=document.getElementById('upm-group-list');
  if(myGroups.length>0&&u.uid!==CU.uid){
    addWrap.style.display='block';groupList.innerHTML='';
    myGroups.forEach(([id,c])=>{
      const item=document.createElement('div');item.className='fwd-chat-item';
      item.innerHTML=`${avHTML(chatAv(c),chatName(c),32,'round')}<div><div class="fwd-chat-name">${esc(chatName(c))}</div></div>`;
      item.onclick=async()=>{
        await update(ref(db,`chats/${id}/members`),{[u.uid]:true});
        await set(ref(db,`userChats/${u.uid}/${id}`),true);
        toast('‚úì '+u.name+' –¥–æ–±–∞–≤–ª–µ–Ω –≤ '+chatName(c));closeModal('user-profile-modal');
      };groupList.appendChild(item);
    });
  }else addWrap.style.display='none';
  const btn=document.getElementById('upm-msg-btn');
  btn.onclick=async()=>{
    closeModal('user-profile-modal');
    const ex=Object.entries(chatsData).find(([,c])=>c.type==='direct'&&c.members?.[CU.uid]&&c.members?.[u.uid]);
    if(ex){openChat(ex[0],ex[1]);return;}
    const r=push(ref(db,'chats'));
    const chat={type:'direct',members:{[CU.uid]:true,[u.uid]:true},names:{[CU.uid]:CUdata?.name||CU.displayName,[u.uid]:u.name},avatars:{[CU.uid]:CUdata?.avatar||null,[u.uid]:u.avatar||null},createdAt:Date.now()};
    await set(r,chat);await set(ref(db,`userChats/${CU.uid}/${r.key}`),true);await set(ref(db,`userChats/${u.uid}/${r.key}`),true);
    chatsData[r.key]=chat;openChat(r.key,chat);
  };
  document.getElementById('user-profile-modal').classList.add('open');
}
window.copyUpmLink=()=>{const t=document.getElementById('upm-link').textContent;navigator.clipboard.writeText(t).then(()=>toast('‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'));};
async function openUserById(uid){const snap=await get(ref(db,`users/${uid}`));if(snap.exists())showUserModal(snap.val());}

// ‚îÄ CHAT PROFILE ‚îÄ
window.openChatProfile=async()=>{
  const chat=chatsData[currentChatId];if(!chat)return;
  if(chat.type==='group')toggleGroupPanel();
  else if(chat.type==='direct'){const o=Object.entries(chat.members||{}).find(([uid])=>uid!==CU.uid);if(o)await openUserById(o[0]);}
};

// ‚îÄ SHARE INVITE ‚îÄ
window.shareInvite=()=>{
  const chat=chatsData[currentChatId];if(!chat)return;
  if(chat.type==='favorites'){toast('‚úó –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –Ω–µ–ª—å–∑—è –¥–µ–ª–∏—Ç—å—Å—è');return;}
  const link=chat.type==='group'?location.origin+location.pathname+'?joingroup='+currentChatId:location.origin+location.pathname+'?adduser='+(CUdata?.nick||'');
  navigator.clipboard.writeText(link).then(()=>toast('‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!')).catch(()=>prompt('–°—Å—ã–ª–∫–∞:',link));
};

// ‚îÄ INVITE PARAMS ‚îÄ
async function checkInviteParam(){
  const p=new URLSearchParams(location.search);
  const adduser=p.get('adduser'),joingroup=p.get('joingroup');
  if(adduser){history.replaceState({},'',location.pathname);const u=await findUser(adduser);if(u)showUserModal(u);else toast('‚úó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');}
  if(joingroup){
    history.replaceState({},'',location.pathname);
    const snap=await get(ref(db,`chats/${joingroup}`));
    if(snap.exists()&&snap.val().type==='group'){
      await update(ref(db,`chats/${joingroup}/members`),{[CU.uid]:true});
      await set(ref(db,`userChats/${CU.uid}/${joingroup}`),true);
      toast('‚úì –í—Å—Ç—É–ø–∏–ª–∏ –≤ –≥—Ä—É–ø–ø—É: '+snap.val().name);
    }else toast('‚úó –ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
  }
}

function showEmpty(){document.getElementById('empty-placeholder').style.display='flex';document.getElementById('active-chat').style.display='none';}

function xlate(code){
  const m={'auth/email-already-in-use':'Email –∑–∞–Ω—è—Ç','auth/invalid-email':'–ù–µ–≤–µ—Ä–Ω—ã–π email','auth/weak-password':'–°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å','auth/user-not-found':'–ù–µ –Ω–∞–π–¥–µ–Ω','auth/wrong-password':'–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å','auth/invalid-credential':'–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å','auth/too-many-requests':'–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫','auth/network-request-failed':'–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞'};
  return m[code]||('–û—à–∏–±–∫–∞: '+code);
}

document.querySelectorAll('.modal-overlay').forEach(el=>el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open');}));
document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
document.getElementById('reg-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doRegister();});
document.getElementById('login-id').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('login-pass').focus();});
document.getElementById('new-chat-input').addEventListener('keydown',e=>{if(e.key==='Enter')createChat();});
document.getElementById('user-search-input').addEventListener('keydown',e=>{if(e.key==='Escape')switchTab('chats');});
</script>
</body>
</html>
